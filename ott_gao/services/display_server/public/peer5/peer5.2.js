!function(){function z(c,b){return 0<=c&&1024>c?c+" B":1024<=c&&1048576>c?(c/1024).toFixed(b)+" KB":1048576<=c&&1073741824>c?(c/1048576).toFixed(b)+" MB":1073741824<=c&&1099511627776>c?(c/1073741824).toFixed(b)+" GB":1099511627776<=c?(c/1099511627776).toFixed(b)+" TB":c+" B"}function D(){var c=[],b=0;this.getLength=function(){return c.length-b};this.isEmpty=function(){return 0==c.length};this.enqueue=function(a){c.push(a)};this.dequeue=function(){if(0!=c.length){var a=c[b];return 2*++b>=c.length&&
(c=c.slice(b),b=0),a}};this.peek=function(){return 0<c.length?c[b]:void 0}}var d=d||{};d.core={apis:{},apiValidators:{},dataStructures:{},data:{},controllers:{},protocol:{},transport:{},util:{},stats:{},workers:{},playlist:{}};d.tracker={lib:{analytics:{},matching:{},util:{}}};d.client||(d.client={});d.client.downloader={};d.client.apiValidators={};d.client.videoAnalytics={};(function(c){c.randomKFromN=function(b,a){var e=[];if(b>a){for(var c=0;a>=c;c++)e.push(c);return e}for(;e.length<b;){for(var d=
Math.ceil(Math.random()*(a+1))-1,h=!1,c=0;c<e.length;c++)if(e[c]==d){h=!0;break}h||e.push(d)}return e};c.randSample=function(b,a){if(0==b.length)return b;var e=c.randomKFromN(a,b.length-1);return c.sampleIndexes(b,e)};c.sampleIndexes=function(b,a){sampledArr=[];for(var e=0;e<a.length;e++)sampledArr.push(b[a[e]]);return sampledArr};c.shuffle=function(b){var a,e,c=b.length;if(c)for(;--c;)e=Math.floor(Math.random()*(c+1)),a=b[e],b[e]=b[c],b[c]=a;return b};c.randomOffset=function(b,a,e){a=(a-b)/e;for(var c=
[],d=0;a>=d;d++)for(var h=0;d>=h;h++)c.push(d);return c[Math.floor(Math.random()*c.length)]*e+b}})(d.core.util);d.config={VERSION:"1.1",CHUNKY_HEAD_LENGTH:1E5,SMALL_FILE_SIZE:10485760,REMOVE_QUERYSTRING_FOR_HASH:!0,REMOVE_WOWZA_SESSION_ID_FOR_HASH:!0,REMOVE_SUBDOMAIN_FOR_HASH:!1,REPLACE_IP_TOKEN_FOR_HASH:!1,REPLACE_HOSTNAME_WITH_TOKEN_FOR_HASH:!1,DISABLE_CHROME:!1,DISABLE_FIREFOX:!1,HTTP_ONLY:!1,STUN_SERVERS:["stun.l.google.com:19302"],TURN_SERVERS:[],TURN_CREDENTIALS:[],MAX_CONNECTIONS:15,SECONDS_BEFORE_IDLE:120,
SECONDS_SINCE_LAST_HAVE:60,PC_FAIL_TIMEOUT:15E3,PC_RECON_METHOD:"exponential",PC_RECON_EXP_COEF:2,PC_RECON_DELAY:1E4,PC_RESEND_INTERVAL:1E3,REQUEST_DROPPED_FAIL:20,EMULATE_LOSS:!1,EMULATE_LOSS_PERCENTAGE:.2,CHUNK_SIZE:16E3,BLOCK_SIZE:12E5,MAX_PENDING_CHUNKS:100,MOZ_MAX_PENDING_CHUNKS:100,CHUNK_EXPIRATION_TIMEOUT:3E3,P2P_SEND_RETRIES:3,PC_POOL_SIZE:100,PC_POOL_INIT_INTERVAL:100,PC_POOL_LOW:10,PC_POOL_REGEN_INTERVAL:5E3,MAX_PC_CREATE:1E5,PC_CLOSE_TIMEOUT:5E3,PC_SDP_FLUSH_TIMEOUT:300,PC_SDP_FLUSH_LENGTH:4,
PC_ALLOCATE_CHUNKS_EVENLY:!1,DC_UNORDERED:!0,DC_MAX_RETRANSMITS:void 0,DC_MAX_PACKET_LIFE_TIME:void 0,PEER_UPLINK_REPORT_INTERVAL:1E4,PEER_UPLINK_LOAD_CHECK_INTERVAL:1E3,DELAY_REPORT_INTERVAL:1E4,PC_IDLE_FACTOR:.66,ALLOWED_FILE_SIZE:268697600,ALLOWED_FILE_SIZE_FF:10737418240,USE_FS:!0,USE_PERSISTENT:!0,DISABLE_FS_FF:!0,PROMPT_TIMEOUT:2E4,PERSISTENT_FS_SIZE:10737418240,TEMPORARY_FS_SIZE:32212254720,CACHE_SIZE:52428800,FS_ROOT_DIR:"peer5/",PREALLOCATE_FILE:!0,PERIODIC_CACHE_CLEANUP_PERIOD:6048E5,TIME_PERIOD_FILE_STILL_LIVE:72E5,
SOCKET_RECONNECTION_INTERVAL:3E4,XHR_INITIAL_TIMEOUT:1E4,XHR_MAXIMUM_TIMEOUT:3E4,XHR_MINIMUM_TIMEOUT:2E3,XHR_TIMEOUT_FACTOR:2,XHR_MAX_GET:1,XHR_CONCURRENT:4,HTTP_IDLE_RESET_DURATION:3E4,XHR_SLOT_PROBE_INTERVAL:3E4,MONITOR_INTERVAL:200,REPORT_INTERVAL:2E4,STAT_CALC_INTERVAL:500,DISABLE_GOOGLE_ANALYTICS:!0,SEQUENTIAL_DOWNLOAD:!1,HTTP_ALWAYS_DOWNLOAD:!1,P2P_ALWAYS_DOWNLOAD:!1,P2P_REQUEST_BEGIN_THRESHOLD:0,P2P_REQUEST_END_THRESHOLD:2E4,HYBRID_REQUEST_THRESHOLD:1E4,HTTP_REQUEST_THRESHOLD:5E3,INITIAL_DL_SECS_ESTIMATION:0,
P2P_VOD_WINDOW:10,HTTP_VOD_WINDOW:5,MAX_P2P_REQUESTS:2,MAX_HTTP_REQUESTS:0,MAX_REQUEST_CACHE_SIZE_VOD:314572800,MAX_REQUEST_CACHE_SIZE_LIVE:104857600,FORCE_VOD:!0,EXTERNAL_MEDIA_LOWBUFFER:.1,EXTERNAL_MEDIA_MINBUFFER:-1,EXTERNAL_MEDIA_MINBUFFER_LENGTH_CAPPING:-1,EXTERNAL_MEDIA_MAXBUFFER:10,EXTERNAL_MEDIA_LIVE_START_POS:-1,EXTERNAL_MEDIA_MAXBUFFER_SIZE:6E7,EXTERNAL_MEDIA_MANIFEST_TIMEOUT:1E4,EXTERNAL_MEDIA_MANIFEST_RETRIES:6,EXTERNAL_MEDIA_MANIFEST_RETRY_DELAY:500,EXTERNAL_MEDIA_FRAGMENT_TIMEOUT:2E4,
EXTERNAL_MEDIA_FRAGMENT_RETRIES:6,EXTERNAL_MEDIA_FRAGMENT_RETRY_DELAY:500,EXTERNAL_MEDIA_FPS_MONITOR_PERIOD:5E3,EXTERNAL_MEDIA_FPS_MONITOR_THRESHOLD:.2,EXTERNAL_MEDIA_HLSJS_ENABLE:!0,AGGRESSIVE_P2P:!1,REQUEST_TIMEOUT:!0,P2P_TIMEOUT_DURATION:1E4,HTTP_TIMEOUT_DURATION:1E5,PLAYLIST_SPEED_ESTIMATION:!0,PLAYLIST_TIMEOUT:!0,PLAYLIST_TIMEOUT_DURATION:1E4,INITIAL_P2P_SLOTS:2,MINIMUM_P2P_SLOTS:1,ADD_SLOT_LOADED_REQUESTS_THRESHOLD:3,REDUCE_SLOT_ABORTS_THRESHOLD:2,TIME_ESTIMATION_LIST_LENGTH:5,ZIXI_DIGEST:!1,
MINIMUM_METADATA_SIZE:1E6,VIDEO_DOWNLOAD_SIZE:3E5,BUFFERING_THRESHOLD:.1,URGENT_THRESHOLD:2,BYTE_NEEDED_THRESHOLD:10,ENOUGH_BYTES_THRESHOLD:20,STOP_BUFFERING_THRESHOLD:2,BLOCK_GAP:17,BANDWIDTH_INTERVAL:1E4,PIXEL_SWARM:!1,EXTERNAL_XHR_FALLBACK:!1,LIVE_SECONDS_DELAY:d.core.util.randomOffset(10,35,5),MIN_NUMBER_OF_REMAINING_SEGMENTS:3,SEGMENTS_AFTER_PRUNE:3,FEATURE_PRUNE_SEGMENTS_FROM_START:!0,FEATURE_PROXY_HEAD_KEY:"PROXY_HEAD",FEATURE_PROXY_HEAD_ENABLED:!1,FEATURE_PROXY_HEAD_INITIALIZED:!0,FEATURE_PROXY_HEAD_TIMEOUT:1E3,
FEATURE_PROXY_HEAD_URL_PREFIX:"//dp.gao.easyvideo.vn/h/",FEATURE_PROXY_HEAD_HEALTH_ENDPOINT:"/h/health?_="+Date.now(),FEATURE_PEER5_REQUEST_KEY:"PEER5_REQUEST",FEATURE_PEER5_REQUEST_ENABLED:!0,FEATURE_PEER5_REQUEST_FORCE:!1,FEATURE_DATACHANNEL_KEY:"DATACHANNEL",FEATURE_DATACHANNEL_ENABLED:!0,FEATURE_PAGE_WHITELIST_KEY:"PAGE_WHITELIST",FEATURE_PAGE_WHITELIST_ENABLED:!1,FEATURE_PAGE_WHITELIST_REGEX:/peer5/,FEATURE_PAGE_BLACKLIST_KEY:"PAGE_BLACKLIST",FEATURE_PAGE_BLACKLIST_ENABLED:!1,FEATURE_PAGE_BLACKLIST_REGEX:/peer5/,
FEATURE_XHR_KEY:"XHR",FEATURE_XHR_ENABLED:!0,FEATURE_PEER5_KEY:"PEER5",FEATURE_PEER5_ENABLED:!0,FEATURES_DEFAULT_THRESHOLD:2,FEATURES_DEFAULT_RETRY_INTERVAL:5E3,FEATURE_P2P_IMPROVEMENT_ENABLED:!1,FEATURE_LIMIT_SLOTS_BY_PEERS:!1,FEATURE_CLOSE_DEAD_CONNECTIONS:!0,FEATURE_CLOSE_DEAD_CONNECTIONS_PERMANENTLY:!1,FEATURE_CLOSE_OVERLAPPING_CONNECTIONS:!0,FEATURE_CLOSE_OVERLAPPING_CONNECTIONS_PERMANENTLY:!1,FEATURE_PRE_PLAY_PREFETCH:!0,SEGMENTS_TO_PREFETCH_BEFORE_PLAY:10,STOP_PREFETCH_AFTER_SECONDS:60,PLAYER_SEGMENTS_BUFFER:3,
PREFETCH_LIVE_INTERVAL_MS:2E3,FEATURE_REPORT_PEER_UPLINK_LOAD:!1,FEATURE_REPORT_LIVE_DELAY:!1,FEATURE_DOWNLOAD_SPEED_ESTIMATION:!1,RELEVANT_LAST_ENTRIES:5,URL_ALLOWED_QUERY_PARAMETERS:[],FEATURE_WS_HEARTBEAT:!1,FEATURE_WS_HEARTBEAT_INTERVAL:5E3,FEATURE_WS_HEARTBEAT_ELAPSED:6E4,EXTERNAL_GRINDPLAYER_CALLBACK:"onJSBridge",LOG_LEVEL:0,GA_ONERROR:!0,A_B_TEST:{},A_B_CONFIG_JSON:""};d.getConfig=function(c){return c="EXTERNAL_"+c,c=c.toUpperCase(),d.config[c]};(function(c){c.config=c.config||{};c.config.VERSION+=
".1";c.config.REMOVE_QUERYSTRING_FOR_HASH=!1;c.config.REMOVE_SUBDOMAIN_FOR_HASH=!0;c.config.MAX_CONNECTIONS=100;c.config.USE_PERSISTENT=!1;c.config.AGGRESSIVE_P2P=!0;c.config.PLAYLIST_SPEED_ESTIMATION=!0;c.config.PIXEL_SWARM=!0;c.config.LOG_LEVEL=0;c.config.FEATURE_PROXY_HEAD_ENABLED=!0;c.config.FEATURE_P2P_IMPROVEMENT_ENABLED=!0;c.config.FEATURE_LIMIT_SLOTS_BY_PEERS=!0})(d);(function(c){c.create=function(){function b(a){var b=l[a];b.initFunction&&b.initFunction(function(){l[a].initialized=!0},function(){l[a].initialized=
!1})}function a(a,b){var e=l[a];e.enableFunction?e.enableFunction(function(){e.enabled=!0},b):e.enabled=!0}function e(a,b){var e=l[a];e.disableFunction?e.disableFunction(function(){e.enabled=!1},b):e.enabled=!1}function c(a){return void 0!==l[a]}function d(a){return c(a)?!0===l[a].initialized:!1}function h(a){return c(a)?!0===l[a].enabled:!1}function k(a){return!1===h(a)}var l=Object.create(null);return{add:function(a,e){if("object"==typeof a&&(e=a,a=e.key),c(a))throw Error("Trying to init a new feature that already exist");
var d=a,g;g=e||{};var h={enabled:"boolean"==typeof g.enabled?g.enabled:!0,initFunction:"function"==typeof g.initFunction?g.initFunction:null,enableFunction:"function"==typeof g.enableFunction?g.enableFunction:null,disableFunction:"function"==typeof g.disableFunction?g.disableFunction:null,retryTimer:null,initialized:!0};l[d]=h;h.initFunction&&(h.initialized="boolean"==typeof g.initialized?g.initialized:!1,b(d))},enable:function(b,e){c(b)&&k(b)&&a(b,e)},disable:function(a,b){c(a)&&h(a)&&e(a,b)},isEnabled:h,
isDisabled:k,isEnabledAndInitialized:function(a){return c(a)?h(a)&&d(a):!1},isDisabledAndInitialized:function(a){return c(a)?k(a)&&d(a):!1}}}})(d.featureToggle=d.featureToggle||{});(function(c){var b=function(){var a=null;return Object.keys(c.config.A_B_TEST).forEach(function(b){b=c.config.A_B_TEST[b].length;return a&&b!==a?(c.error("A/B test config values do not match in length"),null):void(a=b)}),a}();c.config.A_B_CONFIG_JSON=function(a){if(!a)return"";var b=Object.keys(c.config.A_B_TEST),d=Math.floor(Math.random()*
a),g=Object.create(null);return b.forEach(function(a){var b=c.config.A_B_TEST[a][d];c.config[a]=b;g[a]=b}),JSON.stringify(g)}(b)})(d);(function(c){c.shortId=function(){return"xxxxxxxx".replace(/[xy]/g,function(b){var a=16*Math.random()|0;return("x"==b?a:3&a|8).toString(16)})};c.generate_uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var a=16*Math.random()|0;return("x"==b?a:3&a|8).toString(16)})}})(d.core.util);(function(c,b,a){b[c]=a(c,b)})("radio",this,function(c,
b){function a(b){return arguments.length?a.$.channel(b):a.$.reset(),a.$}return a.$={version:"0.2",channelName:"",channels:[],reset:function(){a.$.channelName="";a.$.channels=[]},broadcast:function(){var a,c,d,h,k=this.channels[this.channelName],l=k.length;for(a=0;l>a;a++)c=k[a],"object"==typeof c&&c.length&&(d=c[0],h=c[1]||b),d.apply(h,arguments);return this},channel:function(a){var b=this.channels;return b[a]||(b[a]=[]),this.channelName=a,this},subscribe:function(){var a,b,c=arguments,d=this.channels[this.channelName],
k=c.length;b=[];for(a=0;k>a;a++)b=c[a],b="function"==typeof b?[b]:b,"object"==typeof b&&b.length&&d.push(b);return this},unsubscribe:function(){var a,b,c,d=arguments,k=this.channels[this.channelName],l=d.length,p=k.length,n=0;for(a=0;l>a;a++)for(n=0,p=k.length,b=0;p>b;b++)c=b-n,(!(d[a]instanceof Array)&&k[c][0]===d[a]||d[a]instanceof Array&&k[c][0]===d[a][0])&&(d[a]instanceof Array&&k[c][1]!==d[a][1]||(k.splice(c,1),n++));return this}},a});(function(){function c(a,b){var e=f[a],c=(new Date).toISOString(),
d="";1>=a&&(d=Error(),d=d.stack?d.stack.replace("Error\n",""):"");return b.stack?e+"\t"+c+"\t"+b+"\t"+b.stack:e+"\t"+c+"\t"+JSON.stringify(b)+"\t"+d}function b(a,b){this.severity=f[a];if(this.time=(new Date).toISOString(),this.content=b,1>=a)this.stack=Error().stack?Error().stack.replace("Error\n",""):""}"undefined"==typeof d&&(d={});d.logString="S\n";var a=!1,e=d.config?d.config.LOG_LEVEL:2,f="0 ERROR WARNING info log debug".split(" "),g=function(f,g){if(!(f>e))switch(2>=f&&!a&&d.logString&&(d.logString+=
c(f,g)+"\n"),oLog=a?c(f,g):new b(f,g),f){case 1:console.error(oLog);break;case 2:console.warn(oLog);break;case 3:console.info(oLog);break;case 4:case 5:console.log(oLog)}};d.setLogFlat=function(b){a=b};d.setLogLevel=function(a){e=a};d.isVerbose=function(){return 2<e};d.isDebug=function(){return 5==e};d.debug=function(a){g(5,a)};d.log=function(a){g(4,a)};d.info=function(a){g(3,a)};d.warn=function(a){g(2,a)};d.error=function(b){if(g(1,b),d.config&&d.config.GA_ONERROR&&!a){var e=typeof b;if("object"===
e)b=JSON.stringify(b);else if("string"!==e)return void d.warn("couldnt send error event of type "+e);radio("peer5error").broadcast(b)}};b.prototype.toString=function(){var a;return a=this.content.stack?[this.severity,this.time,this.content,this.content.stack]:[this.severity,this.time,JSON.stringify(this.content),this.stack],a.join("\t")}})();(function(c){var b={registerEvents:function(){var a=null,a=window.onerror;window.onerror=function(b,c,g){d.warn("peer5 caught an unhandled error: msg/"+b+" url/"+
c+" lineNumber/"+g);radio("unhandledError").broadcast(b,c,g);a&&"function"==typeof a&&a(b,c,g)}}};b.registerEvents();c.errorHandler=b})(d.core.util);!function(c){c.P2P_DATA=17;c.P2P_REQUEST=18;c.P2P_CANCEL=19;c.P2P_HAVE=20;c.P2P_HAVE_REQUEST=21;c.P2P_DONT_HAVE=22;c.P2P_VERSION=23;c.FILE_INFO=34;c.JOIN=36;c.LEAVE=37;c.CLOSE=38;c.SWARM_HEALTH=41;c.SWARM_ERROR=48;c.SDP=49;c.COMPLETED_DOWNLOAD=50;c.GROUP_REPORT=51;c.GROUP_MATCH=52;c.HEAD=53;c.HEAD_RESPONSE=54;c.HEAD_ERROR=55;c.GROUP_JOIN=56;c.HEARTBEAT=
57;c.SHARE=59;c.LEECH=60;c.GROUP_SDP=61;c.SWARM_NOT_FOUND=0;c.SWARM_ONLY_DEVCHANNEL=1;c.SWARM_ONLY_FIREFOX=11;c.SWARM_ONLY_CHROME=12;c.SWARM_NOT_COMPAT=13;c.Have=function(b,a,e,d,g){this.tag=c.P2P_HAVE;this.swarmId=b;this.hashUrl=g||"0123456789abcdefghijklmnopqrstuv";this.seeder=a;this.blockIds=[];a||(e?(this.complete=!0,this.availabilityMap=e):(this.complete=!1,this.blockIds=d))};c.HaveRequest=function(b){this.tag=c.P2P_HAVE_REQUEST;this.swarmId=b};c.DontHave=function(b,a){this.tag=c.P2P_DONT_HAVE;
this.swarmId=b;this.hashUrl=a||"0123456789abcdefghijklmnopqrstuv"};c.Cancel=function(b,a){this.tag=c.P2P_CANCEL;this.swarmId=b;a||(a=[]);this.all=0==a.length;this.chunkIds=a};c.Request=function(b,a){this.tag=c.P2P_REQUEST;this.swarmId=b;a||(a=[]);this.chunkIds=a};c.Data=function(b,a,e){this.tag=c.P2P_DATA;this.swarmId=b;this.chunkId=a;this.payload=e};c.Version=function(b,a){this.tag=c.P2P_VERSION;this.client=b;this.conf=a};c.GroupReport=function(b){this.tag=c.GROUP_REPORT;this.body=b};c.SwarmReport=
function(){this.peers=this.fsLoad=this.p2pWaste=this.p2pUp=this.p2pDown=this.httpWaste=this.httpDown=0;this.fileSize=null;this.p2pAbort=0};c.Connection=function(b,a,e,c,d,h,k,l,p,n){this.totalBytesDown=b;this.totalBytesUp=a;this.speedDown=e;this.speedUp=c;this.chunksRequested=h;this.chunksExpired=d;this.latency=k;this.connected=l;this.connectingDuration=p;this.failure=n};c.FileInfo=function(b,a,e,d,g,h){this.tag=c.FILE_INFO;this.swarmId=b;this.size=a;this.hash=e;this.hashes=d;this.blockSize=g;this.url=
h};c.Share=function(b,a,e,d,g,h){this.tag=c.SHARE;this.swarmId=b;this.size=a;this.hash=e;this.hashes=d;this.blockSize=g;this.url=h};c.GroupMatch=function(b){this.tag=c.GROUP_MATCH;this.peerIds=b};c.Join=function(b,a){this.tag=c.JOIN;this.swarmId=b;this.matchMe=a};c.Leech=function(b){this.tag=c.LEECH;this.swarmId=b};c.GroupJoin=function(b){this.tag=c.GROUP_JOIN;this.swarmIds=b};c.Leave=function(b){this.tag=c.LEAVE;this.swarmId=b};c.Sdp=function(b,a,e,d,g){this.tag=c.SDP;this.originId=b;this.destId=
a;this.sdpMessage=e;this.port=d;this.type=g};c.GroupSdp=function(b,a,e){this.tag=c.GROUP_SDP;this.originId=b;this.destId=a;this.sdp=e};c.SwarmHealth=function(b,a,e,d){this.tag=c.SWARM_HEALTH;this.swarmId=b;this.numOfSeedersInSwarm=a;this.NumOfPeersInSwarm=e;this.totalCompletedDownloads=d};c.SwarmError=function(b,a){this.tag=c.SWARM_ERROR;this.swarmId=b;this.error=a};c.Head=function(b){this.tag=c.HEAD;this.url=b};c.HeadResponse=function(b,a){this.tag=c.HEAD_RESPONSE;this.url=b;this.responseHeaders=
a};c.HeadError=function(b,a){this.tag=c.HEAD_ERROR;this.url=b;this.statusCode=a};c.Heartbeat=function(){this.tag=c.HEARTBEAT}}(d.core.protocol);(function(c){var b={},a=d.core.protocol;"function"==typeof Uint8Array&&Uint8Array.prototype.subarray&&(Uint8Array.prototype.slice=Uint8Array.prototype.subarray);var e=function(a){return browser_ab2ascii(a)},f=function(a,b){return browser_ascii2ab(a,b)};browser_ab2ascii=function(a){return String.fromCharCode.apply(null,a).trim()};browser_ascii2ab=function(a,
b){for(var e=new Uint8Array(a.length),c=0;c<a.length;c++)e[c]=a.charCodeAt(c);if(b)for(c=a.length;b>c;c++)e[c]=" ";return e};node_ab2ascii=function(a){return a.toString()};node_ascii2ab=function(a,b){var e=new Buffer(a);if(b)for(var c=a.length;b>c;c++)e[c]=" ";return e};var g=function(a,b){b||(b=0);var e=0;return e+=a[b++]<<24,e+=a[b++]<<16,e+=a[b++]<<8,e+a[b]},h=function(a){var b=0;"number"!=typeof a.length&&(a=Array.prototype.slice.call(arguments));for(var e=new Uint8Array(4*a.length),c=0;c<a.length;c++){var d=
a[c];e[b++]=(4278190080&d)>>24;e[b++]=(16711680&d)>>16;e[b++]=(65280&d)>>8;e[b++]=255&d}return e},k={encode:function(a){a=JSON.stringify(a);return browser_ascii2ab(a,void 0)},decode:function(a,b,c){try{var f=e(a.slice(b,b+c));return JSON.parse(f)}catch(g){d.error("BinaryProtocol::json_decode: "+g)}}},l={};l[a.P2P_DATA]={encode:function(a){var e=f(b.packSwarmId(a.swarmId)),c=h(a.chunkId);return b.concat([e,c,a.payload])},decode:function(c,d,f){var h=e(c.slice(d,d+b.transferedSwarmIdSize));d+=b.transferedSwarmIdSize;
var k=g(c,d);d+=4;c=c.slice(d,d+f);return new a.Data(h,k,c)}};l[a.P2P_REQUEST]={encode:function(a){var e=[],c=f(b.packSwarmId(a.swarmId));e.push(c);a=h(a.chunkIds);return e.push(a),b.concat(e)},decode:function(c,d,f){var h=e(c.slice(d,d+b.transferedSwarmIdSize));d+=b.transferedSwarmIdSize;f-=b.transferedSwarmIdSize;for(var k=[];0<f;)k.push(g(c,d)),f-=4,d+=4;return new a.Request(h,k)}};l[a.P2P_CANCEL]={encode:function(a){var e=[],c=f(b.packSwarmId(a.swarmId));e.push(c);a=h(a.chunkIds);return e.push(a),
b.concat(e)},decode:function(c,d,f){var h=e(c.slice(d,d+b.transferedSwarmIdSize));d+=b.transferedSwarmIdSize;f-=b.transferedSwarmIdSize;for(var k=[];0<f;)k.push(g(c,d)),f-=4,d+=4;return new a.Cancel(h,k)}};l[a.P2P_HAVE]={encode:function(a){var e=[],c=f(b.packSwarmId(a.swarmId));e.push(c);c=browser_ascii2ab(a.hashUrl,void 0);e.push(c);c=a.seeder?new Uint8Array([1]):new Uint8Array([0]);e.push(c);c=a.complete?new Uint8Array([1]):new Uint8Array([0]);(e.push(c),a.complete)?e.push(a.availabilityMap):(a=
h(a.blockIds),e.push(a));return b.concat(e)},decode:function(c,d,f){var h,k,l=e(c.slice(d,d+b.transferedSwarmIdSize));d+=b.transferedSwarmIdSize;f-=b.transferedSwarmIdSize;var u=e(c.slice(d,d+b.hashUrlSize));d+=b.hashUrlSize;f-=b.hashUrlSize;var p=0!=c[d];if(d++,f--,!p){var x=0!=c[d];if(d++,f--,x)k=c.slice(d,d+f);else for(h=[];0<f;)h.push(g(c,d)),d+=4,f-=4}return new a.Have(l,p,k,h,u)}};l[a.P2P_DONT_HAVE]={encode:function(a){var e=[],c=f(b.packSwarmId(a.swarmId));e.push(c);a=browser_ascii2ab(a.hashUrl,
void 0);return e.push(a),b.concat(e)},decode:function(c,d,f){f=e(c.slice(d,d+b.transferedSwarmIdSize));d+=b.transferedSwarmIdSize;c=e(c.slice(d,d+b.hashUrlSize));return new a.DontHave(f,c)}};l[a.P2P_VERSION]=k;l[a.P2P_HAVE_REQUEST]=k;l[a.REPORT]=k;l[a.MATCH]=k;l[a.SDP]=k;l[a.FILE_INFO]={encode:function(a){a=JSON.stringify(a);for(var b=new ArrayBuffer(2*a.length),c=new Uint16Array(b),e=0,d=a.length;d>e;e++)c[e]=a.charCodeAt(e);return new Uint8Array(b)},decode:function(a,b,e){a=a.slice(b,b+e);a=String.fromCharCode.apply(null,
new Uint16Array(a.buffer.slice(a.byteOffset))).trim();return JSON.parse(a)}};l[a.SWARM_HEALTH]=k;l[a.SWARM_ERROR]=k;l[a.JOIN]=k;var p=function(a,b,e,c){var d=e;c&&b in l&&l[b].encode&&(d=l[b].encode(e));e=new Uint8Array(5+d.length);c=d.length;return e[a++]=b,e.set(h(c),a),a+=4,e.set(d,a),e};b.concat=function(a){var b=0;a.map(function(a){b+=a.length});var e=new Uint8Array(b),c=0;return a.map(function(a){e.set(a,c);c+=a.length}),e};b.encode=function(a){var e=[];return a.forEach(function(a){if(a&&a.tag&&
l[a.tag]&&l[a.tag].encode){var b=l[a.tag].encode(a);e.push(p(0,a.tag,b))}}),b.concat(e)};b.decode=function(a){for(var b=0,e=[];b<a.length;){var c;c=a;var d=b,f=c[d++],h=g(c,d),d=d+4;c=c.slice(d,d+h);c=[f,c];f=c[0];c=c[1];b+=5;f=l[f];if(!f||!f.decode)return null;e.push(f.decode(a,b,c.length));b+=c.length}return e};b.transferedSwarmIdSize=36;b.hashUrlSize=32;b.packSwarmId=function(a){return a.length>b.transferedSwarmIdSize&&(d.warn("trimming swarmId to be at size of "+b.transferedSwarmIdSize),a=a.substr(0,
b.transferedSwarmIdSize)),Array(b.transferedSwarmIdSize-a.length+1).join(" ").concat(a)};c.packSwarmId=b.packSwarmId;c.concat=b.concat;c.decode=b.decode;c.encode=b.encode})(d.core.protocol.BinaryProtocol=d.core.protocol.BinaryProtocol||{});(function(){var c=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(a){function e(){!c&&this.ctor&&this.ctor.apply(this,arguments)}var d=this.prototype;c=!0;var g=new this;c=!1;for(var h in a){var k="function"==typeof a[h]&&"function"==
typeof d[h]&&b.test(a[h]);g[h]=k?function(a,b){return function(){var e=this._super;this._super=d[a];var c=b.apply(this,arguments);return this._super=e,c}}(h,a[h]):a[h]}for(h in this)this.hasOwnProperty(h)&&"function"!=typeof this[h]&&(e[h]=this[h]);return e.prototype=g,e.constructor=e,e.subClass=arguments.callee,e.addBehavior=function(a,b){if(b=b||{},!a)throw"behaviorAbstractClass must be a vaild behavior class";override(g,b,new a)},e}})();(function(c){var b=b||function(a,b){var c={},d=c.lib={},h=
function(){},k=d.Base={extend:function(a){h.prototype=this;var b=new h;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},l=d.WordArray=
k.extend({init:function(a,c){a=this.words=a||[];this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||n).stringify(this)},concat:function(a){var b=this.words,c=a.words,e=this.sigBytes;if(a=a.sigBytes,this.clamp(),e%4)for(var d=0;a>d;d++)b[e+d>>>2]|=(c[d>>>2]>>>24-d%4*8&255)<<24-(e+d)%4*8;else if(65535<c.length)for(d=0;a>d;d+=4)b[e+d>>>2]=c[d>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-c%4*8;b.length=
a.ceil(c/4)},clone:function(){var a=k.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],e=0;b>e;e+=4)c.push(4294967296*a.random()|0);return new l.init(c,b)}}),p=c.enc={},n=p.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],e=0;a>e;e++){var d=b[e>>>2]>>>24-e%4*8&255;c.push((d>>>4).toString(16));c.push((15&d).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],e=0;b>e;e+=2)c[e>>>3]|=parseInt(a.substr(e,2),16)<<24-e%8*4;return new l.init(c,
b/2)}},m=p.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],e=0;a>e;e++)c.push(String.fromCharCode(b[e>>>2]>>>24-e%4*8&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],e=0;b>e;e++)c[e>>>2]|=(255&a.charCodeAt(e))<<24-e%4*8;return new l.init(c,b)}},q=p.Utf8={stringify:function(a){try{return decodeURIComponent(escape(m.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data");}},parse:function(a){return m.parse(unescape(encodeURIComponent(a)))}},r=d.BufferedBlockAlgorithm=
k.extend({reset:function(){this._data=new l.init;this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=q.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,e=c.words,d=c.sigBytes,f=this.blockSize,g=d/(4*f),g=b?a.ceil(g):a.max((0|g)-this._minBufferSize,0);if(b=g*f,d=a.min(4*b,d),b){for(var h=0;b>h;h+=f)this._doProcessBlock(e,h);h=e.splice(0,b);c.sigBytes-=d}return new l.init(h,d)},clone:function(){var a=k.clone.call(this);return a._data=this._data.clone(),
a},_minBufferSize:0});d.Hasher=r.extend({cfg:k.extend(),init:function(a){this.cfg=this.cfg.extend(a);this.reset()},reset:function(){r.reset.call(this);this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return(new a.init(c)).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return(new t.HMAC.init(a,c)).finalize(b)}}});var t=c.algo=
{};return c}(Math);!function(){var a=b,c=a.lib,d=c.WordArray,g=c.Hasher,h=[],c=a.algo.SHA1=g.extend({_doReset:function(){this._hash=new d.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(a,b){for(var c=this._hash.words,e=c[0],d=c[1],f=c[2],g=c[3],t=c[4],v=0;80>v;v++){if(16>v)h[v]=0|a[b+v];else{var u=h[v-3]^h[v-8]^h[v-14]^h[v-16];h[v]=u<<1|u>>>31}u=(e<<5|e>>>27)+t+h[v];u=20>v?u+((d&f|~d&g)+1518500249):40>v?u+((d^f^g)+1859775393):60>v?u+((d&f|d&g|f&g)-1894007588):
u+((d^f^g)-899497514);t=g;g=f;f=d<<30|d>>>2;d=e;e=u}c[0]=c[0]+e|0;c[1]=c[1]+d|0;c[2]=c[2]+f|0;c[3]=c[3]+g|0;c[4]=c[4]+t|0},_doFinalize:function(){var a=this._data,b=a.words,c=8*this._nDataBytes,e=8*a.sigBytes;return b[e>>>5]|=128<<24-e%32,b[(e+64>>>9<<4)+14]=Math.floor(c/4294967296),b[(e+64>>>9<<4)+15]=c,a.sigBytes=4*b.length,this._process(),this._hash},clone:function(){var a=g.clone.call(this);return a._hash=this._hash.clone(),a}});a.SHA1=g._createHelper(c);a.HmacSHA1=g._createHmacHelper(c)}();c.CryptoJS=
b})(d);(function(c){var b=function(a,b){return a+b&4294967295},a=function(a,c,e,d,f,g){return c=b(b(c,a),b(d,g)),b(c<<f|c>>>32-f,e)},e=function(b,c,e,d,f,g,h){return a(c&e|~c&d,b,c,f,g,h)},d=function(b,c,e,d,f,g,h){return a(c&d|e&~d,b,c,f,g,h)},g=function(b,c,e,d,f,g,h){return a(e^(c|~d),b,c,f,g,h)},h=function(c,h){var k=c[0],l=c[1],m=c[2],n=c[3],k=e(k,l,m,n,h[0],7,-680876936),n=e(n,k,l,m,h[1],12,-389564586),m=e(m,n,k,l,h[2],17,606105819),l=e(l,m,n,k,h[3],22,-1044525330),k=e(k,l,m,n,h[4],7,-176418897),
n=e(n,k,l,m,h[5],12,1200080426),m=e(m,n,k,l,h[6],17,-1473231341),l=e(l,m,n,k,h[7],22,-45705983),k=e(k,l,m,n,h[8],7,1770035416),n=e(n,k,l,m,h[9],12,-1958414417),m=e(m,n,k,l,h[10],17,-42063),l=e(l,m,n,k,h[11],22,-1990404162),k=e(k,l,m,n,h[12],7,1804603682),n=e(n,k,l,m,h[13],12,-40341101),m=e(m,n,k,l,h[14],17,-1502002290),l=e(l,m,n,k,h[15],22,1236535329),k=d(k,l,m,n,h[1],5,-165796510),n=d(n,k,l,m,h[6],9,-1069501632),m=d(m,n,k,l,h[11],14,643717713),l=d(l,m,n,k,h[0],20,-373897302),k=d(k,l,m,n,h[5],5,-701558691),
n=d(n,k,l,m,h[10],9,38016083),m=d(m,n,k,l,h[15],14,-660478335),l=d(l,m,n,k,h[4],20,-405537848),k=d(k,l,m,n,h[9],5,568446438),n=d(n,k,l,m,h[14],9,-1019803690),m=d(m,n,k,l,h[3],14,-187363961),l=d(l,m,n,k,h[8],20,1163531501),k=d(k,l,m,n,h[13],5,-1444681467),n=d(n,k,l,m,h[2],9,-51403784),m=d(m,n,k,l,h[7],14,1735328473),l=d(l,m,n,k,h[12],20,-1926607734),k=a(l^m^n,k,l,h[5],4,-378558),n=a(k^l^m,n,k,h[8],11,-2022574463),m=a(n^k^l,m,n,h[11],16,1839030562),l=a(m^n^k,l,m,h[14],23,-35309556),k=a(l^m^n,k,l,h[1],
4,-1530992060),n=a(k^l^m,n,k,h[4],11,1272893353),m=a(n^k^l,m,n,h[7],16,-155497632),l=a(m^n^k,l,m,h[10],23,-1094730640),k=a(l^m^n,k,l,h[13],4,681279174),n=a(k^l^m,n,k,h[0],11,-358537222),m=a(n^k^l,m,n,h[3],16,-722521979),l=a(m^n^k,l,m,h[6],23,76029189),k=a(l^m^n,k,l,h[9],4,-640364487),n=a(k^l^m,n,k,h[12],11,-421815835),m=a(n^k^l,m,n,h[15],16,530742520),l=a(m^n^k,l,m,h[2],23,-995338651),k=g(k,l,m,n,h[0],6,-198630844),n=g(n,k,l,m,h[7],10,1126891415),m=g(m,n,k,l,h[14],15,-1416354905),l=g(l,m,n,k,h[5],
21,-57434055),k=g(k,l,m,n,h[12],6,1700485571),n=g(n,k,l,m,h[3],10,-1894986606),m=g(m,n,k,l,h[10],15,-1051523),l=g(l,m,n,k,h[1],21,-2054922799),k=g(k,l,m,n,h[8],6,1873313359),n=g(n,k,l,m,h[15],10,-30611744),m=g(m,n,k,l,h[6],15,-1560198380),l=g(l,m,n,k,h[13],21,1309151649),k=g(k,l,m,n,h[4],6,-145523070),n=g(n,k,l,m,h[11],10,-1120210379),m=g(m,n,k,l,h[2],15,718787259),l=g(l,m,n,k,h[9],21,-343485551);c[0]=b(k,c[0]);c[1]=b(l,c[1]);c[2]=b(m,c[2]);c[3]=b(n,c[3])},k=function(a){var b,c=[];for(b=0;64>b;b+=
4)c[b>>2]=a.charCodeAt(b)+(a.charCodeAt(b+1)<<8)+(a.charCodeAt(b+2)<<16)+(a.charCodeAt(b+3)<<24);return c},l=function(a){var b,c=[];for(b=0;64>b;b+=4)c[b>>2]=a[b]+(a[b+1]<<8)+(a[b+2]<<16)+(a[b+3]<<24);return c},p=function(a){var b,c,e,d,f,g,l=a.length,m=[1732584193,-271733879,-1732584194,271733878];for(b=64;l>=b;b+=64)h(m,k(a.substring(b-64,b)));a=a.substring(b-64);c=a.length;e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(b=0;c>b;b+=1)e[b>>2]|=a.charCodeAt(b)<<(b%4<<3);if(e[b>>2]|=128<<(b%4<<3),55<b)for(h(m,
e),b=0;16>b;b+=1)e[b]=0;return d=8*l,d=d.toString(16).match(/(.*?)(.{0,8})$/),f=parseInt(d[2],16),g=parseInt(d[1],16)||0,e[14]=f,e[15]=g,h(m,e),m},n="0123456789abcdef".split(""),m=function(a){var b;for(b=0;b<a.length;b+=1){for(var c=b,e=a[b],d=void 0,f="",d=0;4>d;d+=1)f+=n[e>>8*d+4&15]+n[e>>8*d&15];a[c]=f}return a.join("")},q=function(){this.reset()};"5d41402abc4b2a76b9719d911017c592"!==m(p("hello"))&&(b=function(a,b){var c=(65535&a)+(65535&b);return(a>>16)+(b>>16)+(c>>16)<<16|65535&c});q.prototype.append=
function(a){return/[\u0080-\uFFFF]/.test(a)&&(a=unescape(encodeURIComponent(a))),this.appendBinary(a),this};q.prototype.appendBinary=function(a){this._buff+=a;this._length+=a.length;var b=this._buff.length;for(a=64;b>=a;a+=64)h(this._state,k(this._buff.substring(a-64,a)));return this._buff=this._buff.substr(a-64),this};q.prototype.end=function(a){var b,c,e=this._buff,d=e.length,f=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(b=0;d>b;b+=1)f[b>>2]|=e.charCodeAt(b)<<(b%4<<3);return this._finish(f,d),c=a?this._state:
m(this._state),this.reset(),c};q.prototype._finish=function(a,b){var c,e;e=b;if(a[e>>2]|=128<<(e%4<<3),55<e)for(h(this._state,a),e=0;16>e;e+=1)a[e]=0;c=8*this._length;c=c.toString(16).match(/(.*?)(.{0,8})$/);e=parseInt(c[2],16);c=parseInt(c[1],16)||0;a[14]=e;a[15]=c;h(this._state,a)};q.prototype.reset=function(){return this._buff="",this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this};q.prototype.destroy=function(){delete this._state;delete this._buff;delete this._length};
q.hash=function(a,b){/[\u0080-\uFFFF]/.test(a)&&(a=unescape(encodeURIComponent(a)));var c=p(a);return b?c:m(c)};q.hashBinary=function(a,b){var c=p(a);return b?c:m(c)};q.ArrayBuffer=function(){this.reset()};q.ArrayBuffer.prototype.append=function(a){var b=this._concatArrayBuffer(this._buff,a),c=b.length;this._length+=a.byteLength;for(a=64;c>=a;a+=64)h(this._state,l(b.subarray(a-64,a)));return this._buff=c>a-64?b.subarray(a-64):new Uint8Array(0),this};q.ArrayBuffer.prototype.end=function(a){var b,c,
e=this._buff,d=e.length,f=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(b=0;d>b;b+=1)f[b>>2]|=e[b]<<(b%4<<3);return this._finish(f,d),c=a?this._state:m(this._state),this.reset(),c};q.ArrayBuffer.prototype._finish=q.prototype._finish;q.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this};q.ArrayBuffer.prototype.destroy=q.prototype.destroy;q.ArrayBuffer.prototype._concatArrayBuffer=function(a,b){var c=a.length,
e=new Uint8Array(c+b.byteLength);return e.set(a),e.set(new Uint8Array(b),c),e};q.ArrayBuffer.hash=function(a,b){var c;c=new Uint8Array(a);var e,d,f,g,k,n,q=c.length,p=[1732584193,-271733879,-1732584194,271733878];for(e=64;q>=e;e+=64)h(p,l(c.subarray(e-64,e)));c=q>e-64?c.subarray(e-64):new Uint8Array(0);d=c.length;f=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;d>e;e+=1)f[e>>2]|=c[e]<<(e%4<<3);if(f[e>>2]|=128<<(e%4<<3),55<e)for(h(p,f),e=0;16>e;e+=1)f[e]=0;c=(g=8*q,g=g.toString(16).match(/(.*?)(.{0,8})$/),
k=parseInt(g[2],16),n=parseInt(g[1],16)||0,f[14]=k,f[15]=n,h(p,f),p);return b?c:m(c)};c.MD5=q})(d.core.util);(function(c){c.fileHandler={readFileInSlices:function(b,a,c,f){var g,h=new FileReader,k=0;h.onloadend=function(l){l.target.readyState==FileReader.DONE&&(d.log("onload returned: "+h.readyState),f(b,l.target.result,function(){k++;(k+1)*c<a.size?(g=a.slice(k*c,(k+1)*c),1==h.readyState&&d.error("onloadend in file: "+a+" readyState==1"),d.log("before reading: "+h.readyState),h.readAsArrayBuffer(g)):
k*c<a.size?(g=a.slice(k*c,a.size),h.readAsArrayBuffer(g)):(d.debug("Finished reading file "+b),f(b))}))};g=a.slice(k*c,(k+1)*c);h.readAsArrayBuffer(g)}}})(d.core.util);(function(c){var b=function(){return{combine:function(a,b){if(!a)return b;if(!b)return a;var c="/",d="";-1!==a.indexOf("://")?(d=a.split("://"),c=d[0]+"://",d=d[1]):d=a;for(var d=d.split("/").filter(function(a){return 0<a.length}),h=(b.match(/\.\.\//g)||[]).length,k=0;h>k;k++)d.pop();c+=d.join("/");b=b.replace(/\.\.\//g,"");"/"===b[0]&&
(b=b.replace("/",""));return c.lastIndexOf("/")===c.length-1?c+b:c+"/"+b},getQueryParameter:function(a,b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c=(new RegExp("[\\?&]"+b+"=([^&#]*)")).exec(a);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}}}();c.UrlUtils=b})(d.core.util);window=window||self;(function(c){c.loadScript=function(a,b){var c=document.getElementsByTagName("head")[0],d=document.createElement("script");d.type="text/javascript";d.src=a;d.onreadystatechange=b;d.onload=
b;c.appendChild(d)};c.isObjectEmpty=function(a){for(var b in a)if(a[b])return!1;return!0};c.envokeCallback=function(a,b,g){g=g||window;a&&"function"==typeof a?c.asyncDefer(function(){a.apply(g,b)}):d.log("couldn't envoke the callback: "+a)};c.envokeCallbackSync=function(a,b,c){c=c||window;a&&"function"==typeof a?a.apply(c,b):d.log("couldn't envoke the callback: "+a)};c.executeFunctionByName=function(a,b,c){a=a.split(".");for(var d=a.pop(),k=0;k<a.length;k++)b=b[a[k]];return b[d].apply(b,c)};c.uint8ToString=
function(a){for(var b=[],c=0;c<a.length;c+=32768)b.push(String.fromCharCode.apply(null,a.subarray(c,c+32768)));return b.join("")};c.overrideNative=function(){floor=Math.floor;Math.floor=function(a){return isNaN(a)?void 0:floor(a)};ceil=Math.ceil;Math.ceil=function(a){return isNaN(a)?void 0:ceil(a)};round=Math.round;Math.round=function(a){return isNaN(a)?void 0:round(a)}};c.parseResponseHeaders=function(a){var b={};if(!a)return b;a=a.split("\r\n");for(var c=0;c<a.length;c++){var d=a[c],k=d.indexOf(": ");
if(0<k){var l=d.substring(0,k).toLocaleLowerCase(),d=d.substring(k+2);b[l]=d}}return b};c.parseResponseLengthHeader=function(a,b){return a&&2==a.split("/").length?parseInt(a.split("/")[1]):b?parseInt(b):void 0};var b={},a=0;window.addEventListener("message",function(a){a.data&&"string"==typeof a.data&&-1!==a.data.indexOf("peer5")&&(a=a.data.substr(6),void 0!==b[a]&&(b[a][0].apply(b[a][1]),delete b[a]))});c.asyncDefer=function(c,d){a++;b[a]=[c,d];window.postMessage("peer5/"+a,location.href)};c.removeSubDomain=
function(a){a=a.split(".");return a.shift(),a.join(".")};c.durationToSeconds=function(a){function b(a){if(!a)return 0;a=a.substring(0,a.length-1);return Number(a)}var c=/P([0-9.]+Y)?([0-9.]+M)?([0-9.]+D)?T([0-9.]+H)?([0-9.]+M)?([0-9.]+S)?$/i;return c.test(a)?(a=c.exec(a),c=0,c+=31536E3*b(a[1]),c+=2592E3*b(a[2]),c+=86400*b(a[3]),c+=3600*b(a[4]),c+=60*b(a[5]),c+=b(a[6])):-1};c.getIdFromScriptTag=function(){var a=[].slice.call(document.getElementsByTagName("script")).filter(function(a){return null!==
a.src.match(/.*peer5\.js.*/)});return 0===a.length?null:d.core.util.UrlUtils.getQueryParameter(a[0].src,"id")};d.core.util.overrideNative()})(d.core.util);(function(c){c.UrlSwarmIdMap=function(){var b=Object.create(null),a=Object.create(null);return{addMapping:function(c,d){b[c]=d;a[d]=c},getUrl:function(b){return a[b]},getSwarmId:function(a){return b[a]}}}()})(d.core.util);(function(c){function b(a,b){if(!b||0===b.length)return a;for(var c=a.split("&"),d=0;d<b.length;d++)var e=b[d],c=c.filter(function(a){return 0!==
a.indexOf(e)});return c.join("&")}function a(a,b){b=b||[];return a.split("&").filter(function(a){a=a.split("=")[0];return-1<b.indexOf(a)}).join("&")}var e=/^https?:\/\/(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])*/,f=/^https?:\/\/(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])/;c.urlDigest={};c=c.urlDigest;c.zixi=function(a){var b=a.indexOf("hlsid=HLS_"),c=a.indexOf("interstream");
if(-1!==b&&-1!==c){a=a.replace(":80/","/");b=a.split("?");a=b[0]+"?";var b=b[1].split("&"),c=b[0].indexOf("interstream"),c=b[0].substring(0,c+13)+"1&",d=b[1]+"&",e=b[2].indexOf("hlsid=HLS"),b=b[2].substring(0,e)+"hlsid=HLS_1";a=[a,c,d,b].join("")}return a};c.cleanQueryStringFromKeys=function(a,c){var d=a.indexOf("?");if(-1!==d){var e=a.substring(0,d),d=a.substring(d+1);return(d=b(d,c))?e+"?"+d:e}return a};c.urlWithAllowedKeys=function(b,c){var d=b.indexOf("?");if(-1!==d){var e=b.substring(0,d),d=
b.substring(d+1);return(d=a(d,c))?e+"?"+d:e}return b};c.stripWowzaSession=function(a){return a.replace(/_w\d+/,"_")};c.swarmId=function(a){return!0===d.config.REMOVE_QUERYSTRING_FOR_HASH&&(a=a.split("?")[0]),!0===d.config.REMOVE_WOWZA_SESSION_ID_FOR_HASH&&(a=c.stripWowzaSession(a)),!0===d.config.REPLACE_HOSTNAME_WITH_TOKEN_FOR_HASH?a=a.replace(e,d.config.TOKEN):!0===d.config.REPLACE_IP_TOKEN_FOR_HASH?a=a.replace(f,d.config.TOKEN):!0===d.config.REMOVE_SUBDOMAIN_FOR_HASH&&(a=d.core.util.removeSubDomain(a)),
a};var g=Object.create(null);c.getNormalizedUrlHash=function(a){var b=g[a];if(b)return b;var e=c.swarmId(a);return b=d.core.util.MD5.hash(e),g[a]=b,b}})(d.core.util);(function(c){c.AvailabilityMapBase=Object.subClass({name:"peer5.core.dataStructures.AvailabilityMapBase",ctor:function(b){},has:function(b){throw"unimplemented method";},set:function(b){throw"unimplemented method";},isFull:function(){throw"unimplemented method";},serialize:function(){throw"unimplemented method";},deserializeAndCopy:function(b){throw"unimplemented method";
},deserializeAndUpdate:function(b){throw"unimplemented method";}})})(d.core.dataStructures);(function(c){c.AvailabilityMap=d.core.dataStructures.AvailabilityMapBase.subClass({name:"peer5.core.dataStructures.AvailabilityMap",ctor:function(b,a){if(this._super(b),this.seeder=a,this.size=b,this.length=Math.ceil(this.size/8),this.bitArray=new Uint8Array(this.length),a)for(var c=0;c<this.length;c++)this.bitArray[c]=255;this.numOfOnBits=0;this.bitMask=[1,2,4,8,16,32,64,128]},has:function(b){if(this.isFull())return!0;
b=this.getOffsets(b);return this.bitArray[b.index]&this.bitMask[b.bit]},set:function(b){return this.has(b)?!1:(b=this.getOffsets(b),this.bitArray[b.index]|=this.bitMask[b.bit],this.numOfOnBits++,!0)},setSeeder:function(b){this.numOfOnBits=this.size},isFull:function(){return this.numOfOnBits==this.size},serialize:function(){return this.bitArray},deserializeAndCopy:function(b){this.bitArray=b;for(var a=0,c=0;c<b.length;++c)if(0!=b[c])for(var d=0;d<this.bitMask.length;++d)this.bitArray[c]&this.bitMask[d]&&
a++;this.numOfOnBits=a},deserializeAndUpdate:function(b){for(var a=0;b>a;++a)this.set(b[a]);this.numOfOnBits+=b.length},getOffsets:function(b){var a={};return a.index=Math.floor(b/8),a.bit=b%8,a}})})(d.core.dataStructures);(function(c){c.AvailabilityMapFS=d.core.dataStructures.AvailabilityMap.subClass({name:"peer5.core.dataStructures.AvailabilityMap",ctor:function(b,a,c,d){this._super(b,!1);this.numOfOnFSBits=0;this.resourceId=a;this.metadataFile=a+".fi";this._initiateFromFilesystem(c,d);this.fsBitArray=
new Uint8Array(this.length)},setFS:function(b,a){if(!this.has(b)||this.hasFS(b))return void a(!1);var c=this.getOffsets(b),f=new Uint8Array([this.fsBitArray[c.index]|this.bitMask[c.bit]]);this.fsBitArray[c.index]|=this.bitMask[c.bit];this.numOfOnFSBits++;var g=this;d.core.data.FSio.write(this.metadataFile,f,c.index,function(b,c){return b?void a(!0):(d.warn("couldn't write index to metadata file "+g.metadataFile),"space"===c?g._handleOutOfSpaceError():g._handleWriteError(),void a(error))})},setFSFull:function(b){var a=
this;d.core.data.FSio.write(this.metadataFile,this.bitArray,0,function(c){return c?void b(!0):(a._handleWriteError(),void b(!1))})},hasFS:function(b){if(this.isFullFS())return!0;b=this.getOffsets(b);return this.fsBitArray[b.index]&this.bitMask[b.bit]},isFullFS:function(){return this.numOfOnFSBits===this.size},deserializeAndCopy:function(b){this.fsBitArray=b;for(var a=0,c=0;c<b.length;++c)if(0!=b[c])for(var d=0;d<this.bitMask.length;++d)this.fsBitArray[c]&this.bitMask[d]&&a++;this.numOfOnFSBits=a},
removeBlock:function(b,a){if(this.has(b)){var c=this.getOffsets(b),f=this.bitArray[c.index]&~this.bitMask[c.bit],g=this;d.core.data.FSio.write(this.metadataFile,f,c.index,function(b,k){b?(g.bitArray[c.index]=f,a(!0)):(d.warn("couldn't write index to metadata file "+g.metadataFile),"space"===k?g._handleOutOfSpaceError():g._handleWriteError(),a(!1))})}else a(!0)},removeBlocksFrom:function(b,a){if(b>this.size-1)return void a(!0);var c=this;this.removeBlock(b,function(d){return d?void c.removeBlocksFrom(b+
1,a):void a(!1)})},reset:function(b){this.removeBlocksFrom(0,b)},renameResource:function(b,a){var c=b+".fi",f=this;d.core.data.FSio.renameResource(this.metadataFile,c,function(b){b&&(f.metadataFile=c);a(b)})},_initiateFromFilesystem:function(b,a){var c=this;d.core.data.FSio.isExist(this.metadataFile,function(f){f?(d.info("metadata file "+c.metadataFile+" exists"),d.core.data.FSio.read(c.metadataFile,0,c.length,function(b,f){b?(c.deserializeAndCopy(f),d.info("finished initiating AvailabilityMap from FS"),
a(!0)):(d.warn("error reading metadataFile "+c.metadataFile),a(!1))})):(d.info("metadata file "+c.metadataFile+" doesn't exist, creating a new one"),c.length<b?d.core.data.FSio.createResource(c.metadataFile,function(b){b?(d.log("created metadata file, initiating its length"),d.core.data.FSio.write(c.metadataFile,new Uint8Array([]),c.length-1,function(b,d){b?a(!0):("space"===d?c._handleOutOfSpaceError():c._handleWriteError(),a(!1))})):a(!1)}):(d.warn("not enough space to create metadata file: "+c.metadatFile+
", removing root dir"),d.core.data.FSio.removeRootDir(function(){d.core.data.FSio.createResource(c.metadataFile,function(b){b?(d.log("created metadata file, initiating its length"),d.core.data.FSio.write(c.metadataFile,new Uint8Array([]),c.length-1,function(b,c){b?a(!0):("space"===c?radio("handleOutOfSpaceError").broadcast():radio("handleWriteError").broadcast(),a(!1))})):a(!1)})})))})}})})(d.core.dataStructures);(function(c){c.core.dataStructures.DoublyLinkedList=Object.subClass({name:"peer5.core.dataStructures.DoublyLinkedList",
ctor:function(){this.length=0;this.head=this.tail=null},insert:function(b){b={prev:this.tail,next:null,value:b};this.tail&&(this.tail.next=b);this.tail=b;0==this.length&&(this.head=b);this.length++},remove:function(b){b.prev&&(b.prev.next=b.next);b.next&&(b.next.prev=b.prev);this.tail==b&&(this.tail=b.prev);this.head==b&&(this.head=b.next);!this.head&&1<this.length&&c.error("removing elem: "+b+" but no head in the DoublyLinkedList");this.length--},toString:function(){for(var b=this.head;b;)c.log(b.value),
b=b.next}})})(d);(function(){d.core.dataStructures.LRU=Object.subClass({name:"peer5.core.dataStructures.LRU",ctor:function(c,b,a){this.max=c;this.dict={};this.list=new d.core.dataStructures.DoublyLinkedList;this.deleteCB=b;this.maxSizeThresholder=a},set:function(c,b){d.debug("LRU.set with key: "+c);this.dict[c]&&(d.error("LRU: setting an element that already exists: "+c),this._delete(c));this.list.insert(c);for(this.dict[c]={value:b,p:this.list.tail};this.maxSizeThresholder&&this.maxSizeThresholder()||
!this.maxSizeThresholder&&this.list.length>this.max;)this._delete(this.list.head.value,this.deleteCB)},update:function(c,b){this.dict[c]?this.dict[c].value=b:d.error("LRU: updating an element that didnt exist: "+c)},get:function(c){if(d.debug("LRU.get with key: "+c),this.dict[c]){var b=this.dict[c].p;return b==this.list.tail?this.dict[c].value:(this.list.remove(b),this.list.insert(c),this.dict[c].p=this.list.tail,this.dict[c].value)}return!1},_delete:function(c,b){d.debug("removing key "+c+" from lru");
var a=this.dict[c];this.list.remove(a.p);delete this.dict[c];b&&b(c,a.value)}})})();(function(c,b){c.taskQueue=function(){function a(){b.core.util.asyncDefer(c)}function c(){if(0!==h){var e=d();if(!0===e){try{(0,g[0])()}catch(k){b.error("taskQueue::task() failed"+k)}g.shift();h--;0<h&&a()}else"number"!=typeof e&&(e=0),window.setTimeout(a,e)}}function d(){if(!k.canrun)return!0;try{return k.canrun()}catch(a){return b.error("taskQueue::canrun failed"+a),g.shift(),h--,!1}}var g=[],h=0,k={push:function(b){g[h]=
b;h++;1===h&&a()},getTasks:function(){return g},reset:function(){g=[];h=0},canrun:null};return k}})(d.core.util,d);(function(){d.core.transport.AbstractPeerConnection=Object.subClass({name:"peer5.core.transport.AbstractPeerConnection",ctor:function(c,b,a){this.peerConnection;this.dataChannel;this.label=a?c+b:b+c;this.originId=c;this.targetId=b;this.createAnswerConstraints={};this.createOfferConstraints={};this.startTime;this.ready=!1;this.numOfPendingChunks=this.numOfExpiredChunks=this.numOfRequestedChunks=
this.requestDropped=0;this.maxNumOfPendingChunks=d.config.MAX_PENDING_CHUNKS/2;this.connectingDuration=this.avgLatencyForChunk=this.maxLatencyForChunk=this.minLatencyForChunk=null;this.numOfChunksArrived=0;this.failure=!1},setupCall:function(){throw"unimplemented method";},handleMessage:function(c){throw"unimplemented method";},send:function(c){throw"unimplemented method";},isFull:function(){return this.numOfPendingChunks>=this.maxNumOfPendingChunks}})})();(function(c){function b(){function b(c,d){if(0===
c.length)return 0;c.sort(function(a,b){return a.timeStamp-b.timeStamp});for(var e=[],f=0,g=null,h=0;h<c.length;h++){var k=c[h];if(k.type===a)g||(g=k.timeStamp),e.push(1);else if(e.pop(),0===e.length)f+=k.timeStamp-g,g=null}0<e.length&&(e=Date.now()-g,f+=e);return f}function c(){var d=Object.keys(h),e=[],g=Date.now();d.forEach(function(b){var c=h[b],d=h[b];(d=0<d.length?d[d.length-1]:null)&&d.type===a?(d.timeStamp=g,h[b]=[d]):h[b]=[];e=e.concat(c)});var m=k,d=g-m,m=b(e,m);k=g;d=Math.round(m/d*100);
radio("peerUplinkLoad").broadcast(d)}var h=Object.create(null),k=null,k=Date.now();radio("channelBusy").subscribe(function(b){h[b]||(h[b]=[]);b=h[b];0<b.length&&b[b.length-1].type===a||b.push({type:a,timeStamp:Date.now()})});radio("channelFree").subscribe(function(a){h[a]||(h[a]=[]);a=h[a];0!==a.length&&a[a.length-1].type!==e&&a.push({type:e,timeStamp:Date.now()})});setInterval(function(){c()},d.config.PEER_UPLINK_REPORT_INTERVAL)}if(d.config.FEATURE_REPORT_PEER_UPLINK_LOAD){var a="(",e=")";c.DataChannelStatsCollector=
b()}})(d.core.transport);(function(){window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection;window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription;window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate;d.core.transport.PeerConnectionImpl=d.core.transport.AbstractPeerConnection.subClass({name:"peer5.core.transport.PeerConnectionImpl",ctor:function(c,b,a,e){this._super(c,b,a);this.initiator=
a;this.peerConnection=e||void 0;this.useBase64=!1;this.dataChannelOptions={};d.config.DC_UNORDERED&&(this.dataChannelOptions.ordered=!1);d.config.DC_MAX_RETRANSMITS?this.dataChannelOptions.maxRetransmits=d.config.DC_MAX_RETRANSMITS:d.config.DC_MAX_PACKET_LIFE_TIME&&(this.dataChannelOptions.maxPacketLifeTime=d.config.DC_MAX_PACKET_LIFE_TIME);this.initiatePeerConnection(a);this.sdpQueue=[];this.bufferCheckInterval=this.sdpQueueTimer=null},initBufferCheck:function(){var c=this;this.bufferCheckInterval=
setInterval(function(){c.dataChannel&&0===c.dataChannel.bufferedAmount&&c.reportChannelFree()},d.config.PEER_UPLINK_LOAD_CHECK_INTERVAL)},reportChannelFree:function(){radio("channelFree").broadcast(this.targetId)},setupCall:function(){this.startTime=Date.now();d.debug("createOffer with constraints: "+JSON.stringify(this.createOfferConstraints,null," "));this.peerConnection.createOffer(this.setLocalAndSendMessage_,function(c){d.debug("createOffer(): failed, "+c)},this.createOfferConstraints);setTimeout(function(c){c.ready||
(d.info("ready state of PCImpl to "+c.targetId+" = "+c.ready),c.failure=!0,d.warn("couldn't connect to "+c.targetId),d.info("signaling state:",c.peerConnection.signalingState," icegathering state:",c.peerConnection.iceGatheringState," iceconnection state:",c.peerConnection.iceConnectionState," datachannel readyState:",c.dataChannel.readyState),c.handlePeerDisconnection(c.targetId))},d.config.PC_FAIL_TIMEOUT,this)},handleMessage:function(c){var b=c.sdpMessage;if(d.info("handling message "+c),b.type){var a=
new RTCSessionDescription(b),e=this;if(this.peerConnectionStateValid()&&(this.peerConnection.remoteDescriptionSet=!0,d.debug("adding remote description: "+this.targetId),this.peerConnection.setRemoteDescription(a,function(){(d.debug("setRemoteDescription(): success."),e.peerConnection.remoteDescriptionSuccessfullySet=!0,"offer"==a.type)&&(d.debug("createAnswer with constraints: "+JSON.stringify(this.createAnswerConstraints,null," ")),e.peerConnectionStateValid())&&e.peerConnection.createAnswer(e.setLocalAndSendMessage_,
function(a){d.debug("createAnswer(): failed, "+a)},e.createAnswerConstraints)},function(a){d.debug("setRemoteDescription(): failed, "+a)}),this.peerConnection.candidatesMsgQueue)){for(b=0;b<this.peerConnection.candidatesMsgQueue.length;++b)this.peerConnection.addIceCandidate(new RTCIceCandidate(this.peerConnection.candidatesMsgQueue[b]),this.addIceCandidateFailureCallback_,this.addIceCandidateFailureCallback_);this.peerConnection.candidatesMsgQueue=null}}else{if(b.candidate){if(!this.peerConnectionStateValid())return;
if(!this.peerConnection.remoteDescriptionSet)return d.debug("added ice candidate before setting remote description - not adding: "+this.targetId),this.peerConnection.candidatesQueue||(this.peerConnection.candidatesMsgQueue=[]),void this.peerConnection.candidatesMsgQueue.push(b);d.debug("signaling state: "+this.peerConnection.signalingState+" icegathering state: "+this.peerConnection.iceGatheringState+" iceconnection state: "+this.peerConnection.iceConnectionState);c=JSON.stringify(b);if(c in this.peerConnection.candidates)return void d.warn("candidate was already added");
if(!this.peerConnectionStateValid())return;b=new RTCIceCandidate(b);return this.peerConnection.addIceCandidate(b,this.addIceCandidateSuccessCallback_,this.addIceCandidateFailureCallback_),void(this.peerConnection.candidates[c]=Date.now())}d.log("unknown message received")}},send:function(c){c=this.useBase64?d.core.util.base64.encode(c):c.buffer;this._send(c,d.config.P2P_SEND_RETRIES)},_send:function(c,b){if(this.dataChannel&&"open"===this.dataChannel.readyState.toLowerCase()){d.debug("sending data on dataChannel");
try{this.dataChannel.send(c),0<this.dataChannel.bufferedAmount&&radio("channelBusy").broadcast(this.targetId)}catch(a){d.warn("dataChannel failed to send data",a)}}else d.info("dataChannel was not ready, setting timeout"),0<b&&(b--,setTimeout(this._send.bind(this),d.config.PC_RESEND_INTERVAL,c,b))},close:function(){this.ready=!1;this.dataChannel&&this.dataChannel.close&&this.dataChannel.close();this.peerConnection&&this.peerConnection.close&&this.peerConnection.close()},getBufferedAmount:function(){return this.dataChannel.bufferedAmount},
sendSdpMessage:function(c){if(this.sdpQueue.push(c),this.sdpQueue.length===d.config.PC_SDP_FLUSH_LENGTH)this.flushSdpMessageQueue();else if(!this.sdpQueueTimer){var b=this;this.sdpQueueTimer=setTimeout(function(){b.sdpQueueTimer=null;b.flushSdpMessageQueue()},d.config.PC_SDP_FLUSH_TIMEOUT)}},flushSdpMessageQueue:function(){if(clearTimeout(this.sdpQueueTimer),this.sdpQueueTimer=null,this.sdpQueue.length){var c=this.sdpQueue;this.sdpQueue=[];c=new d.core.protocol.GroupSdp(this.originId,this.targetId,
c);radio("router.send").broadcast(c,!0)}},initiatePeerConnection:function(c){this.initiatePeerConnectionCallbacks();this.createPeerConnection();c&&this.ensureHasDataChannel()},initiatePeerConnectionCallbacks:function(){this.registerEvents()},registerEvents:function(){var c=this;this.setLocalAndSendMessage_=function(b){b.sdp=c.transformOutgoingSdp(b.sdp);c.peerConnection.setLocalDescription(b,function(){d.debug("setLocalDescription(): success.")},function(a){d.debug("setLocalDescription(): failed"+
a)});d.debug("Sending SDP message:\n"+b.sdp);c.sendSdpMessage(b)};this.iceCallback_=function(b){b.candidate&&"disconnected"!=b.target.iceConnectionState&&c.sendSdpMessage(b.candidate)};this.iceStateChangedCallback_=function(b){d.debug("iceGatheringState: "+b.target.iceGatheringState);b.target&&"disconnected"===b.target.iceConnectionState&&(d.info("iceStateChanged to disconnected"),c.handlePeerDisconnection())};this.signalingStateChangeCallback_=function(b){b.target&&"closed"==b.target.signalingState&&
(d.info("signalingStateChanged to closed"),c.handlePeerDisconnection())};this.onCreateDataChannelCallback_=function(b){null!=c.dataChannel&&"closed"!=c.dataChannel.readyState&&d.warn("Received DataChannel, but we already have one.");c.dataChannel=b.channel;d.debug("DataChannel with label "+c.dataChannel.label+" initiated by remote peer.");c.hookupDataChannelEvents()};this.onDataChannelReadyStateChange_=function(b){b=b.target.readyState;d.info("DataChannel to "+c.targetId+" state:"+b);"open"==b.toLowerCase()&&
(c.initBufferCheck(),c.ready=!0,c.connectingDuration=Date.now()-c.startTime,radio("connectionReady").broadcast(c.targetId))};this.onDataChannelClose_=function(b){d.info("data channel was closed");c.handlePeerDisconnection()};this.onMessageCallback_=function(b){d.debug("receiving data on dataChannel");b=c.useBase64?d.core.util.base64.decode(b.data):new Uint8Array(b.data);radio("dataReceivedEvent").broadcast(b,c.targetId)};this.addIceCandidateSuccessCallback_=function(b){};this.addIceCandidateFailureCallback_=
function(b){d.warn("addIceCandidate failed "+b)}},ensureHasDataChannel:function(){null==this.peerConnection&&d.warn("Tried to create data channel, but have no peer connection.");null!=this.dataChannel&&"closed"!=this.dataChannel&&d.warn("Creating DataChannel, but we already have one.");this.createDataChannel()},createPeerConnection:function(){this.peerConnection?d.info("using peerConnection from pool"):(this.peerConnection=d.core.transport.PeerConnectionImpl.createPeerConnection(),d.info("creating peerConnection on demand"));
this.peerConnection.candidates={};this.peerConnection.onicecandidate=this.iceCallback_;this.peerConnection.oniceconnectionstatechange=this.iceStateChangedCallback_;this.peerConnection.onicechange=this.iceStateChangedCallback_;this.peerConnection.onsignalingstatechange=this.signalingStateChangeCallback_;this.peerConnection.ondatachannel=this.onCreateDataChannelCallback_},createDataChannel:function(){d.info("createDataChannel");this.dataChannel=this.peerConnection.createDataChannel(this.label,this.dataChannelOptions);
d.debug("DataChannel with label "+this.dataChannel.label+" initiated locally.");this.hookupDataChannelEvents()},closeDataChannel:function(){null==this.dataChannel&&d.warn("Closing DataChannel, but none exists.");d.debug("DataChannel with label "+this.dataChannel.label+" is being closed.");this.dataChannel.close()},hookupDataChannelEvents:function(){this.dataChannel.binaryType="arraybuffer";this.dataChannel.onmessage=this.onMessageCallback_;this.dataChannel.onopen=this.onDataChannelReadyStateChange_;
this.dataChannel.onclose=this.onDataChannelClose_;d.info("data-channel-status: "+this.dataChannel.readyState)},transformOutgoingSdp:function(c){var b=c.split("b=AS:30");return 1<b.length?b[0]+"b=AS:1638400"+b[1]:c},handlePeerDisconnection:function(){this.reportChannelFree();clearInterval(this.bufferCheckInterval);d.info("signaling state:",this.peerConnection.signalingState," icegathering state:",this.peerConnection.iceGatheringState," iceconnection state:",this.peerConnection.iceConnectionState," datachannel.readyState:",
this.dataChannel?this.dataChannel.readyState:"undefined.undefined");this.dataChannel&&"closed"!=this.dataChannel.readyState&&(d.info("handling peer disconnection: closing the datachannel"),this.dataChannel.close());"closed"!=this.peerConnection.signalingState&&d.info("handling peer disconnection: closing the peerconnection");this.closed||(this.closed=!0,radio("connectionFailed").broadcast(this.targetId))},peerConnectionStateValid:function(){return"closed"!=this.peerConnection.iceConnectionState&&
"closed"!=this.peerConnection.signalingState?!0:(d.warn("peerConnection state to "+this.targetId+" is invalid - 'not usable'"),!1)}});d.core.transport.PeerConnectionImpl.createPeerConnection=function(){for(var c,b=d.config.STUN_SERVERS,a=d.config.TURN_SERVERS?d.config.TURN_SERVERS:[],e=d.config.TURN_CREDENTIALS,f={iceServers:[]},g=0;g<b.length;++g)f.iceServers.push({urls:"stun:"+b[g]});for(b=0;b<a.length;++b)f.iceServers.push({urls:"turn:"+a[b],credential:e[b]});try{d.info("creating peerConnection"),
c=new RTCPeerConnection(f)}catch(h){d.warn("Failed to create peer connection: "+h)}return c}})();(function(){d.core.stats.StatsCalculator=Object.subClass({name:"peer5.core.stats.StatsCalculator",ctor:function(){this.statsTimestamp=this.Total_Avg_Download=this.Avg_Recv_HTTP=this.Avg_Recv_P2P=this.Total_Avg_Download=this.Total_Recv_HTTP=this.Total_Recv_P2P=this.Total_Recv_No_Waste=0;this.startTime=Date.now()},calcAvg:function(c){var b=Date.now()-this.statsTimestamp;this.statsTimestamp+=b;b/=1E3;this.Total_Recv_No_Waste=
c.totalP2PDownloaded+c.totalHttpDownloaded;this.Total_Avg_Download=(c.totalHttpDownloaded+c.totalP2PDownloaded)/((Date.now()-this.startTime)/1E3);this.Avg_Recv_P2P=(c.totalP2PDownloaded-this.Total_Recv_P2P)/b;this.Avg_Recv_HTTP=(c.totalHttpDownloaded-this.Total_Recv_HTTP)/b;this.Total_Recv_P2P=c.totalP2PDownloaded;this.Total_Recv_HTTP=c.totalHttpDownloaded}})})();(function(){d.core.stats.ReportBuilder=Object.subClass({name:"peer5.core.stats.reportBuilder",ctor:function(){this.queue=[];this.currentReport=
{};this.urlsMap={};this.registerEvents()},registerEvents:function(){radio("speedEstimationCalculated").subscribe([function(c){var b=this.urlsMap[c.url];b&&(b=this.getSwarmReport(b),b.mode=c.mode,b.predictedSpeed=c.predictedSpeed,b.actualSpeed=c.actualSpeed,b.bytesDownloaded=c.bytesDownloaded)},this]);radio("fileInfoProcessed").subscribe([function(c){c.swarmId&&c.url&&(this.urlsMap[c.url]=c.swarmId)},this]);radio("peer5_received_fs_chunk").subscribe([function(c,b){var a=this.getSwarmReport(c);a.fsLoad=
a.fsLoad?a.fsLoad+b:b},this]);radio("xhrBytesReceived").subscribe([function(c,b){var a=this.urlsMap[c];a&&(a=this.getSwarmReport(a),a.httpDown=a.httpDown?a.httpDown+b:b)},this]);radio("peer5_waste_http_chunk").subscribe([function(c,b){var a=this.urlsMap[c];a&&(a=this.getSwarmReport(a),a.httpWaste=a.httpWaste?a.httpWaste+b:b)},this]);radio("peer5_new_p2p_chunk").subscribe([function(c,b){var a=this.getSwarmReport(c);a.p2pDown=a.p2pDown?a.p2pDown+b:b},this]);radio("chunkSentEvent").subscribe([function(c,
b){var a=this.getSwarmReport(c);a.p2pUp=a.p2pUp?a.p2pUp+b:b},this]);radio("peer5_waste_p2p_chunk").subscribe([function(c,b){var a=this.getSwarmReport(c);a.p2pWaste=a.p2pWaste?a.p2pWaste+b:b},this]);radio("p2pAbort").subscribe([function(c){c=this.getSwarmReport(c);c.p2pAbort=c.p2pAbort?c.p2pAbort+1:1},this]);radio("external.player").subscribe([function(c){this.getPlayerReport().push({vendor:c.vendor,action:c.action,duration:c.duration,timeSinceLoaded:c.timeSinceLoaded})},this]);radio("playbackDelay").subscribe([function(c){this.getNetworkReport().secondsDelay=
c},this]);radio("peerUplinkLoad").subscribe([function(c){this.getNetworkReport().peerUplinkLoadPercent=c},this]);radio("activePeerConnectionsNumberChanged").subscribe([function(c){this.getPeersReport().connected=c},this]);radio("availablePeerConnectionsNumberChanged").subscribe([function(c){this.getPeersReport().available=c},this])},getSwarmReport:function(c){return c?(this.currentReport.swarms||(this.currentReport.swarms={}),this.currentReport.swarms[c]||(this.currentReport.swarms[c]={}),this.currentReport.swarms[c]):
null},getPlayerReport:function(){return this.currentReport.player||(this.currentReport.player=[]),this.currentReport.player},getPeersReport:function(){return this.currentReport.peers||(this.currentReport.peers={}),this.currentReport.peers},getNetworkReport:function(){return this.currentReport.network||(this.currentReport.network={}),this.currentReport.network},getSwarmFileSize:function(c){return(c=d.core.data.BlockCache.get(c))&&c.init?c.fileSize:0},rotateReport:function(){var c=this.currentReport;
if(this.currentReport={},c.swarms)for(var b=c.swarms,a=Object.keys(b),e=0,f=a.length;f>e;e++){var g=a[e],h=this.getSwarmFileSize(g);h&&(b[g].fileSize=h);b[g].peers=d.clientInstance.controller.P2PController.getSwarmPeersCount(g)}c.network&&"undefined"==typeof c.network.peerUplinkLoadPercent&&delete c.network;d.core.util.isObjectEmpty(c)||this.queue.push(c)},processQueue:function(){this.rotateReport();for(var c=null;c=this.queue.shift();)c=new d.core.protocol.GroupReport(c),radio("router.send").broadcast(c)}});
d.core.stats.ReportBuilder=new d.core.stats.ReportBuilder})();(function(){d.core.stats.StatsCollector=Object.subClass({name:"peer5.core.stats.StatsCollector",ctor:function(){this.statsEvents={totalP2PDownloaded:"peer5_new_p2p_chunk",totalP2PUploaded:"chunkSentEvent",totalP2PWaste:"peer5_waste_p2p_chunk",totalHttpDownloaded:"xhrBytesReceived",totalHttpWaste:"peer5_waste_http_chunk",totalFSLoaded:"peer5_received_fs_chunk",totalVerifiedBytes:"blockReceivedEvent"};this.playerStats={"load.end":[],"seek.end":[],
"rebuffer.end":[]};this.fpsDrop=[];this.lastHttpSpeed=0;this.stats={};this.numOfPeers=0;this.statsCalculators={};this._initResource("*");this._registerEvents()},getStats:function(c){c=c||"*";var b={},a;for(a in d.core.stats.StatsCollector.stats[c])b[a]=d.core.stats.StatsCollector.stats[c][a];for(a in d.core.stats.StatsCollector.playerStats)b[a]=d.core.stats.StatsCollector.playerStats[a];return b.numOfPeers=this.getNumOfPeers(),b},getNumOfPeers:function(){return this.numOfPeers},getLastHttpSpeed:function(){return this.lastHttpSpeed},
calcAvg:function(){for(var c in this.statsCalculators)this.statsCalculators[c].calcAvg(this.stats[c]),radio("peer5_state_updated").broadcast(this.statsCalculators[c],this.statsCalculators[c].url)},_registerEvents:function(){function c(a){radio(b.statsEvents[a]).subscribe([function(b,c){this.stats[b]||this._initResource(b);this.stats[b][a]+=c;this.stats["*"][a]+=c},b])}var b=this,a;for(a in this.statsEvents)c(a);radio("resourceAdded").subscribe([function(a){this.stats[a]||this._initResource(a);this.stats[a].start=
performance.now();this.stats[a].startLoaded=this.stats[a].totalVerifiedBytes},this]);radio("resourceLoadEnd").subscribe([function(a,b){this.stats[a].end=performance.now();this.setSpeed(a,b)},this]);radio("external.player").subscribe([function(a){void 0!==this.playerStats[a.action]?this.playerStats[a.action].push(a.duration):"fps.drop"===a.action&&this.fpsDrop.push(a.label)},this]);radio("fileInfoProcessed").subscribe([function(a){a.swarmId&&a.url&&(this.stats[a.swarmId]&&!this.stats[a.url]?(this.stats[a.url]=
this.stats[a.swarmId],this.statsCalculators[a.url]=this.statsCalculators[a.swarmId]):this.stats[a.url]&&!this.stats[a.swarmId]?(this.stats[a.swarmId]=this.stats[a.url],this.statsCalculators[a.swarmId]=this.statsCalculators[a.url]):this.stats[a.swarmId]||this.stats[a.url]||(this._initResource(a.swarmId),this.stats[a.url]=this.stats[a.swarmId],this.statsCalculators[a.url]=this.statsCalculators[a.swarmId]),this.statsCalculators[a.swarmId].url=a.url,this.statsCalculators[a.swarmId].size=a.size)},this]);
radio("activePeerConnectionsNumberChanged").subscribe([function(a){this.numOfPeers=a},this]);radio("fwBeforeUnload").subscribe([function(a,b){var c=this.statsCalculators[a];c.calcAvg(this.stats[a]);var d=this.stats[a].totalHttpDownloaded+this.stats[a].totalP2PDownloaded+this.stats[a].totalFSLoaded;radio("exitPageStats").broadcast(d/b,c.Avg_Recv_HTTP+c.Avg_Recv_P2P,c.Total_Avg_Download)},this])},setSpeed:function(c,b){var a=this.stats[c].startLoaded;a<this.statsCalculators[c].size&&(a=(this.stats[c].totalVerifiedBytes-
a)/((this.stats[c].end-this.stats[c].start)/1E3),this.stats[c].loadSpeed=a,3===b&&(this.lastHttpSpeed=a))},removeResource:function(c,b){delete this.statsCalculators[c];delete this.stats[c];delete this.statsCalculators[b];delete this.stats[b]},_initResource:function(c){this.stats[c]={};for(var b in this.statsEvents)this.stats[c][b]=0;this.statsCalculators[c]=new d.core.stats.StatsCalculator(c)}});d.core.stats.StatsCollector=new d.core.stats.StatsCollector;d.getStats=function(){return d.core.stats.StatsCollector.getStats()};
d.getFps=function(){return d.core.stats.StatsCollector.fpsDrop.slice()}})();(function(){d.core.controllers.IController=Object.subClass({download:function(c,b,a){throw"unimplemented method";},stopResource:function(c){throw"unimplemented method";},removeResource:function(c){throw"unimplemented method";},init:function(c){throw"unimplemented method";},isPendingBlock:function(c,b){throw"unimplemented method";},getConnectionStats:function(){throw"unimplemented method";}})})();(function(c){var b=d.config.BLOCK_SIZE/
d.config.CHUNK_SIZE;c.PendingBlockMap=function(){function a(a,b){var c=f[a];return c?(c=c[b])?!d.core.util.isObjectEmpty(c):!1:!1}function c(a,d){var e=Math.floor(d/b);f[a]||(f[a]=Object.create(null));f[a][e]||(f[a][e]=Object.create(null));f[a][e][d]=Date.now()}var f=Object.create(null);return{isResourcePending:function(b){var c=f[b];if(!c)return!1;var c=Object.keys(c),d;for(d in c)if(a(b,d))return!0;return!1},isBlockPending:a,addChunk:c,addResource:function(a,b){for(var f=Math.floor(b/d.config.CHUNK_SIZE)+
1,l=0;f>l;l++)c(a,l)},removeChunk:function(a,c){if(f[a]){var d=Math.floor(c/b);f[a][d]&&delete f[a][d][c]}},removeBlock:function(a,b){f[a]&&delete f[a][b]},removeResource:function(a){delete f[a]}}}()})(d.core.dataStructures);(function(){var c=d.core.util.UrlSwarmIdMap;d.core.controllers.AbstractController=d.core.controllers.IController.subClass({ctor:function(b){this.resourceState=Object.create(null)},init:function(b,a){!a&&this.resourceState[b]||(this.resourceState[b]=!0)},removeResource:function(b){delete this.resourceState[b];
d.core.dataStructures.PendingBlockMap.removeResource(b)},stopResource:function(b){this.resourceState[b]="stop";d.core.dataStructures.PendingBlockMap.removeResource(b)},addChunk:function(b,a,c){d.core.data.BlockCache.get(b).setChunk(c,a)},addBlock:function(b,a,c){d.core.data.BlockCache.get(b).setBlock(c,a)},getRarestBlocks:function(b,a,e){var f,g;g=d.core.data.BlockCache.get(b);var h=[],k=[],l=this.P2PController||this;b=c.getSwarmId(b)||b;for(var p=0,n=g.getNumOfBlocks();n>p;p++)if(g=0,e(p)){for(var m in l.remoteAvailabilityMaps[b])l.remoteAvailabilityMaps[b][m].has(p)&&
g++;0==k.length?(h.push(p),f=g):g===f?h.push(p):f>g&&(h=[p],f=g)}return d.core.util.randSample(h,a)},getSeqBlocks:function(b,a,c){var f=d.core.data.BlockCache.get(b);b=[];for(var g=f.getFirstMissingBlock(),f=f.getNumOfBlocks()-1;f>=g&&b.length<a;g++)if(c(g))b.push(g);else if(b.length)break;return b}})})();(function(c){c.PeersPerformanceTracker=function(){function b(a){var b=f[a];b.idleTimeout&&clearTimeout(b.idleTimeout);b.idleTimeout=setTimeout(function(){radio("connectionIdle").broadcast({peerId:a,
peerData:b})},1E3*d.config.SECONDS_BEFORE_IDLE)}function a(a){f[a]={idleTimeout:null,totalBytesReceived:0,totalDownloadTime:0,lastDownloadTimestamp:Date.now(),totalBytesSent:0,lastUploadTimestamp:Date.now(),clientVersion:null,lastSwarmReportedAsHave:null,lastHaveReportTimestamp:Date.now()};b(a)}var c=Object.create(null),f=Object.create(null);return{reportChunksRequestFromPeer:function(a,b){c[a]||(c[a]=Object.create(null));for(var d=0;d<b.length;d++)c[a][b[d]]=Date.now()},reportChunksReceivedFromPeer:function(d,
h,k){f[d]||a(d);var l=f[d],p=k.bytes;h=Date.now()-c[h][k.id];l.totalBytesReceived+=p;l.totalDownloadTime+=h;l.lastDownloadTimestamp=Date.now();b(d)},reportUploadToPeer:function(c,d){f[c]||a(c);var e=f[c];e.totalBytesSent+=d;e.lastUploadTimestamp=Date.now();b(c)},reportPeerConnected:function(b){f[b]||a(b)},reportPeerDisconnected:function(a){delete f[a]},reportPeerClientVersion:function(b,c){f[b]||a(b);f[b].clientVersion=c},reportPeerHaveSwarm:function(b,c){f[b]||a(b);var d=f[b];d.lastSwarmReportedAsHave=
c;d.lastHaveReportTimestamp=Date.now()}}}()})(d.core.util);(function(){var c=d.core.dataStructures.PendingBlockMap,b=[],a=!1;document.addEventListener("DOMContentLoaded",function(){var c=0,f=setInterval(function(){d.info("creating peerConnection for pool");b.push(d.core.transport.PeerConnectionImpl.createPeerConnection());c++;(c>d.config.PC_POOL_SIZE||a)&&clearInterval(f)},d.config.PC_POOL_INIT_INTERVAL)});d.core.controllers.P2PController=d.core.controllers.AbstractController.subClass({ctor:function(a,
b){this._super();this.peersPerformanceTracker=d.core.util.PeersPerformanceTracker;this.lastSwarmDownloaded={swarmId:null,timeStamp:null};this.peersBlacklist=Object.create(null);this.clientId=a;this.peerConnections=Object.create(null);this.sendQueues=Object.create(null);this.initPeerConnections=Object.create(null);this.droppedConnections=Object.create(null);this.attemptedConnections=Object.create(null);this.deletedPeerConnections=Object.create(null);this.numberOfPCCreated=0;this.inited=!1;this.remoteAvailabilityMaps=
Object.create(null);this.remoteHave=Object.create(null);this.p2pPendingChunks=Object.create(null);this.p2pPendingChunksInBlock=Object.create(null);this.peerSwarms=Object.create(null);this.peerConnectionImpl=null;this.prefetchFlag=Object.create(null);this.resourceState=Object.create(null);this.pendingResources=Object.create(null);this.configureBrowserSpecific();this.requestNum=this.availableTimeStamp=0;this.pendingRequests=Object.create(null);this.allocatingPC=!1;this.initClosePCQueue();this.registerEvents()},
init:function(b,c,d){a=!0;this._super(b,d);(d||!this.p2pPendingChunks[b])&&(this.p2pPendingChunks[b]=Object.create(null),this.p2pPendingChunksInBlock[b]=Object.create(null));this.remoteAvailabilityMaps[b]||(this.remoteAvailabilityMaps[b]=Object.create(null));this.prefetchFlag[b]=c;this.addResourceAsPending(b);this.loadCachedHaveRequests(b)},download:function(a,b,c){var h=d.core.data.BlockCache.get(a);if(h){var k;if(k=b?[b]:this.getAvailablePeersWithSwarm(a),k&&0!==k.length)if(b||(this.lastSwarmDownloaded.swarmId=
a,this.lastSwarmDownloaded.timeStamp=Date.now()),b=this.getNumOfChunksToAllocate(k),!(0>=b)){var l,p,n=[];if((this.lastBlockRequestedInP2P||0===this.lastBlockRequestedInP2P)&&!h.has(this.lastBlockRequestedInP2P)){p=this.lastBlockRequestedInP2P;l=h.getChunkIdsOfBlock(p);for(var m=0;m<l.length&&n.length<b;++m)h.hasChunk(l[m])||this.isPendingChunk(a,l[m])||n.push(l[m])}if(b-=n.length,0>=b)return this.distributeChunksAmongSources(a,n);for(var q=this,r=this.getRarestBlocks(a,Math.ceil(b/(d.config.BLOCK_SIZE/
d.config.CHUNK_SIZE)),function(b){for(var d=0,f=k.length;f>d;d++){var l=q.remoteAvailabilityMaps[a][k[d]];if(l&&l.has(b))return c?c(b):!h.has(b)&&!q.isPendingEntireBlock(a,b)}return!1}),m=0;m<r.length;m++)if(r[m]!==p){l=h.getChunkIdsOfBlock(r[m]);for(var t=0;t<l.length&&n.length<=b;++t)h.hasChunk(l[t])||this.p2pPendingChunks[a]&&this.p2pPendingChunks[a][l[t]]||n.push(l[t]);this.lastBlockRequestedInP2P=r[m]}return this.distributeChunksAmongSources(a,n)}}},getAvailablePeersWithSwarm:function(a){var b=
[],c;for(c in this.peerConnections)this.isPeerAvailable(c)&&this.remoteAvailabilityMaps[a]&&this.remoteAvailabilityMaps[a][c]&&b.push(c);return b},getNumOfChunksToAllocate:function(a){a.length||(a=[a]);var b=0,c=this;return a.forEach(function(a){b+=c.peerConnections[a].maxNumOfPendingChunks-c.peerConnections[a].numOfPendingChunks}),b},isPendingEntireBlock:function(a,b){var c=d.core.data.BlockCache.get(a),h=this.p2pPendingChunksInBlock[a]?this.p2pPendingChunksInBlock[a][b]||0:0,k=c.getNumOfChunksSetInBlock(b),
c=c.getNumOfChunksInBlock(b);return d.log("pendingEntireBlock:: pending chunks in block = "+h+" set chunks in block = "+k),d.log("pendingEntireBlock:: sum = "+(h+k)+" / "+c),c>h+k?!1:!0},isPendingChunk:function(a,b){return void 0!==this.p2pPendingChunks[a]&&void 0!==this.p2pPendingChunks[a][b]},isAvailable:function(a){if(!0!==this.resourceState[a])return!1;var b=Date.now();if(!d.core.data.BlockCache.get(a))return!1;for(var c in this.peerConnections)if(this.remoteAvailabilityMaps[a][c]&&this.isPeerAvailable(c))return this.availableTimeStamp=
b,!0;return this.availableTimeStamp=b,!1},isPeerAvailable:function(a){return this.peerConnections[a]&&this.peerConnections[a].numOfPendingChunks<.9*this.peerConnections[a].maxNumOfPendingChunks?!d.core.util.isObjectEmpty(this.peerSwarms[a]):!1},getPeerSwarms:function(a){return Object.keys(this.peerSwarms[a])},getConnectionStats:function(){var a=Object.create(null);for(key in this.peerConnections){var b=this.peerConnections[key];b&&(a[key]=new d.core.protocol.Connection(null,null,null,null,b.numOfExpiredChunks,
b.numOfRequestedChunks,b.minLatencyForChunk,b.ready,b.connectingDuration,b.failure))}for(key in this.droppedConnections)b=this.droppedConnections[key],a[key]=new d.core.protocol.Connection(null,null,null,null,b.numOfExpiredChunks,b.numOfRequestedChunks,b.minLatencyForChunk,b.ready,b.connectingDuration,b.failure);return a},getAvailableNumOfChunksToSend:function(){var a=0,b;for(b in this.peerConnections)a+=this.peerConnections[b].maxNumOfPendingChunks-this.peerConnections[b].numOfPendingChunks;return a},
removeResource:function(a){d.info("removed p2p resource "+a);for(var b in this.pendingRequests)this.pendingRequests[b][1]===a&&(clearTimeout(this.pendingRequests[b][0]),this.expireChunks(this.pendingRequests[b][1],this.pendingRequests[b][2],this.pendingRequests[b][3],b,!0),delete this.pendingRequests[b]);this.sendDontHaveToAll(a);delete this.p2pPendingChunks[a];delete this.p2pPendingChunksInBlock[a];delete this.pendingResources[a];this._super(a)},stopResource:function(a){d.info("stopped p2p resource "+
a);for(var b in this.pendingRequests)this.pendingRequests[b][1]===a&&(clearTimeout(this.pendingRequests[b][0]),this.expireChunks(this.pendingRequests[b][1],this.pendingRequests[b][2],this.pendingRequests[b][3],b,!0),delete this.pendingRequests[b]);delete this.p2pPendingChunks[a];delete this.p2pPendingChunksInBlock[a];delete this.pendingResources[a];this._super(a)},registerEvents:function(){var a=this;this.expireChunks=function(b,g,h,k,l){a.pendingRequests[k]&&delete a.pendingRequests[k];k=[];var p=
0,n=d.core.data.BlockCache.get(b),m=a.peerConnections[h];if(a.p2pPendingChunks[b])for(var q=0;q<g.length;q++){var r=g[q],t=n.getBlockIdOfChunk(r);a.p2pPendingChunks[b][r]&&(d.debug("expiring chunk "+r),delete a.p2pPendingChunks[b][r],a.p2pPendingChunksInBlock[b][t]--,c.removeChunk(b,r),p++,m&&(m.numOfExpiredChunks++,m.numOfPendingChunks--),n.hasChunk(r)||k.push(r))}l||(p==g.length?m&&(m.requestDropped?m.requestDropped++:m.requestDropped=1,m.requestDropped>=d.config.REQUEST_DROPPED_FAIL&&a.closeConnection(h,
!1)):m&&(m.requestDropped=0),m&&d.log("num of requests dropped from "+h+" is "+m.requestDropped),k.length?(m&&(m.maxNumOfPendingChunks=Math.ceil(Math.max(m.maxNumOfPendingChunks/2,m.maxNumOfPendingChunks-2*p)),d.log("expiring chunks, windows decreased to "+m.maxNumOfPendingChunks)),m&&a.isPeerAvailable(h)&&radio("P2PAvailableEvent").broadcast(b,h)):m&&(m.maxNumOfPendingChunks=Math.min(d.config.MAX_PENDING_CHUNKS,m.maxNumOfPendingChunks+1),d.log("no chunks expired, windows increased to "+m.maxNumOfPendingChunks)))};
radio("P2PAvailableEvent").subscribe([function(a,b){this.prefetch(a,b)},this]);radio("blockReceivedEvent").subscribe([function(a,b){a&&this.sendHaveToAll(a)},this]);radio("dataReceivedEvent").subscribe([function(a,b){var c=d.core.protocol.BinaryProtocol.decode(a);if(!this.peerConnections[b])return void d.info("got dataReceivedEvent from peerId "+b+"which was not found in peerConnections");if(this.peerConnections[b].ignore&&c[0].tag!==d.core.protocol.P2P_VERSION)return void d.info("got dataReceivedEvent from peerId "+
b+" which is set to be ignored");for(var e=0;e<c.length;++e){var l=c[e];switch(l.tag){case d.core.protocol.P2P_HAVE:this.peersPerformanceTracker.reportPeerHaveSwarm(b,l.swarmId);this.receiveHaveMessage(l,b);this.isPeerAvailable(b)&&radio("P2PAvailableEvent").broadcast(l.swarmId,b);radio("receivedHaveMessage").broadcast(l,b);break;case d.core.protocol.P2P_HAVE_REQUEST:if(!this.resourceState[l.swarmId])continue;l=this.createHaveMessage(l.swarmId);l=d.core.protocol.BinaryProtocol.encode([l]);this.sendToPeer(b,
l);break;case d.core.protocol.P2P_DONT_HAVE:this.receiveDontHaveMessage(l,b);radio("receivedDontHaveMessage").broadcast(l,b);break;case d.core.protocol.P2P_REQUEST:if(!this.resourceState[l.swarmId])continue;this.receiveRequestMessage(l,b);break;case d.core.protocol.P2P_DATA:if(this.peersPerformanceTracker.reportChunksReceivedFromPeer(b,l.swarmId,{id:l.chunkId,bytes:l.payload.length}),!this.resourceState[l.swarmId])continue;this.receiveDataMessage(l,b);this.isPeerAvailable(b)&&radio("P2PAvailableEvent").broadcast(l.swarmId,
b);break;case d.core.protocol.P2P_CANCEL:break;case d.core.protocol.P2P_VERSION:this.peersPerformanceTracker.reportPeerClientVersion(b,l.client+"_"+l.conf);this.ignoreByVersion(l,b);break;default:d.warn("received a p2p message not in protocol from "+b)}}},this]);radio("connectionIdle").subscribe([function(a){if(!(Object.keys(this.peerConnections).length<d.config.MAX_CONNECTIONS*d.config.PC_IDLE_FACTOR)){var b=!1;d.config.FEATURE_CLOSE_DEAD_CONNECTIONS&&(b=this.closeDeadConnections(a));b||d.config.FEATURE_CLOSE_OVERLAPPING_CONNECTIONS&&
this.closeOverlappingConnections(a)}},this]);radio("connectionReady").subscribe([function(b){if(this.peerConnections[b])d.warn("peerConnection to "+b+" was initialized, but we already have a connection to him");else{this.peerConnections[b]=this.initPeerConnections[b];delete this.initPeerConnections[b];this.sendQueues[b]=d.core.util.taskQueue();var c=15728640-d.config.CHUNK_SIZE;this.sendQueues[b].canrun=function(){var a=this.peerConnections[b];if(void 0===a)throw Error("peerConnection is undefined");
if(!1===a.ready)throw Error("peerConnection isnt ready");return a.getBufferedAmount()>c?!1:!0}.bind(this);a.peersPerformanceTracker.reportPeerConnected(b);radio("activePeerConnectionsNumberChanged").broadcast(Object.keys(this.peerConnections).length)}this.peerSwarms[b]=Object.create(null);this.sendVersionToNewConnection(b);this.sendHaveToNewConnection(b)},this]);radio("connectionFailed").subscribe([function(a){d.warn("onConnectionFailed: closing connection with "+a);var b=this.peerConnections[a]||
this.initPeerConnections[a]||this.deletedPeerConnections[a];if(this.closeConnection(a,!1),this.peerSwarms[a]&&delete this.peerSwarms[a],delete this.deletedPeerConnections[a],b&&b.forceClosed)return void delete this.attemptedConnections[a];if(b&&b.initiator){if("exponential"===d.config.PC_RECON_METHOD)b=1E3*Math.pow(d.config.PC_RECON_EXP_COEF,this.attemptedConnections[a]-1);else{if("single"!==d.config.PC_RECON_METHOD||1<this.attemptedConnections[a])return;b=d.config.PC_RECON_DELAY||1E4}d.debug("delay for reconnecting with "+
a+" = "+b);setTimeout(this.ensurePeerConnectionInitialized.bind(this),b,a,!0)}},this]);radio("receivedGroupMatchEvent").subscribe([function(a){d.info("peer "+this.clientId+" receivedMatch with peer "+a.peerIds);a.peerIds.forEach(function(a){void 0===this.attemptedConnections[a]&&this.ensurePeerConnectionInitialized(a,!0)},this)},this]);radio("receivedSDP").subscribe([function(a){this.ensurePeerConnectionInitialized(a.originId,!1);this.initPeerConnections[a.originId]?this.initPeerConnections[a.originId].handleMessage(a):
d.log("receivedSDP: this.initPeerConnections ["+a.originId+" ] undefined")},this]);radio("receivedGroupSDP").subscribe([function(a){a.sdp.forEach(function(b){radio("receivedSDP").broadcast({originId:a.originId,destId:a.destId,sdpMessage:b})},this)},this]);radio("transferLoadedEvent").subscribe([function(a){delete this.pendingResources[a.swarmId]},this])},prefetch:function(a,b){if(this.prefetchFlag[a]&&!0===this.resourceState[a]){var c=this.download(a,b);c&&0!==c||this.prefetchPendingResources(a,b)}},
prefetchPendingResources:function(a,b){for(var c in this.pendingResources)if(c!==a&&this.prefetchFlag[c]&&void 0!==this.remoteAvailabilityMaps[c][b]&&0<this.download(c,b))break},addResourceAsPending:function(a){if(this.prefetchFlag[a]){var b=d.core.data.BlockCache.get(a);b&&b.isFull()||(this.pendingResources[a]=!0)}},getSwarmPeersCount:function(a){return(a=this.remoteAvailabilityMaps[a])?Object.keys(a).length:0},receiveRequestMessage:function(a,b){d.log("received a request for "+a.chunkIds.length+
" chunks");this.sendData(a.swarmId,b,a.chunkIds,0,0);radio("requestChunks").broadcast(a.swarmId,b,a.chunkIds)},receiveDataMessage:function(a,b){this.receiveP2PChunk(a.swarmId,b,a.chunkId,a.payload)},configureBrowserSpecific:function(){window.mozRTCPeerConnection?(this.peerConnectionImpl=d.core.transport.PeerConnectionImpl,d.config.MAX_PENDING_CHUNKS=d.config.MOZ_MAX_PENDING_CHUNKS):window.webkitRTCPeerConnection&&(this.peerConnectionImpl=d.core.transport.PeerConnectionImpl)},distributeChunksAmongSources:function(a,
b,c){if(!this.remoteAvailabilityMaps[a]||0===b.length)return 0;var h=this;c=(d.debug("chunks to distribute "+b.length),c)?[c]:Object.keys(this.remoteAvailabilityMaps[a]).filter(function(a){return"undefined"!=typeof h.peerConnections[a]&&!h.peerConnections[a].isFull()}).sort(function(a,b){return h.peerConnections[a].numOfPendingChunks>h.peerConnections[b].numOfPendingChunks});for(var k,l=Object.create(null),p=0,n=0;n<b.length;++n)for(var m=b[n],q=Math.floor(m/(d.config.BLOCK_SIZE/d.config.CHUNK_SIZE)),
r=0;r<c.length;++r)if(k=d.config.PC_ALLOCATE_CHUNKS_EVENLY?c[(r+n)%c.length]:c[r],this.remoteAvailabilityMaps[a][k]&&this.remoteAvailabilityMaps[a][k].has(q)&&!this.peerConnections[k].isFull()){l[k]||(l[k]=[]);l[k].push(m);p++;this.peerConnections[k].numOfPendingChunks++;break}for(n=0;n<c.length;++n)l[c[n]]&&(k=c[n],b=l[k],this.addToPendingChunks(a,b,k),this.peerConnections[k].numOfRequestedChunks+=b.length,m=new d.core.protocol.Request(a,b),m=d.core.protocol.BinaryProtocol.encode([m]),d.log("sending request for "+
b.length+" chunks"),this.peersPerformanceTracker.reportChunksRequestFromPeer(a,b),this.sendToPeer(k,m));return p},sendToAll:function(a){a=d.core.protocol.BinaryProtocol.encode([a]);for(var b in this.peerConnections){var c=this.peerConnections[b];c&&c.ready&&!c.ignore&&this.sendToPeer(b,a)}},ensurePeerConnectionInitialized:function(a,c){if(!(this.peersBlacklist[a]||this.peerConnections[a]||this.initPeerConnections[a]||d.config.MAX_CONNECTIONS&&Object.keys(this.peerConnections).length>=d.config.MAX_CONNECTIONS||
"chrome"===d.browserName&&d.config.MAX_PC_CREATE&&this.numberOfPCCreated>=d.config.MAX_PC_CREATE)){if("firefox"===d.browserName&&0>=b.length)return void this.allocateMorePC();this.attemptedConnections[a]=this.attemptedConnections[a]+1||1;this.initPeerConnections[a]=new this.peerConnectionImpl(this.clientId,a,c,b.shift());this.initPeerConnections[a].ignore=!0;this.increaseCreatedPCCount();b.length<d.config.PC_POOL_LOW&&this.allocateMorePC();c&&this.initPeerConnections[a].setupCall()}},increaseCreatedPCCount:function(){this.numberOfPCCreated++;
"chrome"===d.browserName&&d.config.MAX_PC_CREATE&&radio("availablePeerConnectionsNumberChanged").broadcast(d.config.MAX_PC_CREATE-this.numberOfPCCreated)},sendData:function(a,b,c,h,k){if(this.canUpload(a)&&!(d.config.EMULATE_LOSS&&Math.random()<d.config.EMULATE_LOSS_PERCENTAGE)){var l=c[h];h++;var p=this;d.core.data.BlockCache.get(a).getChunk(l,function(n,m){k+=m.length;var q=new d.core.protocol.Data(a,l,m),q=d.core.protocol.BinaryProtocol.encode([q]);p.sendToPeer(b,q);h<c.length?p.sendData(a,b,c,
h,k):(p.peersPerformanceTracker.reportUploadToPeer(b,k),radio("chunkSentEvent").broadcast(a,k))})}},sendHaveToNewConnection:function(a){var b,c,h=[],k=this;d.core.data.BlockCache.forEach(function(a,d){var e=d.metadata;e&&k.resourceState[e.swarmId]&&(b=e.swarmId,c=k.createHaveMessage(b),h.push(c))});for(var l=d.config.CHUNK_SIZE/76,l=Math.floor(.9*l),p=[],n=0,m=h.length;m>n;n+=l)p=h.slice(n,n+l),p=d.core.protocol.BinaryProtocol.encode(p),this.sendToPeer(a,p)},sendVersionToNewConnection:function(a){var b=
new d.core.protocol.Version("0.53.29",d.config.VERSION),b=d.core.protocol.BinaryProtocol.encode([b]);this.sendToPeer(a,b)},receiveHaveMessage:function(a,b){var c=a.swarmId,h=this.remoteAvailabilityMaps[c];if(!h)return this.remoteHave[c]=this.remoteHave[c]||{},void(this.remoteHave[c][b]=a);if(!h[b]){d.info("got a have message from a peer with a non initialized availabilityMap");var k=d.core.data.BlockCache.get(a.swarmId);if(!k)return;h[b]=new d.core.dataStructures.AvailabilityMap(k.getNumOfBlocks())}a.availabilityMap?
h[b].deserializeAndCopy(a.availabilityMap):a.seeder?h[b].setSeeder():h[b].deserializeAndUpdate(a.blockIds);this.peerSwarms[b]||(this.peerSwarms[b]=Object.create(null));this.peerSwarms[b][c]=!0},receiveDontHaveMessage:function(a,b){var c=a.swarmId;return!this.remoteAvailabilityMaps[c]&&this.remoteHave[c]&&this.remoteHave[c][b]?void delete this.remoteHave[c][b]:this.remoteAvailabilityMaps[c]&&this.remoteAvailabilityMaps[c][b]?void delete this.remoteAvailabilityMaps[c][b]:void 0},sendHaveRequestToAll:function(a){a=
new d.core.protocol.HaveRequest(a);this.sendToAll(a)},sendHaveToAll:function(a){a=this.createHaveMessage(a);this.sendToAll(a)},sendDontHaveToAll:function(a){a=this.createDontHaveMessage(a);this.sendToAll(a)},loadCachedHaveRequests:function(a){void 0!==this.remoteHave[a]&&Object.keys(this.remoteHave[a]).forEach(function(b){this.receiveHaveMessage(this.remoteHave[a][b],b)}.bind(this))},receiveP2PChunk:function(a,b,g,h){d.debug("receiving chunk "+g);var k=d.core.data.BlockCache.get(a);(k.hasChunk(g)?
(d.log("DOH! I already got chunk: "+g+"!"),radio("peer5_waste_p2p_chunk").broadcast(a,h.length,g)):(radio("peer5_new_p2p_chunk").broadcast(a,h.length,g),this.addChunk(a,h,g)),this.p2pPendingChunks[a]&&this.p2pPendingChunks[a][g])?(h=Date.now()-this.p2pPendingChunks[a][g],b=this.peerConnections[b],b.minLatencyForChunk?(b.minLatencyForChunk=Math.min(b.minLatencyForChunk,h),b.maxLatencyForChunk=Math.max(b.maxLatencyForChunk,h),b.avgLatencyForChunk=(b.avgLatencyForChunk*b.numOfChunksArrived+h)/(1+b.numOfChunksArrived)):
(b.minLatencyForChunk=h,b.maxLatencyForChunk=h,b.avgLatencyForChunk=h),b.numOfChunksArrived++,b.numOfPendingChunks--,delete this.p2pPendingChunks[a][g],k=k.getBlockIdOfChunk(g),this.p2pPendingChunksInBlock[a][k]--,c.removeChunk(a,g)):d.log("we already expired chunk: "+g)},addToPendingChunks:function(a,b,g){if(!this.p2pPendingChunks[a])return void d.warn("adding pending chunks to a non existing swarm with id: "+a);for(var h=this.peerConnections[g],h=h.avgLatencyForChunk&&h.numOfChunksArrived>5*h.maxNumOfPendingChunks?
(d.config.CHUNK_EXPIRATION_TIMEOUT+2*h.avgLatencyForChunk)/2:d.config.CHUNK_EXPIRATION_TIMEOUT,k=d.core.data.BlockCache.get(a),l=0;l<b.length;++l){var p=b[l],n=k.getBlockIdOfChunk(p);this.p2pPendingChunks[a][p]=Date.now();this.p2pPendingChunksInBlock[a][n]?this.p2pPendingChunksInBlock[a][n]++:this.p2pPendingChunksInBlock[a][n]=1;c.addChunk(a,p);radio("peer5_p2p_pending_chunk").broadcast(p,a,g)}0!=b.length&&(this.requestNum++,h=setTimeout(this.expireChunks,h,a,b,g,this.requestNum),this.pendingRequests[this.requestNum]=
[h,a,b,g])},restoreConnection:function(a){!this.peerConnections[a]&&this.droppedConnections[a]&&(d.warn("connection with "+a+" was restored"),this.peerConnections[a]=this.droppedConnections[a],this.peerConnections[a].ready=!0,delete this.droppedConnections[a],this.sendHaveToNewConnection(a))},createHaveMessage:function(a){var b=d.core.data.BlockCache.get(a);if(b){var c=d.clientInstance.resources[a]?d.clientInstance.resources[a].hashUrl:null;return b.isFull()?new d.core.protocol.Have(a,!0,null,null,
c):new d.core.protocol.Have(a,!1,b.getSerializedMap(),null,c)}},createDontHaveMessage:function(a){return new d.core.protocol.DontHave(a,d.clientInstance.resources[a]?d.clientInstance.resources[a].hashUrl:null)},closeDeadConnections:function(a){var b=(Date.now()-a.peerData.lastHaveReportTimestamp)/1E3,c=this.peerConnections[a.peerId];return b>d.config.SECONDS_SINCE_LAST_HAVE&&c&&c.initiator?(this.closeConnection(a.peerId,d.config.FEATURE_CLOSE_DEAD_CONNECTIONS_PERMANENTLY),c.forceClosed=!0,!0):!1},
closeOverlappingConnections:function(a){var b=this.peerConnections[a.peerId];a.peerData.lastSwarmReportedAsHave===this.lastSwarmDownloaded.swarmId&&b&&b.initiator&&(this.closeConnection(a.peerId,d.config.FEATURE_CLOSE_OVERLAPPING_CONNECTIONS_PERMANENTLY),b.forceClosed=!0)},closeConnection:function(a,b,c){d.warn("closing connection with "+a);(c=this.peerConnections[a]||this.initPeerConnections[a])&&(this.closePC(c),this.deletePeerConnection(a));b&&(this.peersBlacklist[a]=!0)},deletePeerConnection:function(a){this.deletedPeerConnections[a]=
this.deletedPeerConnections[a]||this.peerConnections[a]||this.initPeerConnections[a];delete this.peerConnections[a];delete this.initPeerConnections[a];void 0!==this.sendQueues[a]&&(this.sendQueues[a].reset(),delete this.sendQueues[a]);radio("activePeerConnectionsNumberChanged").broadcast(Object.keys(this.peerConnections).length);this.peersPerformanceTracker.reportPeerDisconnected(a)},canUpload:function(a){return!0},sendToPeer:function(a,b){var c=this;this.sendQueues[a].push(function(){c.peerConnections[a].send(b)})},
allocateMorePC:function(){if(!this.allocatingPC){this.allocatingPC=!0;var a=0,c=setInterval(function(){d.info("creating peerConnection for pool");b.push(d.core.transport.PeerConnectionImpl.createPeerConnection());a++;a>d.config.PC_POOL_SIZE&&(clearInterval(c),this.allocatingPC=!1)}.bind(this),d.config.PC_POOL_REGEN_INTERVAL)}},ignoreByVersion:function(a,b){return d.core.util.validateVersion(a.client)&&d.core.util.validateVersion(a.conf)?a.conf!==d.config.VERSION?(d.warn("Connected to a client with a non matching configuration version"),
void this.closeConnection(b,!0)):0!==d.core.util.compareMajorVersionNumbers("0.53.29",a.client)?(d.warn("Connected to a client with a non matching client major version"),void this.closeConnection(b,!0)):void(this.peerConnections[b].ignore=!1):(d.warn("Connected to a client with an invalid version"),void this.closeConnection(b,!0))},initClosePCQueue:function(){this.pcCloseQueue=d.core.util.taskQueue();var a=0;this.pcCloseQueue.canrun=function(){var b=Date.now()-a,b=d.config.PC_CLOSE_TIMEOUT-b;return 0>
b?!0:b};this.closePC=function(b){this.pcCloseQueue.push(function(){a=Date.now();b&&b.close&&b.close()})}}})})();(function(){var c=d.config.XHR_INITIAL_TIMEOUT;d.client.HTTPDownloader=Object.subClass({name:"peer5.client.HTTPDownloader",ctor:function(b){if(this.url=b,this.httpRequestTime=0,this.firstRequest=!0,this.lastTimerTimestamp=null,this.xhr=window._XMLHttpRequest?new _XMLHttpRequest:new XMLHttpRequest,!this.xhr)throw"Cannot instantiate XHR";this.registerEvents()},isHTTPBusy:function(){return this.xhr.busy},
cleanHTTP:function(){this.xhr.busy=!1;this.httpRequestTime=0},isHTTPOld:function(){return 0<this.httpRequestTime&&this.httpRequestTime+c<Date.now()},stop:function(){d.info("aborting XHR:"+this.url+" loaded so far "+this.xhr.lastTotalLoaded);this.xhr.abort();this.cleanHTTP();clearTimeout(this.timerId)},head:function(){this.xhr.url=this.url;d.feature.isEnabledAndInitialized(d.config.FEATURE_PROXY_HEAD_KEY)?this.xhr.open("HEAD",d.config.FEATURE_PROXY_HEAD_URL_PREFIX+encodeURIComponent(this.url).replace(/'/g,
"%27").replace(/"/g,"%22")):this.xhr.open("HEAD",this.url);this.xhr.busy=!0;var b=this;this.xhr.onload=function(a){this.busy=!1;a=this.getAllResponseHeaders();200===this.status||206===this.status?radio("responseHeadersReceived"+this.url).broadcast(a):(-1<a.indexOf("X-Peer5-Proxy")&&404!==this.status&&d.feature.disable(d.config.FEATURE_PROXY_HEAD_KEY),d.warn("Expecting status code 200/206 from HEAD request. Got "+this.status),radio("xhrFailed"+this.url).broadcast(this));b.stop()};this.xhr.onerror=
function(a){this.busy=!1;radio("xhrFailed"+this.url).broadcast(this)};this.xhr.lastModified=Date.now();this.resetTimer(this.xhr.lastModified);this.xhr.send(null)},resetTimer:function(b){if(this.timerId&&(clearTimeout(this.timerId),d.debug("resetTimer clearTimeout of "+this.timerId)),this.lastTimerTimestamp){var a=Date.now()-this.lastTimerTimestamp;c=Math.round(Math.max(d.config.XHR_MINIMUM_TIMEOUT,(c+d.config.XHR_TIMEOUT_FACTOR*a)/2))}this.timerId=setTimeout(this.expireRequest,c,b);this.lastTimerTimestamp=
Date.now();d.debug("resetTimer setTimeout returned "+this.timerId)},download:function(b,a,e){d.info("Downloading in http "+this.url+" start="+b+" end="+a);d.debug(b+" - "+a);var f=this;this.httpRequestTime=Date.now();this.xhr.lastModified=this.httpRequestTime;this.xhr.url=this.url;try{this.xhr.open("GET",this.url,!0)}catch(g){return this.xhr.busy=!1,d.warn("xhr onerror!"),void radio("xhrFailed"+this.xhr.url).broadcast(this.xhr)}this.xhr.busy=!0;a?this.xhr.setRequestHeader("Range","bytes="+b+"-"+a):
b&&0<b?this.xhr.setRequestHeader("Range","bytes="+b+"-"):b=0;this.xhr.startRange=b;this.xhr.endRange=a;(!this.xhr.lastTotalLoaded||b>this.xhr.lastTotalLoaded||a<this.xhr.lastTotalLoaded)&&(this.xhr.lastTotalLoaded=b);this.xhr.onloadend=function(a){d.debug("xhr onloadend start: "+this.startRange+" end: "+this.endRange)};this.xhr.onabort=function(a){d.debug("xhr onabort")};this.xhr.onerror=function(a){this.busy=!1;d.warn("xhr onerror!");radio("xhrFailed"+this.url).broadcast(this)};this.xhr.onreadystatechange=
function(a){this.readyState===this.HEADERS_RECEIVED&&(f.resetTimer(this.lastModified),this.onreadystatechange=null,200<=this.status&&300>this.status)&&(d.log("received headers: "+this.url),a=this.getAllResponseHeaders(),radio("responseHeadersReceived"+this.url).broadcast(a))};this.xhr.responseType="arraybuffer";this.xhr.onload=function(a){d.log("onload xhr");this.busy=!1;f.httpRequestTime=0;300>this.status&&200<=this.status&&this.response?(d.info("xhr onload: "+this.url+"start= "+this.start+"end= "+
this.end),radio("bytesReceivedEvent"+this.url).broadcast({url:this.url,offset:this.startRange,dataArray:new Uint8Array(this.response)})):(d.warn("could not determine file size from HTTP"),radio("xhrFailed"+this.url).broadcast(this))};this.xhr.onprogress=function(a){var b=Date.now()-this.lastModified;b>c/2&&d.info("onprogress last part arrived in "+b+"ms");this.lastModified=Date.now();f.resetTimer(this.lastModified);b=a.loaded+a.target.startRange-a.target.lastTotalLoaded;d.debug("onprogress size"+
b);0<b&&(radio("xhrBytesReceived"+this.url).broadcast(this.url,b),a.target.lastTotalLoaded=a.loaded+a.target.startRange,radio("onprogressEvent "+this.url).broadcast());d.debug("HTTPDownloader::xhr.onprogress",a.loaded)};d.debug("before sending xhr start: "+b+" end: "+a);this.resetTimer(this.xhr.lastModified);try{this.xhr.send(null)}catch(g){console.log("xhr native error")}d.debug("after sending xhr start: "+b+" end: "+a)},registerEvents:function(){var b=this;this.expireRequest=function(a){b.xhr.lastModified==
a&&(d.warn("expiring xhr requested on: "+a),c=Math.round(Math.min(d.config.XHR_MAXIMUM_TIMEOUT,2*c)),b.stop(),b.xhr.busy=!1,radio("xhrTimeout"+b.url).broadcast(b.xhr))}}})})();(function(){d.client.MultiSlotManager=Object.subClass({name:"peer5.client.MultiSlotManager",ctor:function(c){this.url=c;this.xhrs=[];this.rampup=!0;this.createNewSlot(this.url);this.firstRequest=!0;window.setInterval(this.cron,d.config.XHR_SLOT_PROBE_INTERVAL,this)},createNewSlot:function(c){var b=2<=d.config.XHR_CONCURRENT?
-1<c.indexOf("?")?"&":"?":"#",a=d.core.util.generate_uuid();c=c+b+a;b=new d.client.HTTPDownloader(c);this.xhrs.push(b);d.info("created new slot "+c);this.registerNewSlotEvents(c)},isHTTPBusy:function(){for(var c=0;c<this.xhrs.length;++c)if(!this.xhrs[c].isHTTPBusy())return!1;return!0},isHTTPOld:function(){for(var c=0;c<this.xhrs.length;++c)if(!this.xhrs[c].isHTTPOld())return!1;return!0},download:function(c,b,a){for(var e,f=0;f<this.xhrs.length;++f)if(!this.xhrs[f].isHTTPBusy()){e=this.xhrs[f];break}d.debug("downloading "+
this.url+" "+c+":"+b);e.download(c,b,a);this.isHTTPBusy()||radio("HTTPAvailableEvent").broadcast(this.url)},stop:function(){for(var c=0;c<this.xhrs.length;++c)this.xhrs[c].stop()},registerNewSlotEvents:function(c){radio("bytesReceivedEvent"+c).subscribe([function(a){d.debug("finished xhr: "+this.url+" "+a.offset);this.firstRequest=!1;a.url=this.url;radio("bytesReceivedEvent").broadcast(a)},this]);radio("xhrFailed"+c).subscribe([function(a){d.debug("expiring xhr: "+this.url+" "+a.startRange+":"+a.endRange);
this.xhrs[0].url===c&&this.firstRequest&&radio("removeResource"+c).broadcast(c,a.status,"First xhr failed");this.rampup=!1;for(var b=0;b<this.xhrs.length;++b)if(this.xhrs[b].url===c){this.xhrs.splice(b,1)[0].stop();d.info("removed slot "+c);break}radio("xhrFailed"+this.url).broadcast(a)},this]);radio("xhrTimeout"+c).subscribe([function(a){radio("xhrFailed"+this.url).broadcast(a)},this]);radio("xhrBytesReceived"+c).subscribe([function(a,b){radio("xhrBytesReceived").broadcast(this.url,b)},this]);var b=
!1;radio("onprogressEvent "+c).subscribe([function(){!b&&this.rampup&&this.xhrs.length<d.config.XHR_CONCURRENT&&(this.createNewSlot(this.url),b=!0,radio("HTTPAvailableEvent").broadcast(this.url));radio("httpProgressEvent"+this.url).broadcast()},this])},cron:function(c){c.xhrs.length<d.config.XHR_CONCURRENT&&(c.createNewSlot(c.url),radio("HTTPAvailableEvent").broadcast(this.url))}})})();(function(c){c.FailedUrls=function(){var b=Object.create(null);return{addUrl:function(a){b[a]=!0},contains:function(a){return b[a]?
!0:!1}}}()})(d.client);(function(){var c=d.core.dataStructures.PendingBlockMap;d.client.HTTPController=d.core.controllers.AbstractController.subClass({ctor:function(){this._super();this.downloadedBytes=0;this.lastFailedStartBlock=Object.create(null);this.xhrs=Object.create(null);this.resourceState=Object.create(null);this.registerEvents()},isAvailable:function(b){return!0!==this.resourceState[b]?!1:!this.xhrs[b].isHTTPBusy()},removeResource:function(b){d.info("removed http resource "+b);this.stop(b);
this._super(b)},stopResource:function(b){d.info("stopped http resource "+b);this.stop(b);this._super(b)},init:function(b,a){if(d.log("initiating HTTPController: "+b),this._super(b,a),!this.xhrs[b]){var e=new d.client.MultiSlotManager(b);radio("xhrFailed"+b).subscribe([function(a){var e=a.startRange;a=a.endRange;if(!a){a=d.core.data.BlockCache.get(b);if(!a)return;a=a.fileSize}a=Math.ceil((a+1)/d.config.CHUNK_SIZE)-1;for(var h=e/d.config.CHUNK_SIZE;a>=h;h++)c.removeChunk(b,h);this.lastFailedStartBlock[b]=
e/d.config.BLOCK_SIZE;!0===this.resourceState[b]&&radio("HTTPAvailableEvent").broadcast(b)},this]);this.xhrs[b]=e}},download:function(b,a,e){if(this.isAvailable(b)){var f=d.core.data.BlockCache.get(b);this.xhrs[b]||(this.xhrs[b]=new d.client.HTTPDownloader(b));var g=this.xhrs[b];if(g.isHTTPBusy())return g.isHTTPOld()?(d.warn("http timeout"),this.stop(),0):(d.debug("http busy"),0);!this.lastFailedStartBlock[b]||f.has(this.lastFailedStartBlock[b])||c.isBlockPending(b,this.lastFailedStartBlock[b])||
(a=this.lastFailedStartBlock[b],e=this.lastFailedStartBlock[b]);for(var h=e-a+1,k=a;e>=k;k++){var l=f.getChunkIdsOfBlock(k),p;for(p in l)c.addChunk(b,l[p]),radio("peer5_pending_http_chunk").broadcast(l[p],b,"#000000",2)}d.log("requesting "+h+" blocks in HTTP");b=d.config.BLOCK_SIZE*a;a=Math.min(d.config.BLOCK_SIZE*(e+1)-1,f.fileSize-1);a=d.config.BLOCK_SIZE*(e+1)-1;return a>=f.fileSize-1&&(a=null),g.download(b,a,!1),h}},getConnectionStats:function(){},validateFileSize:function(b,a){if(b>a)return!1;
var c=b%d.config.BLOCK_SIZE;return 0===c?!0:c===a%d.config.BLOCK_SIZE?!0:!1},addHTTPBytesToBlocks:function(b,a,e){var f=d.core.data.BlockCache.get(b);if(!f)return void d.warn("addHTTPBytesToChunks - downloaded http for a resource that doesnt exist "+b);var g=e.length;if(!this.validateFileSize(g+a,f.fileSize))return d.error("XHR response length isnt as expected "+b),radio("removeResource").broadcast(b,d.Request.INVALID_RESPONSELENGTH,"XHR response length isnt as expected"),void d.client.FailedUrls.addUrl(b);
for(var h,k,l=0;g>l;){h=l+d.config.BLOCK_SIZE<=g?e.subarray(l,l+d.config.BLOCK_SIZE):e.subarray(l);k=Math.floor((a+l)/d.config.BLOCK_SIZE);var p=f.getNumOfBytesSetInBlock(k);0<p&&(d.log("DOH, got bytes for completed chunks"),radio("peer5_waste_http_chunk").broadcast(b,p));0<e.length-p&&radio("peer5_received_http_block").broadcast(k,b,h.length);c.removeBlock(b,k);this.addBlock(b,h,k);l+=h.length}},registerEvents:function(){radio("bytesReceivedEvent").subscribe([function(b){this.addHTTPBytesToBlocks(b.url,
b.offset,b.dataArray);var a=d.core.data.BlockCache.get(b.url);a&&(a.isFull()&&this.stop(b.url),radio("HTTPAvailableEvent").broadcast(b.url))},this])},stop:function(b){var a=this.xhrs[b];a&&(a.stop(),c.removeResource(b))}})})();(function(){var c=d.core.dataStructures.PendingBlockMap,b=d.core.util.UrlSwarmIdMap;d.client.HybridController=d.core.controllers.AbstractController.subClass({ctor:function(a){this.P2PController=new d.core.controllers.P2PController(a);this.httpController=new d.client.HTTPController;
this.urgent=Object.create(null);this.prefetch=Object.create(null);this.resourceState=Object.create(null);this.registerEvents();this.lastBlockRequestedInP2P},registerEvents:function(){radio("P2PAvailableEvent").subscribe([function(a,b){d.log("P2PAvailableEvent");var c=d.core.data.BlockCache.get(a);if(c&&(c=c.getMetadata().url,2!==this.resourceState[a]&&3!==this.resourceState[c])){if(this.prefetch[c])var g=d.config.SEQUENTIAL_DOWNLOAD?this.relaxedP2PDownload(c,null,null,b):this.relaxedP2PDownloadRandomly(c,
null,null,b);!g||0===g.length}},this]);radio("HTTPAvailableEvent").subscribe([function(a){if(d.debug("http available"),this.httpController.isAvailable(a)&&this.prefetch[a]){if(d.core.data.BlockCache.get(a).isFull())return d.info("HTTP Available but already have everything"),void this.httpController.stop(a);0===(d.config.SEQUENTIAL_DOWNLOAD?this.relaxedHTTPDownload(a):this.relaxedHTTPDownloadRandomly(a))&&(this.urgent[a]=!0,d.config.SEQUENTIAL_DOWNLOAD?this.aggressiveHTTPDownload(a):this.aggressiveHTTPDownloadRandomly(a))}},
this])},removeResource:function(a){this.resourceState[a]=!1;var c=b.getSwarmId(a);c?this.P2PController.removeResource(c):d.info("not removing p2p resource "+a+" - no swarmId");this.httpController.removeResource(a);delete this.resourceState[a]},stopResource:function(a){this.resourceState[a]="stop";var c=b.getSwarmId(a);c?this.P2PController.stopResource(c):d.info("not stopping p2p resource "+a+" -  no swarmId");this.httpController.stopResource(a)},download:function(a,c,f,g){if(this.isAvailable(a)){var h=
d.core.data.BlockCache.get(a);if(!h.isFull()){if(c||(c=h.getMissingBlock()),f||(f=h.getNumOfBlocks()-1),g||(g=d.config.HYBRID_REQUEST_THRESHOLD),g>d.config.HYBRID_REQUEST_THRESHOLD&&(this.urgent[a]=!1),c>h.getNumOfBlocks()-1||f>h.getNumOfBlocks()-1)return void d.warn("out of range");var k=c;c=h.getMissingBlock();c>k&&radio("blockReceivedEvent").broadcast(a,d.config.BLOCK_SIZE);(g<d.config.HTTP_REQUEST_THRESHOLD||this.urgent[a]||3===this.resourceState[a])&&(g<d.config.HTTP_REQUEST_THRESHOLD&&(this.urgent[a]=
!0),d.debug("urgency is: "+g+" downloading from HTTP"),d.config.SEQUENTIAL_DOWNLOAD?this.aggressiveHTTPDownload(a,c,f):this.aggressiveHTTPDownloadRandomly(a,c,f));(d.config.P2P_ALWAYS_DOWNLOAD||g>=d.config.P2P_REQUEST_BEGIN_THRESHOLD&&g<d.config.P2P_REQUEST_END_THRESHOLD&&this.P2PController.isAvailable(b.getSwarmId(a)))&&(d.debug("urgency is: "+g+" downloading from P2P"),d.config.SEQUENTIAL_DOWNLOAD?this.relaxedP2PDownload(a,c,f):this.relaxedP2PDownloadRandomly(a,c,f));(d.config.HTTP_ALWAYS_DOWNLOAD||
g>=d.config.HTTP_REQUEST_THRESHOLD&&g<=d.config.HYBRID_REQUEST_THRESHOLD&&this.httpController.isAvailable(a))&&(d.config.SEQUENTIAL_DOWNLOAD?this.relaxedHTTPDownload(a,c,f):this.relaxedHTTPDownloadRandomly(a,c,f))}}},relaxedHTTPDownload:function(a,e,f){var g=d.core.data.BlockCache.get(a);e||(e=g.getFirstMissingBlock());f||(f=g.getNumOfBlocks()-1);var h=this.getSeqBlocks(a,d.config.XHR_MAX_GET,function(d){return d>=e&&f>=d&&g.isEmpty(d)&&!c.isBlockPending(a,d)&&!c.isBlockPending(b.getSwarmId(a),d)});
return 0===h.length?0:(this.httpController.download(a,h[0],h[h.length-1]),h[h.length-1]-h[0]+1)},aggressiveHTTPDownload:function(a,b,f){var g=d.core.data.BlockCache.get(a);b||(b=g.getFirstMissingBlock());f||(f=g.getNumOfBlocks()-1);g=this.getSeqBlocks(a,d.config.XHR_MAX_GET,function(d){return d>=b&&f>=d&&!c.isBlockPending(a,d)});return 0===g.length?0:(this.httpController.download(a,g[0],g[g.length-1]),g[g.length-1]-g[0]+1)},relaxedHTTPDownloadRandomly:function(a,e,f){var g=d.core.data.BlockCache.get(a);
e||(e=g.getFirstMissingBlock());f||(f=g.getNumOfBlocks()-1);var h=this.getRarestBlocks(a,d.config.XHR_MAX_GET,function(d){return d>=e&&f>=d&&g.isEmpty(d)&&!c.isBlockPending(a,d)&&!c.isBlockPending(b.getSwarmId(a),d)});return e=h[0],f=h[h.length-1],0<h.length&&this.httpController.download(a,e,f),h.length},aggressiveHTTPDownloadRandomly:function(a,b,f){var g=d.core.data.BlockCache.get(a);b||(b=g.getFirstMissingBlock());f||(f=g.getNumOfBlocks()-1);var h=this.getRarestBlocks(a,d.config.XHR_MAX_GET,function(d){return d>=
b&&f>=d&&!g.has(d)&&!c.isBlockPending(a,d)});b=h[0];f=h[h.length-1];return 0<h.length&&this.httpController.download(a,b,f),h.length},relaxedP2PDownload:function(a,e,f,g){var h=d.core.data.BlockCache.get(a),k=b.getSwarmId(a);if(this.P2PController.isAvailable(k)){if(e||(e=h.getFirstMissingBlock()),f||(f=h.getNumOfBlocks()-1),e>h.getNumOfBlocks()-1||f>h.getNumOfBlocks()-1)return void d.warn("out of range");var l=e;e=this.lastBlockRequestedInP2P&&!h.has(this.lastBlockRequestedInP2P)?this.lastBlockRequestedInP2P:
h.getFirstMissingBlock();for(e>l&&radio("blockReceivedEvent").broadcast(a,d.config.BLOCK_SIZE);f>=e&&(c.isBlockPending(a,e)||this.P2PController.isPendingEntireBlock(k,e));)e++;for(var l=[],p=e;f>=p&&p<h.getNumOfBlocks()&&l.length<this.P2PController.getAvailableNumOfChunksToSend();++p)if(!c.isBlockPending(a,p)&&!this.P2PController.isPendingEntireBlock(k,p)){e=h.getChunkIdsOfBlock(p);for(var n=0;n<e.length;++n)h.hasChunk(e[n])||this.P2PController.isPendingChunk(k,e[n])||l.push(e[n]);this.lastBlockRequestedInP2P=
p}return this.P2PController.distributeChunksAmongSources(k,l,g),l.length}},relaxedP2PDownloadRandomly:function(a,e,f,g){var h=d.core.data.BlockCache.get(a);if(!h)return 0;e||(e=h.getFirstMissingBlock());f||(f=h.getNumOfBlocks()-1);var k=b.getSwarmId(a),l=this;return this.P2PController.download(k,g,function(b){return b>=e&&f>=b&&!h.has(b)&&!c.isBlockPending(a,b)&&!l.P2PController.isPendingEntireBlock(k,b)})},init:function(a,b,c){if(d.info("initiating resource controllers: url="+a.url+" swarmId="+a.swarmId+
" mod="+c),1==c){if(this.resourceState[a.url])return this.resourceState[a.url]=!0,this.prefetch[a.url]=b,this.httpController.init(a.url,!0),void this.P2PController.init(a.swarmId,!1,!0);this.resourceState[a.url]=c;this.prefetch[a.url]=b;this.httpController.init(a.url);this.P2PController.init(a.swarmId,!1);this.prefetch&&(this.urgent[a.url]=!1)}else if(2==c){if(this.resourceState[a.swarmId])return this.P2PController.init(a.swarmId,!0,!0),void(a.url&&(this.resourceState[a.url]=c));this.resourceState[a.swarmId]=
c;this.P2PController.init(a.swarmId,!0);this.prefetch&&(this.urgent[a.swarmId]=!1);a.url&&(this.prefetch[a.url]=!1)}else if(3==c){if(this.resourceState[a.url])return this.resourceState[a.url]=c,this.httpController.init(a.url,!0),this.prefetch[a.url]=b,this.P2PController.init(a.swarmId,!1),void this.P2PController.stopResource(a.swarmId);this.resourceState[a.url]=c;this.prefetch[a.url]=b;this.httpController.init(a.url);this.P2PController.init(a.swarmId,!1);this.P2PController.stopResource(a.swarmId);
this.prefetch&&(this.urgent[a.url]=!1)}},isAvailable:function(a){return(this.P2PController.isAvailable(b.getSwarmId(a))||this.httpController.isAvailable(a))&&!(!1===this.resourceState[a]||"stop"===this.resourceState[a])},getConnectionStats:function(a){return{http:this.httpController.getConnectionStats(),p2p:this.P2PController.getConnectionStats()}},downloadPeriodicTest:function(a){this.resourceState[a]&&this.httpController.isAvailable(a)&&radio("HTTPAvailableEvent").broadcast(a)},stopHttp:function(a){this.httpController.stop(a)},
getNumberOfConnectedPeers:function(){return Object.keys(this.P2PController.peerConnections).length}})})();(function(c){function b(){[{key:d.config.FEATURE_PROXY_HEAD_KEY,enabled:d.config.FEATURE_PROXY_HEAD_ENABLED,initialized:d.config.FEATURE_PROXY_HEAD_INITIALIZED,initFunction:function(a,b){if(d.config.FEATURE_PEER5_REQUEST_FORCE)return b();var c=new XMLHttpRequest;c.open("HEAD",d.config.FEATURE_PROXY_HEAD_HEALTH_ENDPOINT);c.onloadend=function(){200===this.status&&a()};c.onerror=c.ontimeout=b;c.timeout=
d.config.FEATURE_PROXY_HEAD_TIMEOUT;c.send()},disableFunction:function(){var a=2;return function(b,c){c||(a--,0>=a&&(d.feature.disable(d.config.FEATURE_PEER5_REQUEST_KEY),b()))}}()},{key:d.config.FEATURE_PEER5_REQUEST_KEY,enabled:d.config.FEATURE_PEER5_REQUEST_ENABLED,disableFunction:function(){var a=!1,b=!1;return function(c){d.config.FEATURE_PEER5_REQUEST_FORCE||(!b&&d.feature.isEnabledAndInitialized(d.config.FEATURE_PROXY_HEAD_KEY)?a=!0:!a&&d.feature.isDisabledAndInitialized(d.config.FEATURE_PROXY_HEAD_KEY)?
(b=!0,d.feature.enable(d.config.FEATURE_PROXY_HEAD_KEY)):(window.peer5.Request=window.XMLHttpRequest,c()))}}()},{key:d.config.FEATURE_DATACHANNEL_KEY,enabled:d.config.FEATURE_DATACHANNEL_ENABLED,initialized:!1,initFunction:function(a,b){var c={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};try{var d=new RTCPeerConnection(c);d.createDataChannel("test_data_channels",{}).close();d.close()}catch(h){return b()}a()}},{key:d.config.FEATURE_PAGE_WHITELIST_KEY,enabled:d.config.FEATURE_PAGE_WHITELIST_ENABLED,
initialized:!1,initFunction:function(a,b){return null!==document.location.href.match(d.config.FEATURE_PAGE_WHITELIST_REGEX)?a():b()}},{key:d.config.FEATURE_PAGE_BLACKLIST_KEY,enabled:d.config.FEATURE_PAGE_BLACKLIST_ENABLED,initialized:!1,initFunction:function(a,b){return null!==document.location.href.match(d.config.FEATURE_PAGE_BLACKLIST_REGEX)?a():b()}},{key:d.config.FEATURE_XHR_KEY,enabled:d.config.FEATURE_XHR_ENABLED,initialized:!1,initFunction:function(a,b){return window.XMLHttpRequest?a():b()}},
{key:d.config.FEATURE_PEER5_KEY,enabled:d.config.FEATURE_PEER5_ENABLED,initialized:!1,initFunction:function(a,b){return(d.feature.isDisabled(d.config.FEATURE_PAGE_WHITELIST_KEY)||d.feature.isEnabledAndInitialized(d.config.FEATURE_PAGE_WHITELIST_KEY))&&!d.feature.isEnabledAndInitialized(d.config.FEATURE_PAGE_BLACKLIST_KEY)&&d.feature.isEnabledAndInitialized(d.config.FEATURE_XHR_KEY)?a():b()}}].forEach(d.feature.add)}c.init=function(){d.feature=d.featureToggle.create();b()};c.init()})(d);(function(){d.core.transport.WsConnection=
Object.subClass({name:"peer5.core.transport.WsConnection",ctor:function(c,b){this.state={connectionOpenTime:0};this.clientId=b;this.wsSeverUrl=c;this.lastPingTimestamp=0;this.socketInitiating=!0;this.intentionalClose=!1;this.reconnectionAttempts=0;this.reconnectionTimeout=5E3+Math.random()*d.config.SOCKET_RECONNECTION_INTERVAL;this.messageQueue=[];this.reconnecting=!1;this.socket;this.registerEvents();d.config.SIMULATION?Math.random()<d.config.SIMULATORS_DEPLOY_RATIO&&(this.initiateWebSocket(this.wsSeverUrl,
this.clientId),setTimeout(function(){new d.client.downloadSimulator},d.config.SIMULATORS_TIMEOUT)):this.initiateWebSocket(this.wsSeverUrl,this.clientId);var a=this;d.config.FEATURE_WS_HEARTBEAT&&setInterval(function(){if(Date.now()-a.lastPingTimestamp>d.config.FEATURE_WS_HEARTBEAT_ELAPSED){var b=new d.core.protocol.Heartbeat;a.sendMessage(b)}},d.config.FEATURE_WS_HEARTBEAT_INTERVAL)},initiateWebSocket:function(c,b){var a=this;this.start=Date.now();d.core.util.getIdFromScriptTag();var e=d.config.A_B_CONFIG_JSON?
"&abconfig="+d.config.A_B_CONFIG_JSON:"",f=encodeURIComponent(d.core.util.urlDigest.urlWithAllowedKeys(window.location.href,d.config.URL_ALLOWED_QUERY_PARAMETERS)).replace(/'/g,"%27").replace(/"/g,"%22"),e=c+"?id="+b+"&token=ncp2vywz762cq79dgwd7&ver=0.53.29&conf="+d.config.VERSION+"&fallback="+d.config.EXTERNAL_XHR_FALLBACK+"&enabled="+d.feature.isEnabledAndInitialized(d.config.FEATURE_PEER5_KEY)+"&page="+f+e;this.socket=new WebSocket(e);d.log("trying to connect to a new websocket");this.sessionid=
b;this.socket.binaryType="arraybuffer";this.socket.onclose=function(b){radio("router.disconnected").broadcast();d.warn("WebSocket closed with error");d.warn(b);a.socket=null;0<a.messageQueue.length&&a.reconnect()};this.socket.onerror=function(b){a.socketInitiating=!1;d.warn("peer with Id "+a.sessionid+" had socket error")};this.socket.onopen=function(){var b=Date.now();a.state.connectionOpenTime=b-a.start;a.socketInitiating=!1;d.log("websocket took: "+a.state.connectionOpenTime+" to open");a.socketInit=
!0;a.registerServerNotifications();radio("router.connected").broadcast();a.processQueue()}},close:function(){this.socket.close()},registerServerNotifications:function(){this.socket.onmessage=function(c){if("string"!=typeof c.data)return void d.warn("non string messages aren't supported");c=JSON.parse(c.data);switch(c.tag){case d.core.protocol.GROUP_MATCH:radio("receivedGroupMatchEvent").broadcast(c);break;case d.core.protocol.FILE_INFO:radio("receivedFileInfo").broadcast(c);break;case d.core.protocol.SDP:radio("receivedSDP").broadcast(c);
break;case d.core.protocol.GROUP_SDP:radio("receivedGroupSDP").broadcast(c);break;case d.core.protocol.SWARM_HEALTH:radio("swarmHealth").broadcast(c);break;case d.core.protocol.SWARM_ERROR:radio("swarmError").broadcast(c);break;case d.core.protocol.HEAD_RESPONSE:radio("responseHeadersReceived"+c.url).broadcast(c.responseHeaders);break;case d.core.protocol.HEAD_ERROR:radio("xhrFailed"+c.url).broadcast(c)}}},socketReadyToSend:function(){return this.socket&&this.socketInit&&this.socket.readyState==this.socket.OPEN},
reconnect:function(){if(!1===this.socketInitiating){this.socketInitiating=!0;d.info("Peer "+this.sessionid+" is trying to reconnect to the server");var c=this;setTimeout(function(){c.initiateWebSocket(c.wsSeverUrl,c.clientId);c.reconnectionAttempts++},this.reconnectionTimeout*Math.pow(2,this.reconnectionAttempts))}},processQueue:function(){if(this.socketReadyToSend()){var c=this.messageQueue;for(this.messageQueue=[];0<c.length;){var b=c.shift();this.sendData(b)}}else d.warn("cant send data - socket is not defined"),
this.reconnect()},sendData:function(c){d.log("sending data on websockets, at time: "+Date.now());this.socket.send(c);this.lastPingTimestamp=Date.now()},sendMessageDirectly:function(c){this.socketReadyToSend()&&(c=JSON.stringify(c),this.sendData(c))},sendMessage:function(c){c=JSON.stringify(c);this.messageQueue.push(c);this.processQueue()},registerEvents:function(){radio("router.send").subscribe([function(c,b){b?this.sendMessageDirectly(c):this.sendMessage(c)},this])}})})();(function(){d.core.apiValidators.ApiValidatorBase=
Object.subClass({name:"peer5.core.apiValidators.ApiValidatorBase",ctor:function(){this.status=!1},detectBrowser:function(){var c,b=navigator.appName,a=navigator.userAgent,d=a.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);return d&&null!=(c=a.match(/version\/([\.\d]+)/i))&&(d[2]=c[1]),d?[d[1],d[2]]:[b,navigator.appVersion,"-?"]},getMajorVersionNumber:function(c){c=c.split(".");return parseInt(c[0])},validate:function(){throw"unimplemented method";}})})();(function(){d.core.apiValidators.ApiValidator=
Object.subClass({name:"peer5.core.apiValidators.ApiValidator",ctor:function(c){var b=this.detectBrowser();this.browserName=b[0].toLowerCase();this.browserVersion=b[1];this.validators={};this.validity={};d.browserName=this.browserName;d.browserVersion=this.browserVersion;for(var a in c)this.validators[a]=new c[a](this.browserName,this.browserVersion),this.validity[a]=!1},detectBrowser:function(){var c,b=navigator.appName,a=navigator.userAgent,d=a.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);
return d&&null!=(c=a.match(/version\/([\.\d]+)/i))&&(d[2]=c[1]),d=d?[d[1],d[2]]:[b,navigator.appVersion,"-?"],d&&d[0]&&"Netscape"===d[0]&&(d[0]="msie"),d},validate:function(){var c=!0;switch(this.browserName){case "chrome":if(d.config.DISABLE_CHROME)return!1;break;case "firefox":if(d.config.DISABLE_FIREFOX)return!1}for(var b in this.validators)c=c&&this.validators[b].validate();return c},getBrowser:function(){return{name:this.browserName,version:this.browserVersion}},getStatus:function(){var c={},
b;for(b in this.validators)c[b]=this.validators[b].status;return c}})})();(function(){d.core.apiValidators.DataChannelsApiValidator=d.core.apiValidators.ApiValidatorBase.subClass({name:"peer5.core.apiValidators.DataChannelsApiValidator",ctor:function(c,b){this._super();this.browserName=c;this.browserVersion=b;this.browserVersionSupprot={chrome:31,firefox:26,msie:11,opera:12,safari:1E3}},validate:function(){var c=!0;"chrome"==this.browserName&&31>this.getMajorVersionNumber(this.browserVersion)&&(c=
!1);var b;try{b=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),b.createDataChannel("test_data_channels",{ordered:!1,maxRetransmits:0})}catch(a){c=!1}return b&&b.close(),c||radio("browserUnsupported").broadcast(this.browserName,this.browserVersion,"data channels"),this.status=c,c}})})();(function(){d.core.apiValidators.FileSystemApiValidator=d.core.apiValidators.ApiValidatorBase.subClass({name:"peer5.core.apiValidators.FileSystemApiValidator",ctor:function(c,b){this._super();
this.browserName=c;this.browserVersion=b;this.browserVersionSupprot={chrome:26,firefox:19,msie:11,opera:12,safari:1E3}},validate:function(){if(0==d.config.USE_FS)return!0;var c=this;return"firefox"==this.browserName?(d.config.ALLOWED_FILE_SIZE=d.config.ALLOWED_FILE_SIZE_FF,d.config.IS_FIREFOX=!0,!d.config.USE_PERSISTENT||d.config.DISABLE_FS_FF?d.config.USE_FS=!1:window.indexedDB&&window.indexedDB.open?d.core.data.FSio=new d.core.data.FSioFireFox(function(b){b||(d.info("changing USE_FS to false"),
c.status=!1,d.config.USE_FS=!1)}):d.config.USE_FS=!1):window.webkitRequestFileSystem&&navigator.webkitTemporaryStorage?(d.core.data.FSio.requestTempQuota(100,function(b){b||(d.info("changing USE_FS to false"),c.status=!1,d.config.USE_FS=!1)}),d.config.IS_CHROME=!0):d.config.USE_FS=!1,this.status=d.config.USE_FS,!0}})})();(function(){var c=window.GoogleAnalyticsObject||"__ga__",b=c;Object.defineProperty(window,"GoogleAnalyticsObject",{get:function(){return b},set:function(a){a!==b&&(b=a,window[c]&&
window[c].q&&(window[a]=window[c],c=b))}});(function(a,b,c,d,h,k,l){a.GoogleAnalyticsObject=h;a[h]=a[h]||function(){(a[h].q=a[h].q||[]).push(arguments)};a[h].l=1*new Date;k=b.createElement(c);l=b.getElementsByTagName(c)[0];k.async=1;k.src=d;l.parentNode.insertBefore(k,l)})(window,document,"script","//www.google-analytics.com/analytics.js",b);window[c]("create","UA-37859248-1",{name:"peer5"});window[c]("peer5.set","dimension2",d.config.EXTERNAL_XHR_FALLBACK);window[c]("peer5.send","pageview");d.gaManager=
function(){d.config.DISABLE_GOOGLE_ANALYTICS||(this.registerEvents(),this.downloadStarted={},this.fallback=0)};d.gaManager.prototype={registerEvents:function(){radio("scriptLoaded").subscribe([function(){d.info("script loaded "+Date.now());window[c]("peer5.send","event","script","loaded")},this]);radio("scriptValidated").subscribe([function(a){a?(d.info("script passed validated"),window[c]("peer5.send","event","script","browser passed validation")):(d.info("script failed validation"),window[c]("peer5.send",
"event","script","browser failed validation"))},this]);radio("unhandledError").subscribe([function(a,b,d){window[c]("peer5.send","event","unhandled errors",a,b,d)},this]);radio("fileVerificationFailed").subscribe([function(){window[c]("peer5.send","event","errors","file verification failed")},this]);radio("trackerHeadExpired").subscribe([function(){window[c]("peer5.send","event","request init","tracker head timeout")},this]);radio("peer5error").subscribe([function(a){window[c]("peer5.send","event",
"peer5error",a)},this]);radio("startedDownloading").subscribe([function(a){d.info("started downloading "+Date.now());window[c]("peer5.send","event","transfer","downloadStarted","requestSize",a);this.downloadStarted[a]=!0},this]);radio("downloadFinished").subscribe([function(a,b,d,g,h){window[c]("peer5.send","event","transfer","downloadFinished","fileSize",b);window[c]("peer5.send","event","transfer","downloadFinished","p2p bytes downloaded",d);window[c]("peer5.send","event","transfer","downloadFinished",
"http bytes downloaded",g);window[c]("peer5.send","event","transfer","downloadFinished","filesystem bytes resumed",h)},this]);radio("peer5_b1_finished").subscribe([function(a){d.info("Got first block in "+a+" ms");window[c]("peer5.send","event","transfer","received first block","time to first block",a)},this]);radio("peer5_p1_finished").subscribe([function(a){d.info("p1 completed"+Date.now());a=Math.abs(Math.floor(a));window[c]("peer5.send","event","transfer","downloaded 1%","average download speed",
a)},this]);radio("peer5_p5_finished").subscribe([function(a){d.info("p5 completed"+Date.now());a=Math.abs(Math.floor(a));window[c]("peer5.send","event","transfer","downloaded 5%","average download speed",a)},this]);radio("peer5_p10_finished").subscribe([function(a){d.info("p10 completed"+Date.now());a=Math.abs(Math.floor(a));window[c]("peer5.send","event","transfer","downloaded 10%","average download speed",a)},this]);radio("peer5_q1_finished").subscribe(function(a){d.info("q1 completed"+Date.now());
a=Math.abs(Math.floor(a));window[c]("peer5.send","event","transfer","downloaded 25%","average download speed",a)});radio("peer5_q2_finished").subscribe(function(a){d.info("q2 completed"+Date.now());a=Math.abs(Math.floor(a));window[c]("peer5.send","event","transfer","downloaded 50%","average download speed",a)});radio("peer5_q3_finished").subscribe(function(a){d.info("q3 completed"+Date.now());a=Math.abs(Math.floor(a));window[c]("peer5.send","event","transfer","downloaded 75%","average download speed",
a)});radio("peer5_q4_finished").subscribe(function(a){d.info("q4 completed"+Date.now());a=Math.abs(Math.floor(a));window[c]("peer5.send","event","transfer","downloaded 100%","average download speed",a)});radio("seeding").subscribe([function(a){switch(d.info("seeding for "+a+" miliseconds"),a){case 5E3:window[c]("peer5.send","event","user","seeding","5 seconds");break;case 3E4:window[c]("peer5.send","event","user","seeding","30 seconds");break;case 3E5:window[c]("peer5.send","event","user","seeding",
"5 minutes")}},this]);radio("exitDownload").subscribe([function(a){a?window[c]("peer5.send","event","user","exit download","download completed"):window[c]("peer5.send","event","user","exit download","download didnt complete")},this]);radio("exitPageStats").subscribe([function(a,b,d){b=Math.abs(Math.floor(b));d=Math.abs(Math.floor(d));.25>a?window[c]("peer5.send","event","user","exit page","download in Q1",b):.5>a?window[c]("peer5.send","event","user","exit page","download in Q2",b):.75>a?window[c]("peer5.send",
"event","user","exit page","download in Q3",b):1>a?window[c]("peer5.send","event","user","exit page","download in Q4",b):window[c]("peer5.send","event","user","exit page","download finished",b);window[c]("peer5.send","event","user","exit page","average download speed",d)},this]);radio("exitPage").subscribe([function(a,b){a?b?window[c]("peer5.send","event","user","exit page","after download start and fallen-back"):window[c]("peer5.send","event","user","exit page","after download start and no fallback"):
b?window[c]("peer5.send","event","user","exit page","before download start and fallen-back"):window[c]("peer5.send","event","user","exit page","before download start and no fallback")},this]);radio("fallback").subscribe([function(a,b){this.fallback++;d.info("fallback "+Date.now());this.downloadStarted[b]?window[c]("peer5.send","event","errors","fallback after download started",a):window[c]("peer5.send","event","errors","fallback before download started",a)},this]);radio("pauseClicked").subscribe([function(){window[c]("peer5.send",
"event","user","clicked paused")},this]);radio("playClicked").subscribe([function(){window[c]("peer5.send","event","user","clicked played")},this]);radio("external.player").subscribe([function(a){window[c]("peer5.send","event","player",a.action,a.label,a.value)},this]);radio("m3u8SpeedEstimation").subscribe([function(a){window[c]("peer5.send","event","rum","speed estimation","first m3u8",a)},this]);radio("mediaElementWrapperFailure").subscribe(function(a,b){window[c]("peer5.send","event","failure",
a,b,0)});radio("resumeStarted").subscribe([function(){d.info("resume started "+Date.now());window[c]("peer5.send","event","storage","resume started")},this]);radio("resumeEnded").subscribe([function(){d.info("resume ended "+Date.now());window[c]("peer5.send","event","storage","resume ended")},this]);radio("requestedPersQuota").subscribe([function(){d.info("requested persistent quota event");window[c]("peer5.send","event","user","prompt persistent quota")},this]);radio("persQuotaAnswer").subscribe([function(a){a?
(d.info("user has approved using persistent quota"),window[c]("peer5.send","event","user","approved persistent quota")):(d.info("user has denied using persistent quota"),window[c]("peer5.send","event","user","denied persistent quota"))},this]);radio("persQuotaTimeout").subscribe([function(){window[c]("peer5.send","event","user","persistent quota timed out")},this]);radio("offlineStorageError").subscribe([function(a){window[c]("peer5.send","event","errors","offline storage",a)},this]);radio("usingFileSystem").subscribe([function(a){window[c]("peer5.send",
"event","cacheMethod","filesystem","fileSize",a)},this]);radio("usingMemory").subscribe([function(a){window[c]("peer5.send","event","cacheMethod","memory","fileSize",a)},this]);radio("outOfMemoryError").subscribe([function(a){window[c]("peer5.send","event","errors","out of memory","heap size",a)},this])}};d.gaManager=new d.gaManager})();(function(){function c(a,c){if(a in b){var d,g=b[a];for(d in c)if(!(d in g)||typeof c[d]!==g[d])return!1;for(d in g)if(!(d in c)||g[d]!==typeof c[d])return!1;return!0}return!1}
var b={player:{action:"string",label:"string",value:"number",timeSinceLoaded:"number",duration:"number",vendor:"string",id:"string"},playback:{currentSegment:"string"}};d.trigger=function(a,b){c(a,b)&&radio("external."+a).broadcast(b)}})();(function(c,b){var a;a=window.onbeforeunload;window.onbeforeunload=function(){c.info("triggering beforeunload");b("beforeUnload").broadcast();c.core.util.envokeCallbackSync(a,[])}})(d,radio);(function(c){function b(a){for(var b=0;b<a.length;++b)if(!/^\d+$/.test(a[b]))return!1;
return!0}c.validateVersion=function(a){a=a.split(".");return b(a)};c.compareVersionNumbers=function(a,c){var d=a.split("."),g=c.split(".");if(!b(d)||!b(g))return NaN;for(var h=0;h<d.length;++h){if(g.length===h)return 1;if(d[h]!==g[h])return d[h]>g[h]?1:-1}return d.length!=g.length?-1:0};c.compareMajorVersionNumbers=function(a,c){var d=a.split("."),g=c.split(".");return b(d)&&b(g)?d.length>g.length?1:d.length<g.length?-1:d[0]>g[0]?1:d[0]<g[0]?-1:0:NaN}})(d.core.util);(function(){d.core.Block=Object.subClass({name:"peer5.core.Block",
ctor:function(c,b,a){this.blockSize=c;this.length=Math.ceil(this.blockSize/d.config.CHUNK_SIZE);this.buffer=b?b:null;this.verified=a?a:!1;this.hash=null;this.chunkMap=[];for(c=this.numOfChunksSet=0;c<this.length;++c)this.chunkMap[c]=this.verified},getBlock:function(c){return this.verified?this.buffer?this.buffer:!0:!1},setBlock:function(c){if(c.length===this.blockSize){if(!this.verified)for(var b=0,a=this.length;a>b;b++)this.setChunkOn(b);this.buffer=c}},getChunk:function(c){return this.verified?
this.buffer?this.buffer.subarray(c*d.config.CHUNK_SIZE,(1+c)*d.config.CHUNK_SIZE):!0:!1},hasChunk:function(c){return this.chunkMap[c]},verifySize:function(c,b){return c.length!==d.config.CHUNK_SIZE&&this.buffer.length!==b?!1:this.buffer.length<b?!1:!0},setChunk:function(c,b){this.buffer||(this.buffer=new Uint8Array(this.blockSize),this.chunkMap=[]);var a=new Uint8Array(b),e=c*d.config.CHUNK_SIZE;return this.verifySize(b,a.length+e)?(this.buffer.set(a,e),this.chunkMap[c]=!0,this.numOfChunksSet++,!0):
!1},setChunkOn:function(c){this.chunkMap||(this.chunkMap=[]);this.chunkMap[c]=!0;this.numOfChunksSet++},getNumOfChunksSet:function(){return this.numOfChunksSet},getNumOfBytesSet:function(){return this.chunkMap[this.length-1]&&this.blockSize!==d.config.BLOCK_SIZE?(this.numOfChunksSet-1)*d.config.CHUNK_SIZE+(this.blockSize%d.config.CHUNK_SIZE||d.config.CHUNK_SIZE):this.numOfChunksSet*d.config.CHUNK_SIZE},getNumOfChunks:function(){return this.length},removeBlockData:function(){delete this.buffer},verifyBlock:function(c){if(this.verified)return 0;
for(var b=0;b<this.length;++b)if(!this.chunkMap[b])return 0;if(null==this.hash)return this.verified=!0,1;if(this.buffer){b=d.core.util.MD5.ArrayBuffer.hash(this.buffer.buffer);if(b===this.hash)return this.verified=!0,1;d.error("Hash didn't verify, block has been polluted")}else if(c){b=d.core.util.MD5.ArrayBuffer.hash(c.buffer);if(b===this.hash)return this.buffer=c,this.verified=!0,1;d.error("Hash didn't verify, block has been polluted")}},hashBlock:function(){for(var c=0;c<this.length;++c)if(!this.chunkMap[c])return 0;
return this.hash=d.core.util.MD5.ArrayBuffer.hash(this.buffer.buffer),this.hash}})})();(function(){d.core.dataStructures.BlockMap=Object.subClass({name:"peer5.core.dataStructures.BlockMap",ctor:function(c,b,a,e){this.init=!1;this.resourceId=b;e?(this.hashAlg=d.CryptoJS.algo.SHA1.create(),this.aprioriHash=e):a&&(this.hashAlg=new d.core.util.MD5.ArrayBuffer,this.aprioriHash=a);this.metadata=new d.core.protocol.FileInfo(null,c,null,null,d.config.BLOCK_SIZE,null,null,null,null);this.metadata.url=b;this.privateBlockMap=
Object.create(null);this.numOfChunksInBlock=d.config.BLOCK_SIZE/d.config.CHUNK_SIZE;this.fileSize=c;this.numOfBlocks=Math.ceil(this.fileSize/d.config.BLOCK_SIZE);this.numOfChunks=Math.ceil(this.fileSize/d.config.CHUNK_SIZE);this.firstMissingBlock=this.numOfVerifiedBlocks=0;this.sizeOfLastBlock=c%d.config.BLOCK_SIZE;0==this.sizeOfLastBlock&&(this.sizeOfLastBlock=d.config.BLOCK_SIZE);this.availabilityMap;this.fs=!0;this._registerEvents();d.config.USE_FS&&this.fileSize>d.config.SMALL_FILE_SIZE?(this.lruMap=
new d.core.dataStructures.LRU(Math.floor(d.config.CACHE_SIZE/d.config.BLOCK_SIZE),this._lruRemoveCb),this._initiateFileSystem()):(this.fs=!1,this.availabilityMap=new d.core.dataStructures.AvailabilityMap(this.numOfBlocks))},dtor:function(){radio("handleOutOfSpaceError").unsubscribe([this._handleOutOfSpaceError,this]);radio("handleWriteError").unsubscribe([this._handleWriteError,this])},getSerializedMap:function(){return this.availabilityMap.serialize()},isFull:function(){return this.numOfBlocks==
this.numOfVerifiedBlocks},has:function(c){return this.privateBlockMap[c]&&this.privateBlockMap[c].verified},hasChunk:function(c){c=this.calcBlockIdChunkOffset(c);return this.privateBlockMap[c.block]?this.privateBlockMap[c.block].hasChunk(c.chunk):!1},getNumOfBlocks:function(){return this.numOfBlocks},getNumOfVerifiedBytes:function(){return this.numOfVerifiedBlocks==this.numOfBlocks?this.fileSize:this.numOfVerifiedBlocks*d.config.BLOCK_SIZE},getNumOfChunksInBlock:function(c){return numOfChunksInThisBlock=
c==this.numOfBlocks-1?Math.ceil(this.sizeOfLastBlock/d.config.CHUNK_SIZE):this.numOfChunksInBlock},getBlock:function(c,b){if(this.privateBlockMap[c]){var a=this.privateBlockMap[c].getBlock(c);if(this.fs){if(!a)return!1;if(1==a){var a=c*d.config.BLOCK_SIZE,e=this;d.core.data.FSio.read(this.resourceId,a,a+d.config.BLOCK_SIZE,function(a,d){if(a){var h=e.privateBlockMap[c];h.setBlock(d);e.lruMap.set(c,h);e.getBlock(c,b)}})}else this.lruMap.get(c),b(a)}else b(a)}},getChunkIdsOfBlock:function(c){if(c>=
this.numOfBlocks)return[];for(var b=c==this.numOfBlocks-1?Math.ceil(this.sizeOfLastBlock/d.config.CHUNK_SIZE):this.numOfChunksInBlock,a=[],e=c*=this.numOfChunksInBlock;c+b>e;++e)a.push(e);return a},getBlockIdOfChunk:function(c){return c>=this.numOfChunks?-1:this.calcBlockIdChunkOffset(c).block},getNumOfChunksSetInBlock:function(c){return void 0!==this.privateBlockMap[c]?this.privateBlockMap[c].getNumOfChunksSet():0},getNumOfBytesSetInBlock:function(c){return void 0!==this.privateBlockMap[c]?this.privateBlockMap[c].getNumOfBytesSet():
0},getChunk:function(c,b){var a=this,e=this.calcBlockIdChunkOffset(c);if(this.privateBlockMap[e.block]){var f=this.privateBlockMap[e.block].getChunk(e.chunk);if(this.fs){if(!f)return!1;1==f?(f=e.block*d.config.BLOCK_SIZE,d.core.data.FSio.read(this.resourceId,f,f+d.config.BLOCK_SIZE,function(d,f){if(d){var k=a.privateBlockMap[e.block];k.setBlock(f);a.lruMap.set(e.block,k);a.getChunk(c,b)}})):(this.lruMap.get(e.block),b(!0,f))}else b(!0,f)}},setChunk:function(c,b){var a=this.calcBlockIdChunkOffset(c);
this.privateBlockMap[a.block]||this._createANewBlock(a.block);return this.privateBlockMap[a.block].setChunk(a.chunk,b)?(radio("chunkReceivedEvent").broadcast(this.metadata),this.verifyBlock(a.block),a.block):void radio("removeResource").broadcast(this.metadata.url,d.Request.FILE_SIZE_ERR,"Wrong filesize was received from the server")},setBlock:function(c,b){this.privateBlockMap[c]||this._createANewBlock(c);this.privateBlockMap[c].setBlock(b);this.verifyBlock(c)},isEmpty:function(c){return!this.privateBlockMap[c]},
getBlockIndex:function(c){return Math.ceil(c/d.config.BLOCK_SIZE)},getMissingBlock:function(c){return c?this.getRandomMissingBlock():this.getFirstMissingBlock()},getFirstMissingBlock:function(){return this.firstMissingBlock},getRandomMissingBlock:function(){for(var c=0;1E3>c;c++){var b=this.firstMissingBlock+Math.floor(Math.random()*(this.numOfBlocks-this.firstMissingBlock));if(!(b in this.privateBlockMap&&this.privateBlockMap[b].verified))return b}return this.firstMissingBlock},getConsecutiveBuffer:function(c,
b){for(var a=c;this.has(a);)a++;var a=a-c,e=new Uint8Array(d.config.BLOCK_SIZE*a);this._iterateBlocks(function(a){e.set(a,blockId*d.config.BLOCK_SIZE)},c,c+a-1,function(a){b(e)})},verifyBlock:function(c){if(this.privateBlockMap[c]){if(1==this.privateBlockMap[c].verifyBlock()){for(this.numOfVerifiedBlocks++;this.has(this.firstMissingBlock);)this.firstMissingBlock++;radio("blockReceivedEvent").broadcast(this.resourceId,this.privateBlockMap[c].blockSize);this.isFull()&&radio("transferFinishedEvent").broadcast(this.metadata);
var b=this;this.fs?b.getBlock(c,function(a){d.core.data.FSio.write(b.resourceId,a,c*d.config.BLOCK_SIZE,function(a,f){a?(b.lruMap.set(c,b.privateBlockMap[c]),d.debug("successfully wrote block "+c+" to filesystem "),b.availabilityMap.setFS(c,function(a){a&&d.debug("successfully added block "+c+" to metadata file");b.availabilityMap.isFullFS()&&b._verifyResource(function(a){a?radio("transferLoadedEvent").broadcast(b.metadata):(d.error("file verification failed"),radio("fileVerificationFailed").broadcast(),
radio("removeResource").broadcast(b.resourceId,d.Request.VERIFICATION_ERR,"file verification failed"))})})):(d.warn("couldn't write block "+c+" to filesystem"),"space"===f?b._handleOutOfSpaceError():b._handleWriteError())})}):this.isFull()&&this._verifyResource(function(a){a?radio("transferLoadedEvent").broadcast(b.metadata):(d.error("file verification failed"),radio("fileVerificationFailed").broadcast(),radio("removeResource").broadcast(b.resourceId,d.Request.VERIFICATION_ERR,"file verification failed"))})}if(this.privateBlockMap[c].verified)return this.availabilityMap.set(c),
!0}return!1},ingestBlock:function(c){return this.privateBlockMap[c]&&this.privateBlockMap[c].hashBlock()?(this.verifyBlock(c),this.privateBlockMap[c].hash):!1},addMetadata:function(c){this.metadata=c;this.init=!0},getMetadata:function(){return this.metadata},initiateFromLocalData:function(c,b,a){var e=this;b||(b=0);a||0==a?e.availabilityMap.hasFS(b)?d.core.data.FSio.read(e.resourceId,b*d.config.BLOCK_SIZE,(b+1)*d.config.BLOCK_SIZE,function(f,g){f?(e.initiateBlockFromLocalData(b,g)?(radio("blockReceivedEvent").broadcast(e.resourceId,
e.privateBlockMap[b].blockSize),d.log("successfully initiated block "+b+" from filesystem "+Date.now())):d.log("couldnt verify block "+b+" from filesystem "+Date.now()),a>b?(b++,e.initiateFromLocalData(c,b,a)):(d.info("finished initiating from filesystem"),radio("resumeEnded").broadcast(),c(!0))):d.warn("couldn't initiate block "+b+" from filesystem")}):(d.debug("blockId "+b+" was not in availabilityMap, skipping to next block"),a>b?(b++,e.initiateFromLocalData(c,b,a)):(d.info("finished initiating from filesystem"),
radio("resumeEnded").broadcast(),c(!0))):d.core.data.FSio.getResourceDetails(this.resourceId,function(a,g){var h=Math.floor(g.size/d.config.BLOCK_SIZE);e.availabilityMap.removeBlocksFrom(h+1,function(a){a?e.initiateFromLocalData(c,b,h):d.error("couldn't remove blocks from availability map")})})},initiateBlockFromLocalData:function(c,b){this._createANewBlock(c);for(var a=Math.ceil(b.length/d.config.CHUNK_SIZE),e=b.length-(a-1)*d.config.CHUNK_SIZE,f=0;a>f;++f)this.privateBlockMap[c].setChunkOn(f);if(this.privateBlockMap[c].verifyBlock(b)){for(this.numOfVerifiedBlocks++;this.has(this.firstMissingBlock);)this.firstMissingBlock++;
for(f=0;a>f;++f){var g=a-1>f?d.config.CHUNK_SIZE:e;radio("peer5_received_fs_chunk").broadcast(this.resourceId,g,c*this.numOfChunksInBlock+f)}if(this.availabilityMap.set(c),this.isFull()){var h=this;this.availabilityMap.setFSFull(function(a){radio("transferLoadedEvent").broadcast(h.metadata)})}return!0}return delete this.privateBlockMap[c],!1},changeResourceId:function(c,b){if(this.fs){var a=this;d.core.data.FSio.renameResource(this.resourceId,c,function(d){d?(a.resourceId=c,a.availabilityMap.renameResource(c,
function(a){b(a)})):b(d)})}else this.resourceId=c,b(!0)},getDataBlob:function(c){var b=[];this._iterateBlocks(function(a){b.push(a)},0,this.numOfBlocks-1,function(a){try{var d=new Blob(b,{type:"application/octet-binary"})}catch(f){"NS_ERROR_OUT_OF_MEMORY"===f.name&&(f.result,radio("outOfMemoryError").broadcast(f.result))}c(d)})},getDataUint8Array:function(c){try{var b=new Uint8Array(this.metadata.size)}catch(d){"NS_ERROR_OUT_OF_MEMORY"===d.name&&(d.result,radio("outOfMemoryError").broadcast(d.result),
c(!1));return}var a=0;this._iterateBlocks(function(c){b.set(c,a);a+=c.length},0,this.numOfBlocks-1,function(a){c(b)})},getBlobUrl:function(c){var b=this;if(this.fs)d.core.data.FSio.createObjectURL(this.resourceId,function(a,b){return a?void c(a,b):void c(!1)});else{var a=function(){try{b.getDataBlob(function(a){a=window.URL.createObjectURL(a);c(!0,a)})}catch(d){"NS_ERROR_OUT_OF_MEMORY"===d.name&&(setTimeout(a,1E4),d.result,radio("outOfMemoryError").broadcast(d.result))}};a()}},getBlob:function(c){this.fs?
d.core.data.FSio.getBlob(this.resourceId,0,this.fileSize,c):this.getDataBlob(function(b){c(!0,b)})},getUint8Array:function(c){this.fs?d.core.data.FSio.getArrayBuffer(this.resourceId,0,this.fileSize,function(b,a){b?c(!0,new Uint8Array(a)):c(!1)}):this.getDataUint8Array(function(b){b?c(!0,b):c(!1)})},getText:function(c){this.getUint8Array(function(b,a){b?c(!0,d.core.util.uint8ToString(a)):c(!1)})},getFileSize:function(){return this.fileSize},allocateFileSize:function(c){var b=this;d.core.data.FSio.write(this.resourceId,
new Uint8Array([]),this.fileSize,function(a,e){a||"space"!=e?a||d.error("error in allocateFileSize"):b._handleOutOfSpaceError();c(a)})},allocateFileSizeSync:function(c){d.core.data.FSio.write(this.resourceId,new Uint8Array([]),this.fileSize,function(b,a){b||"space"!=a?(b||d.error("error in allocateFileSizeSync"),c&&c(b)):d.core.data.CacheManager.handleOutOfSpace(this.resourceId,this.fileSize,function(a){a?c&&c(a):(d.warn("couldn't clear enough space from offline storage"),c&&c(a))})})},_registerEvents:function(){var c=
this;this._lruRemoveCb=function(b,a){c._removeBlockData(b)};radio("handleOutOfSpaceError").subscribe([this._handleOutOfSpaceError,this]);radio("handleWriteError").subscribe([this._handleWriteError,this])},_initiateFileSystem:function(){var c=this;d.config.USE_PERSISTENT?d.core.data.FSio.queryPersQuota(function(b,a,e){0!=e?d.core.data.FSio.requestPersQuota(e,function(a,b){a?c._createOrResumeResource(b):(d.warn("couldn't initiate filesystem"),c._fallbackToNoFS())},c.fileSize):c._initiateTempFileSystem()}):
this._initiateTempFileSystem()},_initiateTempFileSystem:function(){var c=this;d.core.data.FSio.queryTempQuota(function(b,a,e){e<c.fileSize?d.config.USE_PERSISTENT?d.core.data.FSio.requestPersQuota(d.config.PERSISTENT_FS_SIZE,function(a,b){a?c.availabilityMap=new d.core.dataStructures.AvailabilityMapFS(c.numOfBlocks,c.resourceId,b,function(a){a?d.core.data.FSio.createResource(c.resourceId,function(a){a?c._resourceInitedWithFS():(d.warn("failed to create resource in filesystem"),c._fallbackToNoFS())}):
(d.warn("couldn't initiate metadata file"),c._fallbackToNoFS())}):(d.warn("couldn't initiate persistent filesystem"),c._fallbackToNoFS())},c.fileSize):(d.warn("not enough space in temporary storage"),c._fallbackToNoFS()):e-a>c.fileSize?c._createOrResumeResource(e-a):e-a<c.fileSize&&c._createOrResumeResource(e-a)})},_createOrResumeResource:function(c){var b=this;b.availabilityMap=new d.core.dataStructures.AvailabilityMapFS(b.numOfBlocks,b.resourceId,c,function(a){a?0<b.availabilityMap.numOfOnFSBits?
d.core.data.FSio.isExist(b.resourceId,function(a){a?(d.info("Resource "+b.resourceId+" exists already in the filesystem."),radio("resumeStarted").broadcast(),b.initiateFromLocalData(function(a){a?b._resourceInitedWithFS():(d.warn("there was a problem resuming the resource"),b._fallbackToNoFS())})):b.availabilityMap.reset(function(a){a?d.core.data.FSio.createResource(b.resourceId,function(a){a?b._resourceInitedWithFS():(d.warn("failed to create resource in filesystem"),b._fallbackToNoFS())}):(d.error("couldn't reset the availability map"),
b._fallbackToNoFS())})}):d.core.data.FSio.createResource(b.resourceId,function(a){a?b._resourceInitedWithFS():(d.warn("failed to create resource in filesystem"),b._fallbackToNoFS())}):(d.warn("couldn't initiate metadata file"),b._fallbackToNoFS())})},_resourceInitedWithFS:function(){this.fs=!0;radio("filesystemInitiated"+this.resourceId).broadcast();this.init&&radio("resourceInit").broadcast(this.metadata)},_fallbackToNoFS:function(){this.fs=!1;this.availabilityMap=new d.core.dataStructures.AvailabilityMap(this.numOfBlocks);
this.init&&radio("resourceInit").broadcast(this.metadata);radio("filesystemInitiated"+this.resourceId).broadcast()},_removeBlockData:function(c){this.privateBlockMap[c]&&this.privateBlockMap[c].removeBlockData()},_handleOutOfSpaceError:function(){var c;c=this.metadata.url?this.metadata.url:this.resourceId;d.error("Out of space error");radio("pauseResource").broadcast(c,d.Request.OUT_OF_SPACE_ERR,"out of space");d.core.data.CacheManager.handleOutOfSpace(this.resourceId,this.fileSize,function(b){b?
radio("resumeResource").broadcast(c):(d.warn("couldn't clear enough space from offline storage"),radio("removeResource").broadcast(c,d.Request.OUT_OF_SPACE_ERR,"out of space"))})},_handleWriteError:function(){d.error("offline storage write error");var c;c=this.metadata.url?this.metadata.url:this.resourceId;radio("removeResource").broadcast(c,d.Request.WRITE_ERR,"offline storage write error")},_verifyResource:function(c){if(!this.hashAlg)return void c(!0);var b=this;return this.hashAlg?void this._iterateBlocks(function(a,
c){d.debug("hashing block "+c);b.hashAlg.append?b.hashAlg.append(a):b.hashAlg.update(d.core.util.base64.encode(a))},0,this.numOfBlocks-1,function(){var a=b.hashAlg.end?b.hashAlg.end().toUpperCase():b.hashAlg.finalize().toString().toUpperCase();d.info("resourceId "+b.resourceId+" loaded with hash = "+a);c(a===b.aprioriHash)}):void c(!0)},_iterateBlocks:function(c,b,a,d){var f=this,g=function(b){f.getBlock(b,function(f){f&&c(f,b);b++;a>=b?g(b):d(!0)})};g(b)},_createANewBlock:function(c){this.privateBlockMap[c]=
new d.core.Block(c==this.numOfBlocks-1?this.sizeOfLastBlock:d.config.BLOCK_SIZE);this.metadata.hashes&&(this.privateBlockMap[c].hash=this.metadata.hashes[c])},calcBlockIdChunkOffset:function(c){return{block:Math.floor(c/this.numOfChunksInBlock),chunk:c%this.numOfChunksInBlock}}})})();(function(){d.core.data.BlockMaps=Object.subClass({ctor:function(){this._blockMaps={};this._keys={}},getRealKeyName:function(c){return void 0!==this._blockMaps[c]?c:void 0!==this._keys[c]?this.getRealKeyName(this._keys[c]):
!1},alias:function(c,b){void 0===this._keys[c]&&(this._keys[c]=b)},add:function(c,b){this._blockMaps[c]=b},get:function(c){return c=this.getRealKeyName(c),this._blockMaps[c]},remove:function(c){var b=this.getRealKeyName(c);this._blockMaps[b].dtor();for(delete this._blockMaps[b];void 0!==this._keys[c];)b=this._keys[c],delete this._keys[c],c=b},forEach:function(c){for(var b in this._blockMaps)c(b,this._blockMaps[b])}});d.core.data.BlockCache=new d.core.data.BlockMaps})();(function(){d.core.data.FSio=
Object.subClass({ctor:function(){this.writeQueue=new D;this.registerEvents();this.pendingObjectUrlCb={};this.finishWriteCbs=[];this.currentlyWriting=!1},executeOnReady:function(c){},createResource:function(c,b,a){c=c.replace("peer5://","");d.info("Adding resource "+c+" to the filesystem.");var e=this;this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{create:!0},function(a){b&&b(!0)},function(a){e.errorHandler(a,b)})},removeResource:function(c,b){c=c.replace("peer5://","");d.log("Removing resource "+c+" from the filesystem.");
var a=this;this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{create:!1},function(c){c.remove(function(){b&&b(!0)},function(c){a.errorHandler(c,b)})},function(c){a.errorHandler(c,b)})},renameResource:function(c,b,a){c=c.replace("peer5://","");b=b.replace("peer5://","");d.info("changing resource name from "+c+" to "+b);var e=this;this.fs.root.getDirectory(d.config.FS_ROOT_DIR,{create:!1},function(f){f.getFile(c,{create:!1},function(c){c.moveTo(f,b,function(b){b&&d.info("succesfully renamed");a&&a(!0)},function(b){e.errorHandler(b,
a)})},function(b){e.errorHandler(b,a)})},function(b){e.errorHandler(b,a)})},write:function(c,b,a,e){c=c.replace("peer5://","");b=new Blob([b]);d.debug("Writing to resource "+c);this._writeAvailable()?(this._addWriteCommand(c,b,a,e),this._write(c,b,a,e)):this.currentlyWriting?this._addWriteCommand(c,b,a,e):this.continueWriting()},continueWriting:function(){var c=this.writeQueue.peek();this._write(c.resourceId,c.data,c.position,c.cb)},read:function(c,b,a,e){c=c.replace("peer5://","");var f=this;this.fs.root.getFile(d.config.FS_ROOT_DIR+
c,{},function(c){c.file(function(c){var d=new FileReader;d.onloadend=function(a){a.target.readyState!=FileReader.DONE||a.target.error||e&&e(!0,new Uint8Array(a.target.result))};d.onerror=function(a){f.errorHandler(a,e)};c=c.slice(b,a);d.readAsArrayBuffer(c)},function(a){f.errorHandler(a,e)})},function(a){f.errorHandler(a,e)})},getBlob:function(c,b,a,e){c=c.replace("peer5://","");var f=this;this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{},function(c){c.file(function(c){c=c.slice(b,a);e(!0,c)},function(a){f.errorHandler(a,
e)})},function(a){f.errorHandler(a,e)})},getArrayBuffer:function(c,b,a,e){c=c.replace("peer5://","");var f=this;this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{},function(c){c.file(function(c){var f=new FileReader;f.onloadend=function(a){a.target.readyState==FileReader.DONE?(d.log("getArrayBuffer::onloadend returned: "+f.readyState),e(!0,a.target.result)):d.error("getArrayBuffer::onloadend returned with error: "+f.readyState)};c=c.slice(b,a);f.readAsArrayBuffer(c)},function(a){f.errorHandler(a,e)})},
function(a){f.errorHandler(a,e)})},getResourceDetails:function(c,b){c=c.replace("peer5://","");var a=this;this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{},function(c){c.file(function(a){b(!0,{size:a.size})},function(c){a.errorHandler(c,b)})},function(c){a.errorHandler(c,b)})},createObjectURL:function(c,b){c=c.replace("peer5://","");var a=this;this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{},function(a){b&&b(!0,a.toURL())},function(c){a.errorHandler(c,b)})},notifyFinishWrite:function(c){0>=this.writeQueue.getLength()?
c():this.finishWriteCbs.push(c)},isExist:function(c,b){c=c.replace("peer5://","");d.log("Checking if resource "+c+" exists in the filesystem.");var a=this;this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{create:!1},function(a){b&&b(!0)},function(c){a.errorHandler(c,b)})},getFileInfo:function(c,b){this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{create:!1},function(a){a.file(function(a){console.log(a)})})},listFiles:function(c){var b=this;this.fs.root.createReader().readEntries(function(a){a.length?d.debug("Filesystem files: "+
a):d.debug("Filesystem is empty");c(!0,a)},function(a){b.errorHandler(a,c)})},removeAll:function(c){d.warn("removing all files in filesystem");var b=this;this.fs.root.createReader().readEntries(function(a){for(var e,f=0;e=a[f];++f)e.isDirectory?e.removeRecursively(function(){c&&c(!0)},function(a){b.errorHandler(a,c)}):e.remove(function(){c&&c(!0)},function(a){b.errorHandler(a,c)});d.debug("Directory emptied.")},function(a){b.errorHandler(a,c)})},removeRootDir:function(c){d.warn("removing all files in filesystem under "+
d.config.FS_ROOT_DIR);var b=this;this.fs.root.createReader().readEntries(function(a){for(var e,f=0;e=a[f];++f)e.isDirectory&&e.name+"/"==d.config.FS_ROOT_DIR&&e.removeRecursively(function(){b.fs.root.getDirectory(d.config.FS_ROOT_DIR,{create:!0},function(a){c(!0)},function(a){b.errorHandler(a,c)})},function(a){b.errorHandler(a,c)});d.debug("Directory emptied.")},function(a){b.errorHandler(a,c)})},getLibraryStatistics:function(c){var b=this,a=[],e=[];this.fs&&this.fs.root.getDirectory(d.config.FS_ROOT_DIR,
{},function(d){d.createReader().readEntries(function(d){for(var f=0;f<d.length;f++)a.push(d[f]),e.push(d[f].name);b.getStatsOfFileArray(0,{size:0,filesStats:[]},a,e,function(a){c&&c(a)})})},function(a){b.errorHandler(a,c)})},printDirectory:function(){this.fs&&this.fs.root.getDirectory(d.config.FS_ROOT_DIR,{},function(c){c.createReader().readEntries(function(b){for(var a=0;a<b.length;a++)console.log(b[a].name)})},function(c){console.log(c)})},getStatsOfFileArray:function(c,b,a,d,f){var g=this;if(c==
a.length)f&&f(b);else{var h=a[c];h.file(function(k){var l=k.size;b.size+=l;b.filesStats.push({key:k.name,size:l,lastModified:k.lastModifiedDate,fileInstance:h});g.getStatsOfFileArray(c+1,b,a,d,f)})}},deleteFiles:function(c,b,a){var d=[],f;for(f in c)d.push(c[f]);b.deleteMultipleFiles(0,d,b,a)},deleteMultipleFiles:function(c,b,a,d){c==b.length?d&&d(!0):b[c].fileInstance.remove(function(){a.deleteMultipleFiles(c+1,b,a,d)},function(b){a.errorHandler(b,d)})},removeAllButThis:function(c,b,a){c=c.replace("peer5://",
"");b=b.replace("peer5://","");d.info("removing all files in filesystem under "+d.config.FS_ROOT_DIR+" besides "+c+","+b);var e=this;this.fs.root.getDirectory(d.config.FS_ROOT_DIR,{},function(d){d.createReader().readEntries(function(d){for(var f,k=d.length,l=0;f=d[l];++l)f.name!=c&&f.name!=b?f.isDirectory?f.removeRecursively(function(){k--;0===k&&a(!0)},function(b){e.errorHandler(b,a)}):f.remove(function(){k--;0===k&&a(!0)},function(b){e.errorHandler(b,a)}):k--})},function(b){e.errorHandler(b,a)});
e=this;this.fs.root.createReader().readEntries(function(b){for(var c,h=0;c=b[h];++h)c.isDirectory&&c.name+"/"==d.config.FS_ROOT_DIR&&c.removeRecursively(function(){e.fs.root.getDirectory(d.config.FS_ROOT_DIR,{create:!0},function(b){a(!0)},function(b){e.errorHandler(b,a)})},function(b){e.errorHandler(b,a)});d.debug("Directory emptied.")},function(b){e.errorHandler(b,a)})},getTypeOfFS:function(){if(this.fs){if(-1<this.fs.name.indexOf("Pers"))return"PERS";if(-1<this.fs.name.indexOf("Temp"))return"TEMP"}return null},
getUnUsedQuotaSpace:function(c){"PERS"==this.getTypeOfFS()&&navigator.webkitPersistentStorage.queryUsageAndQuota(function(b,a){c&&c(a-b)},function(b){c&&c(0)});"TEMP"==this.getTypeOfFS()&&navigator.webkitTemporaryStorage.queryUsageAndQuota(function(b,a){c&&c(a-b)},function(b){c&&c(0)})},requestTempQuota:function(c,b){c||(c=16106127360);b||(b=function(){});d.info("requesting quota size = "+c);var a=this;window.webkitRequestFileSystem(window.TEMPORARY,1.1*c,function(c){a.onInitFs(c);a.queryTempQuota(function(a,
c,d){b(!0,d-c)})},function(c){a.errorHandler(c,b)})},testRequestPersQuota:function(c){c||(c=16106127360);navigator.webkitPersistentStorage.requestQuota(c,function(b){console.log("requestQuota and got: "+b)},function(b){console.log("requestQuota Error "+b)})},testRequestTempQuota:function(c){c||(c=32212254720);navigator.webkitTemporaryStorage.requestQuota(c,function(b){console.log("requestQuota and got: "+b)},function(b){console.log("requestQuota Error "+b)})},testPersQueryUsageAndQuota:function(){navigator.webkitPersistentStorage.queryUsageAndQuota(function(c,
b){console.log("Used quota: "+c+", total quota: "+b)},function(c){console.log("Error",c)})},testTempQueryUsageAndQuota:function(){navigator.webkitTemporaryStorage.queryUsageAndQuota(function(c,b){console.log("Used quota: "+c+", total quota: "+b)},function(c){console.log("Error",c)})},requestPersQuota:function(c,b){c||(c=16106127360);b||(b=function(){});d.info("requesting perma quota size = "+c);var a=this,e=c,f=!1;radio("requestedPersQuota").broadcast();radio("peer5_persistent_fd_auth").broadcast();
navigator.webkitPersistentStorage.requestQuota(e,function(c){if(!f){if(f=!0,0===c)return radio("persQuotaAnswer").broadcast(!1),void(b&&b(!1));window.webkitRequestFileSystem(window.PERSISTENT,c,function(c){radio("persQuotaAnswer").broadcast(!0);a.onInitFs(c);a.queryPersQuota(function(a,c,d){b(!0,d-c)})},function(c){a.errorHandler(c,b);radio("persQuotaAnswer").broadcast(!1)});radio("peer5_persistent_fd_auth_finish").broadcast()}},function(c){a.errorHandler(c,b);radio("persQuotaAnswer").broadcast(!1)});
window.setTimeout(function(){f||(f=!0,b(!1),radio("persQuotaTimeout").broadcast())},d.config.PROMPT_TIMEOUT)},queryTempQuota:function(c){navigator.webkitTemporaryStorage.queryUsageAndQuota(function(b,a){d.info("Using: "+b/a*100+"% of temporary storage");c&&c(!0,b,a)},function(b){d.error("Error",b);c&&c(!1)})},queryPersQuota:function(c){navigator.webkitPersistentStorage.queryUsageAndQuota(function(b,a){d.info("Using: "+b/a*100+"% of persistent storage");c&&c(!0,b,a)},function(b){d.error("Error",b);
c&&c(!1)})},_writeAvailable:function(){return this.writeQueue.isEmpty()},_write:function(c,b,a,e){c=c.replace("peer5://","");var f=this;f.currentlyWriting=!0;this.fs.root.getFile(d.config.FS_ROOT_DIR+c,{create:!1},function(g){g.createWriter(function(g){a>g.length?(d.debug("truncating: filewriter length = "+g.length+" position = "+a),g.onwriteend=function(d){return f.currentlyWriting=!1,d.target.error?(f.errorHandler(g.error,e),void f.writeQueue.dequeue()):void f._write(c,b,a,e)},g.truncate(a)):(g.onwriteend=
function(a){if(f.currentlyWriting=!1,a.currentTarget.error)return void f.errorHandler(a.currentTarget.error,e);if(f.writeQueue.dequeue(),d.debug("onwriteend( "+c+"): writeQueue length = "+f.writeQueue.getLength()),f.writeQueue.isEmpty()){e&&setTimeout(function(){e(!0)},0);d.debug("finished writing all the commands in command queue");d.debug("writeQueue is empty, pendingObjectUrlCb = "+f.pendingObjectUrlCb[c]);f.pendingObjectUrlCb[c]&&(f.createObjectURL(c,f.pendingObjectUrlCb[c]),delete f.pendingObjectUrlCb[c]);
for(a=0;a<f.finishWriteCbs.length;++a)f.finishWriteCbs[a](c);f.finishWriteCbs=[]}else e&&setTimeout(function(){e(!0)},0),a=f.writeQueue.peek(),f._write(a.resourceId,a.data,a.position,a.cb)},g.onerror=function(a){f.currentlyWriting=!1;f.errorHandler(a.currentTarget.error,e)},d.debug("data size = "+b.size+" fileWriter.length = "+g.length+" position = "+a),g.seek(a),g.write(b))},function(a){f.currentlyWriting=!1;f.errorHandler(a,e)})},function(a){f.currentlyWriting=!1;f.errorHandler(a,e)})},_addWriteCommand:function(c,
b,a,d){c=c.replace("peer5://","");this.writeQueue.enqueue({resourceId:c,data:b,position:a,cb:d})},testQuota:function(){window.webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.TEMPORARY,function(c,b){console.log("Used quota: "+c+", remaining quota: "+b)},function(c){console.log("Error",c)})},registerEvents:function(){var c=this;this.onInitFs=function(b){c.fs=b;b.root.getDirectory(d.config.FS_ROOT_DIR,{create:!0},function(a){d.info("initiated filesystem")},function(a){c.errorHandler(a);d.warn("failed to create peer5 directory")})};
this.errorHandler=function(b,a){var c="";switch(b.name){case "QuotaExceededError":c="QuotaExceededError";a&&a(!1,"space");break;case "NotFoundError":c="NotFoundError";a&&a(!1);break;case "SecurityError":c="SecurityError";a&&a(!1);break;case "InvalidModificationError":c="InvalidModificationError";a&&a(!1);break;case "InvalidStateError":c="InvalidStateError";a&&a(!1);break;default:c="Unknown Error",a&&a(!1)}radio("offlineStorageError").broadcast(c);d.warn("File system error: "+c)}}});d.core.data.FSio=
new d.core.data.FSio})();(function(){d.core.data.FSioFireFox=Object.subClass({ctor:function(c){this.writeQueue=new D;this.executeOnInit=[];this.registerEvents();this.pendingObjectUrlCb={};this.finishWriteCbs=[];this.db;this.filesObjectStore="files";this.filesMetaData={};this.flushSize=67108864;this.currentlyWriting=!1;var b=this;this.createTempDB(function(a){a?(b.createMainDB(function(a){a?d.info("mainDB created successfuly"):d.warn("mainDB creation had error");c(a)}),d.info("tmpDB created successfuly")):
d.warn("tmpDB creation had error")})},createTempDB:function(c){var b=this,a=window.indexedDB.open(d.config.FS_ROOT_DIR,{version:4,storage:"temporary"});a.onerror=function(a){b.errorHandler(a);console.log(a);c&&c(!1)};a.onupgradeneeded=function(a){a.target.result.createObjectStore(b.filesObjectStore)};a.onsuccess=function(a){b.tempStorageDB=a.target.result;c&&c(!0)}},actualCreationOfmainDB:function(c){var b=this,a=window.indexedDB.open(d.config.FS_ROOT_DIR,{version:4,storage:"persistent"});a.onerror=
function(a){b.errorHandler(a);console.log(a);c&&c(!1)};a.onupgradeneeded=function(a){a.target.result.createObjectStore(b.filesObjectStore)};a.onsuccess=function(a){b.db=a.target.result;for(a=0;a<b.executeOnInit.length;a++)d.core.util.envokeCallback(b.executeOnInit[a]["function"],b.executeOnInit[a].args,b.executeOnInit[a].context);c&&c(!0)}},createMainDB:function(c,b){var a=this;b?a.actualCreationOfmainDB(c):a.isExist("confirmed_persistent",function(b){b?a.actualCreationOfmainDB(c):c&&c(!0)},a.tempStorageDB)},
executeOnReady:function(c){this.executeOnInit.push(c)},createResource:function(c,b,a){var e=this;a||(a=e.db);d.info("Adding resource "+c+" to the indexedDB.");var e=this,f=a.mozCreateFileHandle(c);f.onsuccess=function(d){d=this.result;d=a.transaction([e.filesObjectStore],"readwrite").objectStore(e.filesObjectStore).put(d,c);d.onsuccess=function(a){e.filesMetaData[c]={fileLength:0,appendedSinceLastFlush:0};b&&b(!0)};d.onerror=function(a){e.errorHandler(a);b&&b(!1)}};f.onerror=function(a){e.errorHandler(a);
b&&b(!1)}},removeResource:function(c,b){d.log("Removing resource "+c+" from the filesystem.");var a=this,e=a.db.transaction([a.filesObjectStore],"readwrite").objectStore(a.filesObjectStore)["delete"](c);e.onsuccess=function(d){delete a.filesMetaData[c];b&&b(!0)};e.onerror=function(c){a.errorHandler(c);b&&b(!1)}},renameResource:function(c,b,a){d.info("changing resource name from "+c+" to "+b);var e=this,f=e.db.transaction([e.filesObjectStore],"readwrite").objectStore(e.filesObjectStore),g=f.get(c);
g.onsuccess=function(h){if(!h.target.result)return e.errorHandler({code:"record was not found for key"+c}),void(a&&a(!1));h=f.put(g.result,b);e.filesMetaData[b]=e.filesMetaData[c];h.onsuccess=function(b){b=e.db.transaction([e.filesObjectStore],"readwrite").objectStore(e.filesObjectStore)["delete"](c);b.onsuccess=function(b){delete e.filesMetaData[c];d.info("succesfully renamed");a&&a(!0)};b.onerror=function(b){e.errorHandler(b);a&&a(!1)}};h.onerror=function(b){e.errorHandler(b);a&&a(!1)}};g.onerror=
function(b){e.errorHandler(b);a&&a(!1)}},write:function(c,b,a,e){d.debug("Writing to resource "+c);b||d.error("Writing to resource "+c+" with no data: "+b);this._writeAvailable()?(this._addWriteCommand(c,b,a,e),this._write(c,b,a,e)):this.currentlyWriting?this._addWriteCommand(c,b,a,e):this.continueWriting()},continueWriting:function(){var c=this.writeQueue.peek();this._write(c.resourceId,c.data,c.position,c.cb)},read:function(c,b,a,d){var f=this,g=f.db.transaction(["files"]).objectStore("files").get(c);
g.onsuccess=function(h){if(!h.target.result)return f.errorHandler({code:"record was not found for key"+c}),void(d&&d(!1));h=g.result.open("readwrite");h.location=b;h=h.readAsArrayBuffer(a-b);h.onsuccess=function(a){d&&d(!0,new Uint8Array(a.target.result))};h.onerror=function(a){f.errorHandler(a);d&&d(!1)}};g.onerror=function(a){f.errorHandler(a);d&&d(!1)}},getBlob:function(c,b,a,d){},getResourceDetails:function(c,b){var a=this,d=a.db.transaction([a.filesObjectStore],"readwrite").objectStore(a.filesObjectStore).get(c);
d.onsuccess=function(f){if(!f.target.result)return a.errorHandler({code:"record was not found for key"+c}),void(b&&b(!1));f=d.result.open("readwrite").getMetadata();f.onsuccess=function(a){b(!0,{size:a.target.result.size})};f.onerror=function(c){a.errorHandler(c);b&&b(!1)}};d.onerror=function(c){a.errorHandler(c);b&&b(!1)}},createObjectURL:function(c,b){var a=this,d=a.db.transaction([a.filesObjectStore],"readwrite").objectStore(a.filesObjectStore).get(c);d.onsuccess=function(f){if(!f.target.result)return a.errorHandler({code:"record was not found for key"+
c}),void(b&&b(!1));var g=d.result,h=g.open("readwrite");a.checkAndFlush(h,a,c,function(c){c=(h.name,g.getFile());c.onsuccess=function(a){a=a.target.result;!window.URL&&window.webkitURL&&(window.URL=window.webkitURL);b&&b(!0,URL.createObjectURL(a))};c.onerror=function(c){a.errorHandler(c);b&&b(!1)}},!0)};d.onerror=function(c){a.errorHandler(c);b&&b(!1)}},notifyFinishWrite:function(c){0>=this.writeQueue.getLength()?c():this.finishWriteCbs.push(c)},isExistConfirmedPersistent:function(c,b){b(localStorage.confirmedPersistent?
!0:!1)},isExist:function(c,b,a){var e=this;a||(a=e.db);d.log("Checking if resource "+c+" exists in the filesystem.");try{var f=a.transaction([e.filesObjectStore],"readwrite").objectStore(e.filesObjectStore)}catch(g){console.log(g)}if(!f)return void(b&&b(!1));a=f.get(c);a.onsuccess=function(a){if(!a.target.result)return void(b&&b(!1));a=a.target.result.open("readonly").getMetadata();a.onsuccess=function(a){e.filesMetaData[c]={fileLength:a.target.result.size,appendedSinceLastFlush:0};b&&b(!0)};a.onerror=
function(a){e.errorHandler(a);b&&b(!1)}};a.onerror=function(a){e.errorHandler(a);b&&b(!1)}},listFiles:function(c){var b=!0;this.db.transaction([this.filesObjectStore],"readwrite").objectStore(this.filesObjectStore).openCursor().onsuccess=function(a){var e=[];a=a.target.result;b&&!a&&d.debug("Filesystem is empty");a?(b=!1,e.push(a.key),a["continue"]()):(c(!0,e),alert("No more entries!"))}},forceRemoveAllDBwhenOutOfSpace:function(c){this.db.close();window.indexedDB.deleteDatabase(d.config.FS_ROOT_DIR);
this.createMainDB(function(b){b?c&&c(!0):c&&c(!1)})},removeAllNew:function(){var c=this.db.transaction([this.filesObjectStore],"readwrite").objectStore(this.filesObjectStore).clear();c.onsuccess=function(b){console.log("Filesystem is empty")};c.onerror=function(b){console.log("removeAll() failed")}},removeDep:function(c){d.warn("removing all files in filesystem");var b=this,a=b.db.transaction([b.filesObjectStore],"readwrite").objectStore(b.filesObjectStore),e=!0;a.openCursor().onsuccess=function(f){var g=
f.target.result;(e&&!g&&d.debug("Filesystem is empty"),g)?(e=!1,f=a["delete"](g.key),f.onsuccess=function(a){b.filesMetaData[g.key]&&delete b.filesMetaData[g.key];g["continue"]()},f.onerror=function(a){c&&c(!1)}):(d.debug("Directory emptied."),c&&c(!0))}},getAllKeys:function(c,b){d.warn("removing all files in filesystem");var a=[],e=[];this.db.transaction([this.filesObjectStore],"readwrite").objectStore(this.filesObjectStore).openCursor().onsuccess=function(d){(d=d.target.result)?"confirmed_persistent"!=
d.key||b?(a.push(d.key),e.push(d.value),d["continue"]()):d["continue"]():(console.log("get all keys : "+a.length),console.log("get all keys : "+e.length),c&&c(e,a))}},filterEntries:function(c,b,a,d){var f=this;c==b.length?d&&d(b,a):b[c].open("readwrite").getMetadata().onsuccess=function(g){g=g.target.result.lastModified;24<Date.now()-g.getTime()?f.filterEntries(c+1,b,a,d):(b.splice(c,1),a.splice(c,1),f.filterEntries(c,b,a,d))}},getStatsOfFileArray:function(c,b,a,d,f){var g=this;c==a.length?f&&f(b):
a[c].open("readwrite").getMetadata().onsuccess=function(h){var k=h.target.result.size;h=h.target.result.lastModified;b.size+=k;b.filesStats.push({key:d[c],size:k,lastModified:h,fileInstance:a[c]});g.getStatsOfFileArray(c+1,b,a,d,f)}},printDirectory:function(){this.getAllKeys(function(c,b){for(var a=0;a<b.length;a++)console.log(b[a])},!0)},cleanSpaceForFileDuringOutOfSpace:function(c,b){},getLibraryStatistics:function(c){var b=this;b.getAllKeys(function(a,d){b.getStatsOfFileArray(0,{size:0,filesStats:[]},
a,d,function(a){c&&c(a)})})},removeOldEntries:function(c){var b=this;b.getAllKeys(function(a,d){console.log("removeOldEntries "+d);console.log("removeOldEntries "+a);b.filterEntries(0,a,d,function(a,d){console.log("truncating");b.truncateFiles(0,a,b,function(a){a?(console.log("done truncating successfully"),b.deleteMultipleFiles(0,d,b,function(a){a?(c&&c(!0),console.log("done removeOldEntries successfully")):(console.log("done removeOldEntries failure"),c&&c(!1))})):(console.log("done truncating failure"),
c&&c(!1))})})})},deleteFiles:function(c,b,a){var d=[],f=[],g;for(g in c)f.push(c[g].key),d.push(c[g].fileInstance);b.truncateFiles(0,d,b,function(c){c?(console.log("done truncating successfully"),b.deleteMultipleFiles(0,f,b,function(b){b?a&&a(!0):(a&&a(!1),console.log("delete failure"))})):(console.log("truncating failure"),a&&a(!1))})},removeAll:function(c){var b=this;b.getAllKeys(function(a,d){console.log("truncating");for(var f=0;f<d.length;f++)if("confirmed_persistent"==d[f]){d.splice(f,1);a.splice(f,
1);break}b.truncateFiles(0,a,b,function(a){a?(console.log("done truncating all files successfully"),b.deleteMultipleFiles(0,d,b,function(a){a?(c&&c(!0),console.log("done removeAll successfully")):(console.log("done removeAll failure"),c&&c(!1))})):(console.log("done truncating failure"),c&&c(!1))})})},deleteMultipleFiles:function(c,b,a,e){if(c==b.length)e&&e(!0);else{var f=a.db.transaction([a.filesObjectStore],"readwrite").objectStore(a.filesObjectStore)["delete"](b[c]);f.onsuccess=function(){a.deleteMultipleFiles(c+
1,b,a,e)};f.onerror=function(a){d.error("delete multiple files error");e&&e(!1)}}},truncateFiles:function(c,b,a,e){if(c==b.length)e&&e(!0);else{console.log("truncating "+b[c]);var f=b[c].open("readwrite").truncate(0);f.onsuccess=function(){a.truncateFiles(c+1,b,a,e)};f.onerror=function(a){d.error("truncate needed files failure");e&&e(!1)}}},removeRootDir:function(c){this.removeAll(c)},requestPersQuota:function(c,b,a){var e=this;e.isExist("confirmed_persistent",function(c){return c?void b(!0,d.config.PERSISTENT_FS_SIZE):
a<=d.config.ALLOWED_FILE_SIZE?void b(!1,0):void e.createMainDB(function(a){a?e.createResource("confirmed_persistent",function(a){return a?(d.info("mainDB created in requestPersQuota successfuly"),localStorage.confirmedPersistent=!0,radio("persQuotaAnswer").broadcast(!0),void b(!0,d.config.PERSISTENT_FS_SIZE)):(d.warn("mainDB creation in requestPersQuota had error"),void b(!1,0))},e.tempStorageDB):(d.warn("mainDB creation had error"),b(!1,0));window.setTimeout(function(){localStorage.confirmedPersistent||
(radio("persQuotaTimeout").broadcast(),b(!1,0))},d.config.PROMPT_TIMEOUT);b(a)},!0)},e.tempStorageDB)},requestPersQuota1:function(c,b,a){var e=this;e.isExist("confirmed_persistent",function(c){if(c)return void b(!0,d.config.PERSISTENT_FS_SIZE);if(a<=d.config.ALLOWED_FILE_SIZE)return void b(!1,0);radio("requestedPersQuota").broadcast();radio("peer5_persistent_fd_auth").broadcast();var g,h=(new Date).getTime()+100,k=window.indexedDB.open(h,1),l=!1;k.onerror=function(a){console.log("Error obtaining quota, retrying...");
b(!1,0)};k.onsuccess=function(a){g=k.result;k.getquota()};k.onupgradeneeded=function(a){a.target.result.createObjectStore(h)};k.getquota=function(){var a=g.transaction(h,"readwrite");a.oncomplete=function(){g.close();window.indexedDB.deleteDatabase(h);e.createResource("confirmed_persistent",function(a){if(!l){if(l=!0,!a)return void b(!1,0);radio("persQuotaAnswer").broadcast(!0);b(!0,d.config.PERSISTENT_FS_SIZE)}},!0)};a.onerror=function(a){return l?void 0:(l=!0,radio("persQuotaAnswer").broadcast(!1),
g.close(),window.indexedDB.deleteDatabase(h),void b(!1,0))};a.objectStore(h).put(new Blob([new ArrayBuffer(62914560)]),"quota");window.setTimeout(function(){l||(a.oncomplete=function(){},a.onerror=function(){},radio("persQuotaTimeout").broadcast(),g.close(),window.indexedDB.deleteDatabase(h),b(!1,0))},d.config.PROMPT_TIMEOUT)}})},requestTempQuota:function(c,b){d.warn("requestTempQuota shouldn't be called in firefox")},queryPersQuota1:function(c){this.isExist("confirmed_persistent",function(b){return b?
void c(!0,0,d.config.PERSISTENT_FS_SIZE):void c(!1,0,0)})},queryPersQuota:function(c){this.isExist("confirmed_persistent",function(b){return b?void c(!0,0,d.config.PERSISTENT_FS_SIZE):void c(!1,0,0)},this.tempStorageDB)},queryTempQuota:function(c){c(!1,0,0)},_writeAvailable:function(){return this.writeQueue.isEmpty()},_write_dep:function(c,b,a,e){var f=this,g=window.indexedDB.open(d.config.FS_ROOT_DIR,3);g.onerror=function(a){f.errorHandler(a);e&&e(!1)};g.onsuccess=function(h){f.db=g.result;var k=
f.db.transaction([f.filesObjectStore],"readwrite").objectStore(f.filesObjectStore).get(c);k.onsuccess=function(g){if(!g.target.result)return f.errorHandler({code:"record was not found for key"+c}),void(e&&e(!1));var h=k.result;g=h.open("readwrite").getMetadata();g.onsuccess=function(g){var k=g.target.result.size;a>k?(d.debug("truncating: filewriter length = "+g.target.result.size+" position = "+a),g=new FileReader,g.onload=function(b){b=b.target.result;var g=h.open("readwrite");g.oncomplete=function(){if(f.writeQueue.dequeue(),
d.debug("onwriteend( "+c+"): writeQueue length = "+f.writeQueue.getLength()),f.writeQueue.isEmpty()){e&&e(!0);d.debug("finished writing all the commands in command queue");d.debug("writeQueue is empty, pendingObjectUrlCb = "+f.pendingObjectUrlCb[c]);f.pendingObjectUrlCb[c]&&(f.createObjectURL(c,f.pendingObjectUrlCb[c]),delete f.pendingObjectUrlCb[c]);for(var a=0;a<f.finishWriteCbs.length;++a)f.finishWriteCbs[a](c);f.finishWriteCbs=[]}else e&&e(!0),a=f.writeQueue.peek(),f._write(a.resourceId,a.data,
a.position,a.cb)};for(var l=a-k,n=0,u=new ArrayBuffer(1048576);l>n;)1048576>l-n&&(u=new ArrayBuffer(l-n)),n+=1048576,g.append(u);g.append(b).onerror=function(a){f.errorHandler(a);e&&e(!1)}}):(g=new FileReader,g.onload=function(b){b=b.target.result;var g=h.open("readwrite");g.location=a;var k=g.write(b);if(k||0!=a||0!=b.byteLength)k.onsuccess=function(){var a=g.flush();a.onsuccess=function(a){if(f.writeQueue.dequeue(),d.debug("onwriteend( "+c+"): writeQueue length = "+f.writeQueue.getLength()),f.writeQueue.isEmpty()){e&&
e(!0);d.debug("finished writing all the commands in command queue");d.debug("writeQueue is empty, pendingObjectUrlCb = "+f.pendingObjectUrlCb[c]);f.pendingObjectUrlCb[c]&&(f.createObjectURL(c,f.pendingObjectUrlCb[c]),delete f.pendingObjectUrlCb[c]);for(a=0;a<f.finishWriteCbs.length;++a)f.finishWriteCbs[a](c);f.finishWriteCbs=[]}else e&&e(!0),d.debug("onwriteend: writeQueue is not empty, writing another command"),a=f.writeQueue.peek(),f._write(a.resourceId,a.data,a.position,a.cb)};a.onerror=function(a){f.errorHandler(a);
e&&e(!1)}},k.onerror=function(a){f.errorHandler(a);e&&e(!1)};else if(f.writeQueue.dequeue(),d.debug("onwriteend( "+c+"): writeQueue length = "+f.writeQueue.getLength()),e&&e(!0),f.writeQueue.isEmpty()){d.debug("finished writing all the commands in command queue");d.debug("writeQueue is empty, pendingObjectUrlCb = "+f.pendingObjectUrlCb[c]);f.pendingObjectUrlCb[c]&&(f.createObjectURL(c,f.pendingObjectUrlCb[c]),delete f.pendingObjectUrlCb[c]);for(b=0;b<f.finishWriteCbs.length;++b)f.finishWriteCbs[b](c);
f.finishWriteCbs=[]}else b=f.writeQueue.peek(),f._write(b.resourceId,b.data,b.position,b.cb)});g.readAsArrayBuffer(b)};g.onerror=function(a){f.errorHandler(a);e&&e(!1)}};k.onerror=function(a){f.errorHandler(a);e&&e(!1)}}},_write_no_flush:function(c,b,a,e){var f=this,g=window.indexedDB.open(d.config.FS_ROOT_DIR,3);g.onerror=function(a){f.errorHandler(a);e&&e(!1)};g.onsuccess=function(h){f.db=g.result;var k=f.db.transaction([f.filesObjectStore],"readwrite").objectStore(f.filesObjectStore).get(c);k.onsuccess=
function(g){if(!g.target.result)return f.errorHandler({code:"record was not found for key"+c}),void(e&&e(!1));var h=k.result;g=h.open("readwrite").getMetadata();g.onsuccess=function(g){var k=g.target.result.size;if(a>k)d.debug("truncating: filewriter length = "+g.target.result.size+" position = "+a),g=h.open("readwrite"),f.appendZerosBeforeRealData(g,c,a-k,b.buffer,!1,e,function(){f.performAfterWriteOperations(c,e)});else{g=h.open("readwrite");g.location=a;k=g.write(b.buffer);if(!k&&0==a&&0==b.buffer.byteLength)return void f.performAfterWriteOperations(c,
e);k.onsuccess=function(){f.performAfterWriteOperations(c,e)};k.onerror=function(a){f.currentlyWriting=!1;f.errorHandler(a);e&&e(!1)}}};g.onerror=function(a){f.currentlyWriting=!1;f.errorHandler(a);e&&e(!1)}};k.onerror=function(a){f.currentlyWriting=!1;f.errorHandler(a);e&&e(!1)}}},_write:function(c,b,a,e){var f=this,g=f.db.transaction([f.filesObjectStore],"readwrite").objectStore(f.filesObjectStore).get(c);f.currentlyWriting=!0;g.onsuccess=function(h){if(!h.target.result)return f.currentlyWriting=
!1,f.errorHandler({code:"record was not found for key"+c}),void(e&&e(!1));var k=g.result,l=k.open("readwrite");if(f.filesMetaData[c]){var p=f.filesMetaData[c].fileLength;if(f.filesMetaData[c].fileLength=Math.max(p,a+b.buffer.byteLength),a>p)d.debug("truncating: filewriter length = "+h.target.result.size+" position = "+a),l=k.open("readwrite"),f.appendZerosBeforeRealData(l,c,a-p,b.buffer,!1,e,function(){f.performAfterWriteOperations(c,e)});else{l=k.open("readwrite");l.location=a;h=l.write(b.buffer);
if(!h&&0==b.buffer.byteLength)return void f.performAfterWriteOperations(c,e);h.onsuccess=function(){f.filesMetaData[c].appendedSinceLastFlush+=b.buffer.byteLength;f.performAfterWriteOperations(c,e);f.checkAndFlush(l,f,c,function(a){a||console.log("checkAndFlush error")},!1)};h.onerror=function(a){f.errorHandler(a);e&&e(!1)}}}};g.onerror=function(a){f.errorHandler(a);e&&e(!1)}},performAfterWriteOperations:function(c,b){if(this.writeQueue.dequeue(),this.currentlyWriting=!1,d.debug("onwriteend( "+c+
"): writeQueue length = "+this.writeQueue.getLength()),this.writeQueue.isEmpty()){b&&setTimeout(function(){b(!0)},0);d.debug("finished writing all the commands in command queue");d.debug("writeQueue is empty, pendingObjectUrlCb = "+this.pendingObjectUrlCb[c]);this.pendingObjectUrlCb[c]&&(this.createObjectURL(c,this.pendingObjectUrlCb[c]),delete this.pendingObjectUrlCb[c]);for(var a=0;a<this.finishWriteCbs.length;++a)this.finishWriteCbs[a](c);this.finishWriteCbs=[]}else b&&setTimeout(function(){b(!0)},
0),d.debug("onwriteend: writeQueue is not empty, writing another command"),a=this.writeQueue.peek(),this._write(a.resourceId,a.data,a.position,a.cb)},_addWriteCommand:function(c,b,a,d){this.writeQueue.enqueue({resourceId:c,data:b,position:a,cb:d})},appendZerosBeforeRealData:function(c,b,a,d,f,g,h){var k=this;f?0<d.byteLength?(f=c.append(d),f.onsuccess=function(){k.filesMetaData[b].appendedSinceLastFlush+=d.byteLength;h&&h()},f.onerror=function(){k.currentlyWriting=!1;k.writeQueue.dequeue();g&&g(!1)}):
h&&h():67108864<=a?(f=c.append(new ArrayBuffer(67108864)),f.onsuccess=function(){var f=c.flush();f.onsuccess=function(f){k.appendZerosBeforeRealData(c,b,a-67108864,d,!1,g,h)};f.onerror=function(a){}},f.onerror=function(a){k.currentlyWriting=!1;k.writeQueue.dequeue();"The operation failed for reasons unrelated to the file storage itself and not covered by any other error code."==a.target.error.message&&"UnknownError"==a.target.error.name||"The current locked file exceeded its quota limitations."==
a.target.error.message&&"QuotaExceededError"==a.target.error.name?g&&g(!1,"space"):g&&g(!1)}):0<a?(f=c.append(new ArrayBuffer(a)),f.onsuccess=function(){if(k.filesMetaData[b].appendedSinceLastFlush+=a,k.filesMetaData[b].appendedSinceLastFlush>k.flushSize){var f=c.flush();f.onsuccess=function(a){k.appendZerosBeforeRealData(c,b,0,d,!0,g,h)};f.onerror=function(a){}}else k.appendZerosBeforeRealData(c,b,0,d,!0,g,h)},f.onerror=function(a){"The operation failed for reasons unrelated to the file storage itself and not covered by any other error code."==
a.target.error.message&&"UnknownError"==a.target.error.name||"The current locked file exceeded its quota limitations."==a.target.error.message&&"QuotaExceededError"==a.target.error.name?(k.currentlyWriting=!1,k.writeQueue.dequeue(),g&&g(!1,"space")):g&&g(!1)}):k.appendZerosBeforeRealData(c,b,0,d,!0,g,h)},checkAndFlush:function(c,b,a,d,f){b.filesMetaData[a].appendedSinceLastFlush>b.flushSize||f?(c=c.flush(),c.onsuccess=function(c){b.filesMetaData[a].appendedSinceLastFlush=0;d&&d(!0)},c.onerror=function(a){console.log("flush error in checkAndFlush function")}):
d&&d(!0)},registerEvents:function(){this.errorHandler=function(c){var b="";switch(c.code){default:b=c}radio("offlineStorageError").broadcast(b);d.warn("File system error: "+b)}}})})();(function(c){c.getHttpMeta=function(b,a,c){function f(a,b){radio("xhrBytesReceived").broadcast(a,b)}function g(){radio("httpProgressEvent"+b).broadcast()}function h(c){d.core.dataStructures.PendingBlockMap.removeResource(b);d.info("received bytes "+b);radio("bytesReceivedEvent"+b).unsubscribe(h);radio("stopHttpInit"+
b).unsubscribe(k);radio("xhrBytesReceived"+b).unsubscribe(f);radio("bytesReceivedEvent").broadcast(c);m.stop();a[b]&&(a[b].preventDownload=!1)}function k(){d.info("stopping httpDownloader init "+b);m&&m.stop();p&&radio("responseHeadersReceived"+b).unsubscribe([p,this]);h&&radio("bytesReceivedEvent"+b).unsubscribe(h);f&&radio("xhrBytesReceived"+b).unsubscribe(f);a[b]&&delete a[b].preventDownload}function l(f){m.stop();m=new d.client.HTTPDownloader(b);radio("bytesReceivedEvent"+b).subscribe(function t(g){d.info("received bytes "+
b);radio("bytesReceivedEvent"+b).unsubscribe(t);radio("xhrFailed"+b).unsubscribe(n);radio("xhrTimeout"+b).unsubscribe(n);radio("stopHttpInit"+b).unsubscribe(k);var h=new d.core.util.MD5.ArrayBuffer;h.append(g.dataArray);h.append(new Uint8Array(f.length.toString().split("")));h.append(new Uint8Array(d.config.A_B_CONFIG_JSON.split("")));g=h.end();d.info("SwarmId for url: "+b+" is: "+g);a[b].hashUrl=d.core.util.MD5.hash(b);g=new d.core.protocol.FileInfo(g,f.length,null,null,d.config.BLOCK_SIZE,b);c(g)});
m.download(0,d.config.CHUNKY_HEAD_LENGTH)}function p(q){var r=d.core.util.parseResponseHeaders(q);radio("HTTPHeadersReceived"+b).broadcast(b,q,r);q=Object.create(null);r["content-md5"]&&(q.md5=r["content-md5"]);(r=d.core.util.parseResponseLengthHeader(r["content-range"],r["content-length"]))&&(q.length=r);1<=a[b].state&&d.info("receiveMeta but resource is already initiated");d.info("subscribing stopHttpInit "+b);radio("stopHttpInit"+b).subscribe(k);radio("responseHeadersReceived"+b).unsubscribe(p);
if(q.length)if(!d.config.USE_FS&&q.length>d.config.ALLOWED_FILE_SIZE)q=void radio("removeResource").broadcast(b,d.Request.FILE_SIZE_ERR,"file size too big");else if(q.md5)r=new d.core.protocol.FileInfo(q.md5,q.length,q.md5,null,d.config.BLOCK_SIZE,b),c(r),q.length>d.config.SMALL_FILE_SIZE&&(m.stop(),radio("xhrFailed"+b).unsubscribe(n),radio("xhrTimeout"+b).unsubscribe(n)),q=void 0;else if(q.length<=d.config.SMALL_FILE_SIZE){2!=a[b].mod&&(d.core.dataStructures.PendingBlockMap.addResource(b,q.length),
a[b].preventDownload=!0,radio("bytesReceivedEvent"+b).subscribe(h),radio("xhrBytesReceived"+b).subscribe(f),radio("onprogressEvent "+b).subscribe(g),d.feature.isEnabledAndInitialized(d.config.FEATURE_PROXY_HEAD_KEY)&&(m=new d.client.HTTPDownloader(b),m.download()));var r=d.core.util.urlDigest.swarmId(b),t=d.core.util.MD5.hash(q.length+r+d.config.A_B_CONFIG_JSON);d.core.util.UrlSwarmIdMap.addMapping(b,t);d.info("SwarmId for url: "+b+" is: "+t);a[b].hashUrl=d.core.util.MD5.hash(r);q=new d.core.protocol.FileInfo(t,
q.length,null,null,d.config.BLOCK_SIZE,b);c(q);q=void 0}else q=void l(q);else q=(d.error("no Content-Length in headers for file: "+b),radio("removeResource").broadcast(b,d.Request.FILE_SIZE_ERR,"file size undefined"),void d.feature.disable(d.config.FEATURE_PEER5_REQUEST_KEY));return q}function n(a){radio("xhrFailed"+b).unsubscribe(n);radio("xhrTimeout"+b).unsubscribe(n);radio("responseHeadersReceived"+b).unsubscribe(p);a=a.status;radio("removeResource").broadcast(b,a,"xhr failed or timed out")}var m=
new d.client.HTTPDownloader(b);radio("xhrFailed"+b).subscribe(n);radio("xhrTimeout"+b).subscribe(n);radio("responseHeadersReceived"+b).subscribe(p);d.feature.isEnabledAndInitialized(d.config.FEATURE_PROXY_HEAD_KEY)?m.head():2===a[b].mod?m.head():m.download()}})(d.client);(function(c){c.bypassServer=function(b,a){b.response=a;""!==b.responseType&&"text"!==b.responseType||(b.responseText=a);b.readyState=4;b.responseURL=b._url;b.status=200;for(var c={currentTarget:b,lengthComputable:!0,loaded:a.length,
loadedFS:0,loadedHTTP:a.length,loadedP2P:0,total:a.length},f=0;f<b.eventListeners.readystatechange.length;f++){var g=b.eventListeners.readystatechange[f];d.core.util.envokeCallback(g,[c],b)}d.core.util.envokeCallback(b.onreadystatechange,[c],b);for(f=0;f<b.eventListeners.load.length;f++)g=b.eventListeners.load[f],d.core.util.envokeCallback(g,[c],b);d.core.util.envokeCallback(b.onload,[c],b);for(f=0;f<b.eventListeners.loadend.length;f++)g=b.eventListeners.loadend[f],d.core.util.envokeCallback(g,[c],
b);d.core.util.envokeCallback(b.onloadend,[c],b)}})(d.client);(function(c){var b=d.core.util.UrlSwarmIdMap;d.client.DownloadUploadManager=Object.subClass({name:"peer5.client.DownloadUploadManager",ctor:function(){(this.clientId=d.core.util.generate_uuid(),this.registerEvents(),this.apiValidator=new d.core.apiValidators.ApiValidator({dataChannels:d.core.apiValidators.DataChannelsApiValidator,fileSystem:d.core.apiValidators.FileSystemApiValidator}),this.apiValidator.validate())?(this.validated=!0,this.chunkSize=
d.config.CHUNK_SIZE,this.wsConnectionImpl=new d.core.transport.WsConnection(d.config.WSURL_OVERRIDE||"wss://ws.peer5.com",this.clientId),this.controller=new d.client.HybridController(this.clientId),this.resources=Object.create(null),this.queuedResource=Object.create(null),this.lastReportTime=Date.now(),this.lastStatCalcTime=0,this.cron_interval_id=window.setInterval(this.cron,d.config.MONITOR_INTERVAL,this),radio("peer5_uuid").broadcast(this.clientId)):this.validated=!1;d.core.data.FSio.executeOnReady({"function":this.cleanOldFiles,
args:function(){},context:this});radio("scriptLoaded").broadcast();radio("scriptValidated").broadcast(this.validated)},cleanOldFiles:function(a){this.cleanOldFilesPersistent(this.cleanOldFilesTemporary,a)},cleanOldFilesPersistent:function(a,b){d.core.data.FSio.queryPersQuota(function(c,g,h){d.info("quota is : "+h);0<h?d.core.data.FSio.requestPersQuota(h-1,function(c){c?d.core.data.CacheManager.cleanOldFiles(function(c){d.log("success cleanOldFiles on Persistent FS");a&&a(b)}):a&&a(b)}):a&&a(b)})},
cleanOldFilesTemporary:function(a){d.core.data.FSio.queryTempQuota(function(b,c,g){0<g?d.core.data.FSio.requestTempQuota(d.config.TEMPORARY_FS_SIZE,function(b){b?d.core.data.CacheManager.cleanOldFiles(function(b){d.log("success cleanOldFiles on Persistent FS");a&&a()}):a&&a()}):a&&a()})},getNumOfVerifiedBytes:function(a,b){var c,g=d.core.data.BlockCache.get(a);g&&(c=g.getNumOfVerifiedBytes());b(c)},getBlobUrl:function(a,b){d.core.data.BlockCache.get(a).getBlobUrl(b)},getBlob:function(a,b){d.core.data.BlockCache.get(a).getBlob(b)},
getUint8Array:function(a,b){d.core.data.BlockCache.get(a).getUint8Array(b)},getText:function(a,b){d.core.data.BlockCache.get(a).getText(b)},getClientId:function(a){a(this.clientId)},isValidated:function(a){a(this.validated)},isFull:function(a,b){var c=d.core.data.BlockCache.get(a);b(c.isFull())},addResource:function(a,b,c){if(radio("resourceAdded").broadcast(a),d.info("Adding resource "+a+" with state: "+(this.resources[a]?this.resources[a].state:"null")),this.resources[a]&&0<=this.resources[a].state){if(4>
this.resources[a].state)return d.info("Queuing add resource that is already in progress"),void(this.queuedResource[a]={args:arguments});3==this.resources[a].mod&&2==b&&d.info(a+" was prefetched in http and then p2p");this.resources[a].mod=b;var g=d.core.data.BlockCache.get(a);if(g)var h=g.getMetadata();return h?(this.controller.init(h,!0,this.resources[h.swarmId].mod),radio("fileInfoProcessed").broadcast(h),void radio("resourceReady"+a).broadcast(h)):void d.error("couldn't add resource already exists in unstable state")}(this.resources[a]=
{state:0,mod:b,sha1:c.sha1,md5:c.md5,url:a},-1!=a.indexOf("http"))?this._initiateHttpResource(a):-1!=a.indexOf("peer5://")&&(g=a.slice(8),this.resources[g]=this.resources[a],this.leechSwarm(g))},removeResource:function(a){if(void 0!==this.resources[a]){if(d.info("removeResource: removing resource "+a+" with state: "+this.resources[a].state),!this.resources[a])return void d.error("tried to remove a resource that was already removed: "+a);this.wsConnectionImpl.sendMessage(new d.core.protocol.Leave(this.resources[a].resourceId));
radio("stopHttpInit"+a).broadcast();this.resources[a].state=4;this.controller.removeResource(a);d.core.stats.StatsCollector.removeResource(a,this.resources[a].resourceId);d.core.data.BlockCache.remove(a);this.resources[a]&&this.resources[a].swarmId&&this.resources[this.resources[a].swarmId]&&delete this.resources[this.resources[a].swarmId];this.resources[a]&&delete this.resources[a];this._unqueueResource(a)}},stopResource:function(a){void 0!==this.resources[a]&&(d.info("stopResource: stopping resource "+
a+" with state: "+this.resources[a].state),(!this.resources[a].state||1>this.resources[a].state)&&d.warn("stopping resource with state smaller than 1: "+a),radio("stopHttpInit"+a).broadcast(),this.resources[a].state=4,this.controller.stopResource(a),this._unqueueResource(a))},readBlobData:function(a,b){this.resources[a]=Object.create(null);this.resources[a].state=0;this.resources[a].origin=!0;this.resources[a].hashAlg=new d.core.util.MD5.ArrayBuffer;this.resources[a].blockHashes=[];this.resources[a].chunkRead=
0;this.resources[a].mod=2;this.resources[a].url=a;d.core.data.BlockCache.add(a,new d.core.dataStructures.BlockMap(b.size,a,this.resources[a].md5,this.resources[a].sha1));var c=this,g=d.core.data.BlockCache.get(a);d.config.USE_FS&&g.fs?radio("filesystemInitiated"+a).subscribe([function(){1==g.fs&&d.config.PREALLOCATE_FILE?g.allocateFileSizeSync(function(g){g?c.readBlobInSlices(a,b):radio("removeResource").broadcast(a,d.Request.FILE_SIZE_ERR,"Not enough disk space for file")}):c.readBlobInSlices(a,
b)},this]):this.readBlobInSlices(a,b);radio("transferLoadedEvent").subscribe([function(b){b.url!==a||this.resources[a].uploaded||setTimeout(function(){this.resources[a].uploaded=!0;var b=this.createAndUploadFileInfo(a);radio("transferLoadedEvent"+a).broadcast(b)}.bind(this),0)},c])},getLoadedStats:function(a,b){var c=d.core.stats.StatsCollector.getStats(a),g=Object.create(null);g.loadedHTTP=c.totalHttpDownloaded;g.loadedP2P=c.totalP2PDownloaded;g.loadedFS=c.totalFSLoaded;b(g)},getUploadedStats:function(a,
b){var c=d.core.stats.StatsCollector.getStats(a),g=Object.create(null);g.uploaded=c.totalP2PUploaded;b(g)},getCompatibilityStatus:function(a){var b=this.apiValidator.getStatus(),c=this.apiValidator.getBrowser();a(b,c)},_initiateHttpResource:function(a){if(d.info("initializing http resource: "+a),this.resources[a].hash&&this.resources[a].length)a=new d.core.protocol.FileInfo(this.resources[a].hash,this.resources[a].length,this.resources[a].hash,null,d.config.BLOCK_SIZE,a),this.joinSwarm(a.swarmId),
this.handleFileInfo(a);else{var b=function(a){this.joinSwarm(a.swarmId);this.handleFileInfo(a)}.bind(this);d.client.getHttpMeta(a,this.resources,b)}},createAndUploadFileInfo:function(a){var c=this.resources[a].hashAlg.end();b.addMapping(a,c);this.resources[a].hash=c;this.changeResourceId(a,this.resources[a].hash);c=d.core.data.BlockCache.get(a);a=new d.core.protocol.Share(this.resources[a].hash,c.fileSize,this.resources[a].hash,this.resources[a].blockHashes,d.config.BLOCK_SIZE);return this.wsConnectionImpl.sendMessage(a),
a},readBlobInSlices:function(a,b){if(!d.core.data.BlockCache.get(a).fs&&b.size>d.config.ALLOWED_FILE_SIZE)return void radio("removeResource").broadcast(a,d.Request.FILE_SIZE_ERR,"file size too big");var c=this;d.core.util.fileHandler.readFileInSlices(a,b,d.config.BLOCK_SIZE,function(a,b,e){a&&b&&e?(d.log("adding chunks"),c.addChunks(a,b,e)):(!a||b||e)&&d.error("handle error")})},addChunks:function(a,b,c){d.log("slice");this.resources[a].hashAlg.append(b);for(var g=d.core.data.BlockCache.get(a),h=
Math.ceil(b.byteLength/d.config.CHUNK_SIZE),k=0;h>k;k++){var l=k*d.config.CHUNK_SIZE,l=new Uint8Array(b.slice(l,Math.min(l+d.config.CHUNK_SIZE,b.byteLength))),l=g.setChunk(this.resources[a].chunkRead,l),p=g.ingestBlock(l);p&&(this.resources[a].blockHashes[l]=p);radio("chunkAddedToBlockMap").broadcast();this.resources[a].chunkRead++}this.resources[a].chunkRead==this.numOfChunksInFile&&(this.hasEntireFile=!0);g.fs?d.core.data.FSio.notifyFinishWrite(c):c()},cron:function(a){a.sendReportPeriodically();
a.calculateStats();radio("cron").broadcast();for(var b in d.core.data.BlockCache._blockMaps)a.resources[b]&&2!==a.resources[b].mod&&d.core.data.BlockCache.get(b)&&!d.core.data.BlockCache.get(b).isFull()&&(0===d.core.stats.StatsCollector.statsCalculators[b].Avg_Recv_HTTP?a.resources[b].httpIdle++:a.resources[b].httpIdle=0,a.resources[b].httpIdle>=d.config.HTTP_IDLE_RESET_DURATION/d.config.MONITOR_INTERVAL&&(a.controller.stopHttp(d.core.data.BlockCache.get(b).getMetadata().url),a.resources[b].httpIdle=
0),a.controller.downloadPeriodicTest(d.core.data.BlockCache.get(b).getMetadata().url))},calculateStats:function(){var a=Date.now();a-this.lastStatCalcTime<d.config.STAT_CALC_INTERVAL||(this.lastStatCalcTime=a,d.core.stats.StatsCollector.calcAvg())},sendReport:function(){d.core.stats.ReportBuilder.processQueue()},sendReportPeriodically:function(){var a=Date.now();a-this.lastReportTime<d.config.REPORT_INTERVAL||(this.lastReportTime=a,this.sendReport())},getConnectionStats:function(){return this.controller.getConnectionStats().p2p},
handleFileInfo:function(a){var c=a.swarmId,f=a.url;b.addMapping(f,c);d.info("Handling file Info:: url="+f+" swarmId="+c);var g=new d.core.dataStructures.BlockMap(a.size,c,this.resources[f].md5,this.resources[f].sha1);d.core.data.BlockCache.add(c,g);g.addMetadata(a);this.changeResourceId(f,c);this.resources[c].state=1;radio("fileInfoProcessed").broadcast(a);g.fs||radio("resourceInit").broadcast(a)},updateFileInfo:function(a){var b=this;this.changeResourceId(a.url,a.swarmId,function(c){c?(b.resources[a.swarmId].state=
1,d.core.data.BlockCache.get(a.swarmId).addMetadata(a),radio("resourceInit").broadcast(a)):d.warn("couldn't change resource Id")});radio("fileInfoProcessed").broadcast(a)},joinSwarm:function(a){var b=this.controller.getNumberOfConnectedPeers();b<d.config.MAX_CONNECTIONS&&this.wsConnectionImpl.sendMessage(new d.core.protocol.Join(a,b<d.config.MAX_CONNECTIONS))},leechSwarm:function(a){this.wsConnectionImpl.sendMessage(new d.core.protocol.Leech(a))},_removeResourceBeforeInit:function(a){this.resources[a].state=
4;this.resources[a]&&this.resources[a].swarmId&&this.resources[this.resources[a].swarmId]&&delete this.resources[this.resources[a].swarmId];this.resources[a]&&delete this.resources[a];radio("stopHttpInit"+a).broadcast();this._unqueueResource(a)},_unqueueResource:function(a){if(this.queuedResource[a]){d.info("unqueuing a resource: "+a);var b=this.queuedResource[a].args;delete this.queuedResource[a];this.addResource.apply(this,b)}},registerEvents:function(){radio("pauseResource").subscribe([function(a,
b,c){this.stopResource(a);radio("resumeResource").subscribe([function(b){b===a&&(b=null,this.resources[a].md5?b={md5:this.resources[a].md5}:this.resources[a].sha1&&(b={sha1:this.resources[a].sha1}),this.addResource(a,this.resources[a].mod,b))},this])},this]);radio("stopResource").subscribe([function(a,b,c){var d=this.resources[a]?this.resources[a].mod:null;radio("requestError"+a).broadcast(b,c);radio("resourceLoadEnd").broadcast(a,d);this.stopResource(a)},this]);radio("removeResource").subscribe([function(a,
b,c){d.warn("removing resource "+a);d.warn(b+": "+c);this.resources[a]?(radio("requestError"+a).broadcast(b,c),1>this.resources[a].state?this._removeResourceBeforeInit(a):this.removeResource(a)):d.warn("Tried removing resource: "+a+" but it was already removed")},this]);radio("resourceInit").subscribe([function(a){this.resources[a.swarmId].state=2;var b=d.core.data.BlockCache.get(a.swarmId);if(!b.fs&&a.size>d.config.ALLOWED_FILE_SIZE)return void radio("removeResource").broadcast(a.url,d.Request.FILE_SIZE_ERR,
"file size too big");this.controller.init(a,!0,this.resources[a.swarmId].mod);!0===b.fs&&d.config.PREALLOCATE_FILE&&b.allocateFileSize(function(a){a||d.warn("Couldn't allocate space for file")});radio("resourceReady"+a.url).broadcast(a)},this]);radio("fileInfoProcessed").subscribe([function(a){radio("fileInfoProcessed"+a.url).broadcast(a)},this]);radio("chunkReceivedEvent").subscribe([function(a){radio("chunkReceivedEvent"+a.url).broadcast(a)},this]);radio("chunkSentEvent").subscribe([function(a,
b){radio("chunkSentEvent"+this.resources[a].url).broadcast(a,b)},this]);radio("blockReceivedEvent").subscribe([function(a,b){radio("blockReceivedEvent"+this.resources[a].url).broadcast(b)},this]);radio("HTTPHeadersReceived").subscribe([function(a,b,c){radio("HTTPHeadersReceived"+a).broadcast(b,c)},this]);radio("needByteRangeEvent").subscribe([function(a,b,c,g,h){if(!this.resources[a].preventDownload){var k=d.core.data.BlockCache.get(a);b=b?k.getBlockIndex(b):null;c=c?k.getBlockIndex(c):null;h&&d.warn("We don't support in pausing and resuming");
this.controller.download(a,b,c,g)}},this]);radio("receivedFileInfo").subscribe([function(a){this.resources[a.swarmId]?this.resources[a.swarmId]&&0===this.resources[a.swarmId].state&&(a.url=this.resources[a.swarmId].url,this.resources[a.swarmId].origin?this.updateFileInfo(a):this.handleFileInfo(a)):d.warn("received fileInfo for a non existing swarm")},this]);radio("browserUnsupported").subscribe([function(a,b,c){d.warn("Unsupported browser for peer5");radio("browserUnsupported").unsubscribe(arguments.callee);
this.validated=!1},this]);radio("swarmError").subscribe([function(a){var b;switch(a.error){case d.core.protocol.SWARM_NOT_FOUND:if(!this.resources[a.swarmId])return void d.warn("swarm not found for an unexisting resource");if(1==this.resources[a.swarmId].mod||3==this.resources[a.swarmId].mod||void 0!==this.resources[a.swarmId].hashUrl)return;if(2==this.resources[a.swarmId].mod){b=d.Request.SWARMID_NOT_FOUND_ERR;break}case d.core.protocol.SWARM_ONLY_CHROME:b=d.Request.CHROME_ONLY_SWARM_ERR;break;case d.core.protocol.SWARM_ONLY_FIREFOX:b=
d.Request.FIREFOX_ONLY_SWARM_ERR;break;case d.core.protocol.SWARM_NOT_COMPAT:b=d.Request.BROWSER_SWARM_COMPAT_ERR}d.error("swarmError: "+a.error);radio("stopResource").broadcast(a.swarmId,b)},this]);radio("transferLoadedEvent").subscribe([function(a){if(a&&a.swarmId&&this.resources[a.swarmId]){this.resources[a.swarmId].state=4;var b=this.resources[a.swarmId].url,c=this.resources[a.swarmId].mod;radio("transferLoadedEvent"+b).broadcast(a);radio("resourceLoadEnd").broadcast(b,c)}},this]);radio("beforeUnload").subscribe([function(){this.sendReport()},
this])},changeResourceId:function(a,b,c){this.resources[a]&&(this.resources[b]=this.resources[a],this.resources[b].resourceId=b);!d.core.data.BlockCache.get(a)||d.core.data.BlockCache.get(b)&&a!==b?!d.core.data.BlockCache.get(a)&&d.core.data.BlockCache.get(b)&&d.core.data.BlockCache.alias(a,b):d.core.data.BlockCache.alias(b,a);c&&d.core.data.BlockCache.get(b).resourceId!==b&&d.core.data.BlockCache.get(a).changeResourceId(b,c)}});c.clientInstance=new d.client.DownloadUploadManager})(d);(function(){d.overrideXHR=
function(){if(window.XMLHttpRequest)window._XMLHttpRequest=window.XMLHttpRequest,window.XMLHttpRequest=d.Request;else{if(!window._XMLHttpRequest)throw"Cannot find XMLHTTPRequest";d.warn("XMLHTTPRequest is already peer5.Request")}};d.revertXHR=function(){window._XMLHttpRequest?(window.XMLHttpRequest=window._XMLHttpRequest,window._XMLHttpRequest=null):d.warn("_XMLHTTPRequest not found")};var c=Object.subClass({ctor:function(b){this.readyState=0;this.response;this.responseText=null;this._responseHeaders;
this.responseType="";this.timeout="unimplemented";this.status;this._range;this._post=this._get=!1;this._url;this._swarmState={uploaded:0};this.fileInfo;b=this.sanitizeCtorArgs(b);this.downloadMode=b.downloadMode;this.md5=b.md5;this.sha1=b.sha1;this._responseHeadersMap=Object.create(null);this._startLoaded;this._startTime;this._speed;this.onloadstart;this.onprogress;this.onabort;this.onerror;this.onload;this.ontimeout="unimplemented";this.onloadend;this.onreadystatechange;this.onswarmstatechange;this.eventListeners=
Object.create(null);this.eventListeners.loadstart=[];this.eventListeners.progress=[];this.eventListeners.abort=[];this.eventListeners.error=[];this.eventListeners.load=[];this.eventListeners.timeout=[];this.eventListeners.loadend=[];this.eventListeners.readystatechange=[];this.eventListeners.swarmstatechange=[]},open:function(b,a){if(!b)return!1;if("GET"==b.toUpperCase()&&a){var c;c=a;c=d.config.ZIXI_DIGEST?d.core.util.urlDigest.zixi(c):d.core.util.urlDigest.cleanQueryStringFromKeys(c,["_","time"]);
this._get=!0;this._url=c}else{if("POST"!=b.toUpperCase())return!1;this._post=!0;this._url="peer5://"+d.core.util.generate_uuid()}this.changeReadyState(1);this.registerEvents()},setResponseHeaders:function(b){b=b.split("\n");for(var a=0;a<b.length;a++){var c=b[a].split(":"),d=c.shift().trim(),c=c.join(":").trim();this._responseHeadersMap[d]=c}},forceImmediateLoad:function(b){d.client.bypassServer(this,b)},setRequestHeader:function(b,a){},send:function(b){radio("requestSent").broadcast(this);var a=
this;d.clientInstance.isValidated(function(c){if(!c)return void d.getCompatibilityStatus(function(b){a.handleRequestError(b[0])});!b&&a._get&&1==a.readyState&&(c=Object.create(null),a.sha1?c.sha1=a.sha1:a.md5&&(c.md5=a.md5),a._startLoaded=d.core.stats.StatsCollector.getStats(a._url).totalVerifiedBytes||0,a._startTime=Date.now(),d.clientInstance.addResource(a._url,a.downloadMode,c));b&&a._post&&1==a.readyState&&b instanceof Blob&&a.changeReadyState(2)&&d.clientInstance.readBlobData(a._url,b)})},getResponseHeader:function(b){if(2>
this.readyState)throw"Response headers are available only when readystate >=2";var a=this._responseHeadersMap[b];return a?a:(console.error('Refused to get unsafe header "'+b+'"'),null)},getAllResponseHeaders:function(){return this._responseHeaders},getFileInfo:function(){return 2<=this.readyState?this.fileInfo:void 0},abort:function(b){if(1<=this.readyState&&3>this.readyState)return d.info("peer5.Request::abort: Queuing the abort command"),void(this.queuedCommand=["abort",b]);var a=this;this.createProgressEvent(function(c){b&&
b.leaveSwarm?d.clientInstance.removeResource(a._url):d.clientInstance.stopResource(a._url);a.unregisterEvents();a.changeReadyState(4)&&(a._speed=a._getDownloadSpeed(a._url),a._triggerEvent("progress",c),a._triggerEvent("abort",c),a._triggerEvent("loadend",c))})},addEventListener:function(b,a){this.eventListeners[b]&&this.eventListeners[b].push(a)},registerEvents:function(){radio("requestError"+this._url).subscribe([this.requestErrorEvent,this]);radio("HTTPHeadersReceived"+this._url).subscribe([this.HTTPHeadersReceivedEvent,
this]);radio("fileInfoProcessed"+this._url).subscribe([this.fileInfoReceivedEvent,this]);radio("resourceReady"+this._url).subscribe([this.resourceReadyEvent,this]);radio("blockReceivedEvent"+this._url).subscribe([this.blockReceivedEvent,this]);radio("chunkReceivedEvent"+this._url).subscribe([this.chunkReceivedEvent,this]);radio("transferLoadedEvent"+this._url).subscribe([this.transferLoadedEvent,this]);radio("httpProgressEvent"+this._url).subscribe([this.handleHttpProgressEvent,this]);radio("chunkSentEvent"+
this._url).subscribe([this.chunkSentEvent,this]);radio("activePeerConnectionsNumberChanged").subscribe([this.activePeerConnectionsNumberChangedEvent,this])},unregisterEvents:function(){radio("requestError"+this._url).unsubscribe([this.requestErrorEvent,this]);radio("HTTPHeadersReceived"+this._url).unsubscribe([this.HTTPHeadersReceivedEvent,this]);radio("fileInfoProcessed"+this._url).unsubscribe([this.fileInfoReceivedEvent,this]);radio("resourceReady"+this._url).unsubscribe([this.resourceReadyEvent,
this]);radio("blockReceivedEvent"+this._url).unsubscribe([this.blockReceivedEvent,this]);radio("chunkReceivedEvent"+this._url).unsubscribe([this.chunkReceivedEvent,this]);radio("transferLoadedEvent"+this._url).unsubscribe([this.transferLoadedEvent,this]);radio("chunkSentEvent"+this._url).unsubscribe(this.chunkSentEvent);radio("activePeerConnectionsNumberChanged").unsubscribe(this.activePeerConnectionsNumberChangedEvent)},HTTPHeadersReceivedEvent:function(b,a,c){this._responseHeaders=a;this._responseHeadersMap=
c},fileInfoReceivedEvent:function(b){this._get&&(this.fileInfo=b,this.changeReadyState(2))},resourceReadyEvent:function(b){var a=this,c=b.swarmId;if(this._get){if(this.changeReadyState(3)&&3==this.readyState){if(this.range)var f=range[0],g=range[1];this.createProgressEvent(function(b){a._triggerEvent("loadstart",b)});d.clientInstance.isFull(c,function(h){d.info("Resource "+c+" is ready and full="+h);h?a.handleTransferLoaded(b):(urgent=null,stop_prev=null,radio("needByteRangeEvent").broadcast(a._url,
f,g,urgent,stop_prev))})}}else this._post&&(this.fileInfo=b,b.url="peer5://"+b.swarmId,3===this.readyState)&&this._getUrlAndTriggerOnLoad(b)},chunkReceivedEvent:function(b){var a=this;this.createProgressEvent(function(b){a._triggerEvent("loadstart",b)})},blockReceivedEvent:function(b){var a=this;this.createProgressEvent(function(b){a._triggerEvent("progress",b)})},handleHttpProgressEvent:function(){var b=this;this.createProgressEvent(function(a){b._triggerEvent("progress",a)})},transferLoadedEvent:function(b){this.handleTransferLoaded(b)},
requestErrorEvent:function(b,a){this.handleRequestError(b,a)},activePeerConnectionsNumberChangedEvent:function(b){this._swarmState.numOfPeers=b;b=this.createSwarmStateEvent();this._triggerEvent("swarmstatechange",b)},chunkSentEvent:function(b,a){var c=this;d.clientInstance.getUploadedStats(b,function(b){for(stat in b)"numOfPeers"===stat&&0===b[stat]&&d.error("chunkSentEvent: sent p2p while connected to 0 peers"),c._swarmState[stat]=b[stat];b=c.createSwarmStateEvent();b.sent=a;c._triggerEvent("swarmstatechange",
b)})},sanitizeCtorArgs:function(b){switch(b||(b=Object.create(null)),b.downloadMode){case "p2p":b.downloadMode=2;break;case "http":b.downloadMode=3;break;default:b.downloadMode=1}if(b.md5){if("[object String]"!=Object.prototype.toString.call(b.md5))return d.error("options.sha1 contains invalid characters"),!1}else b.md5=null;if(b.sha1){if("[object String]"!=Object.prototype.toString.call(b.sha1))return d.error("options.sha1 contains invalid characters"),!1}else b.sha1=null;return b},createProgressEvent:function(b){var a=
this.createEvent(),c=this;d.clientInstance.getNumOfVerifiedBytes(this._url,function(f){f||0==f?(a.verified=f,a.loaded=0,a.lengthComputable=!0,d.clientInstance.getLoadedStats(c._url,function(d){for(stat in d)a[stat]=d[stat],a.loaded+=a[stat];c.fileInfo&&(a.total=c.fileInfo.size);b(a)}),d.debug("API::onprogress","loaded:",a.loaded,"new loaded:",a.loadedHTTP+a.loadedP2P+a.loadedFS,"http:",a.loadedHTTP,"p2p:",a.loadedP2P)):(a.loaded=0,a.loadedHTTP=0,a.loadedP2P=0,a.loadedFS=0,a.lengthComputable=!1,b(a))})},
createSwarmStateEvent:function(b){b=this.createEvent();for(var a in this._swarmState)b[a]=this._swarmState[a];return b},createEvent:function(){var b={};return b.currentTarget=this,b},changeReadyState:function(b,a){if(a||this.readyState==b-1){if(4===b&&4===this.readyState)return d.info("request has already finished (readystate=4)"),!1;this.readyState=b;3==this.readyState&&(this.queuedCommand&&d.core.util.executeFunctionByName(this.queuedCommand[0],this,[this.queuedCommand[1]]),this._get);var c=this;
if(this.fileInfo)this.createProgressEvent(function(a){c._triggerEvent("readystatechange",a)});else{var f=this.createEvent();this._triggerEvent("readystatechange",f)}return!0}return d.info("ready state has jumped a stage"),!1},handleTransferLoaded:function(b){this._get?3===this.readyState&&this._getUrlAndTriggerOnLoad(b):this._post&&(this.changeReadyState(3),this.fileInfo=b)},handleRequestError:function(b,a){this.status=b;this.description=a;this.unregisterEvents();var c=this;this.changeReadyState(4,
!0)&&this.createProgressEvent(function(a){c._triggerEvent("progress",a);c._triggerEvent("error",a);c._triggerEvent("loadend",a)})},_getDownloadSpeed:function(){return d.core.stats.StatsCollector.getLastHttpSpeed()},_getUrlAndTriggerOnLoad:function(b){var a=this;this.status=200;d.info("TriggeringOnLoad:: "+b.swarmId+" responseType="+this.responseType);d.core.util.asyncDefer(function(){switch(a._speed=a._getDownloadSpeed(a._url),this.responseType){case "arraybuffer":d.clientInstance.getUint8Array(b.swarmId,
function(b,c){b?(a.response=c.buffer,a.changeReadyState(4))&&a.createProgressEvent(function(b){a._triggerEvent("progress",b);a._triggerEvent("load",b);a._triggerEvent("loadend",b)}):d.error("couldn't receive arraybuffer")});break;case "blob":d.clientInstance.getBlob(b.swarmId,function(b,c){b?(a.response=c,a.changeReadyState(4))&&a.createProgressEvent(function(b){a._triggerEvent("progress",b);a._triggerEvent("load",b);a._triggerEvent("loadend",b)}):d.error("couldn't receive blob")});break;case "document":d.error("document responseType isn't supported");
a.handleRequestError(this.INVALID_RESPONSETYPE,"document is not implemented");break;case "json":d.error("json responseType isn't supported");a.handleRequestError(this.INVALID_RESPONSETYPE,"json is not implemented");break;case "text":d.clientInstance.getText(b.swarmId,function(b,c){b?(c=c.replace("\u00ef\u00bb\u00bf",""),a.response=c,a.responseText=c,a.changeReadyState(4))&&a.createProgressEvent(function(b){a._triggerEvent("progress",b);a._triggerEvent("load",b);a._triggerEvent("loadend",b)}):d.error("couldn't receive text")});
break;case "blobUrl":d.clientInstance.getBlobUrl(b.swarmId,function(b,c){b?(a.response=c,a.changeReadyState(4))&&a.createProgressEvent(function(b){a._triggerEvent("progress",b);a._triggerEvent("load",b);a._triggerEvent("loadend",b)}):d.error("couldn't receive blobUrl")});break;default:d.clientInstance.getText(b.swarmId,function(b,c){b?(a.response=c,a.changeReadyState(4))&&a.createProgressEvent(function(b){a._triggerEvent("progress",b);a._triggerEvent("load",b);a._triggerEvent("loadend",b)}):d.error("couldn't receive text")})}},
this)},_triggerEvent:function(b,a){for(var c=0;c<this.eventListeners[b].length;c++)d.core.util.envokeCallback(this.eventListeners[b][c],[a],this);d.core.util.envokeCallback(this["on"+b],[a],this)}});d.config.EXTERNAL_XHR_FALLBACK?d.Request=XMLHttpRequest:d.clientInstance.isValidated(function(b){d.Request=b?c:XMLHttpRequest});d.Request.INVALID_RESPONSETYPE=669;d.Request.INVALID_RESPONSELENGTH=668;d.Request.SWARMID_NOT_FOUND_ERR=650;d.Request.FILE_SIZE_ERR=640;d.Request.FIREFOX_ONLY_SWARM_ERR=641;d.Request.CHROME_ONLY_SWARM_ERR=
642;d.Request.BROWSER_SWARM_COMPAT_ERR=643;d.Request.OUT_OF_SPACE_ERR=644;d.Request.WRITE_ERR=645;d.Request.VERIFICATION_ERR=646;d.DATACHANNELS_ERROR=700;d.WEBSOCKETS_ERROR=701;d.FILESYSTEM_ERROR=702;d.getCompatibilityStatus=function(b){d.clientInstance.getCompatibilityStatus(function(a,c){var f=[];for(type in a)if(!a[type])switch(type){case "dataChannels":f.push(d.DATACHANNELS_ERROR);break;case "Websockets":f.push(d.WEBSOCKETS_ERROR);break;case "fileSystem":f.push(d.FILESYSTEM_ERROR)}b(f,c.name,
c.version)})};d.isEnabled=function(){return d.feature.isEnabledAndInitialized(d.config.FEATURE_PEER5_KEY)}})();(function(c){radio("requestSent").subscribe(function(b){d.config.FEATURE_DOWNLOAD_SPEED_ESTIMATION&&(b._p2pBps=d.core.util.DownloadSpeedEstimator.p2pDownloadBPS(),b._httpBps=d.core.util.DownloadSpeedEstimator.httpDownloadBPS());["load","abort"].forEach(function(a){b.addEventListener(a,function(b){b._event=a;radio("downloadEnd").broadcast(b)})})});c.DownloadSpeedEstimator=function(){function b(a,
b,k){b={bytes:b,speed:k};"p2p"===a?(c.unshift(b),a=c):(f.unshift(b),a=f);for(;a.length>d.config.RELEVANT_LAST_ENTRIES;)a.pop()}function a(a){var b=0,c=Math.min(d.config.RELEVANT_LAST_ENTRIES,a.length);if(0>=c)return 0;var e;for(e=0;c>e;e++)b+=a[e].speed;return b/e}var c=[],f=[];radio("downloadEnd").subscribe(function(a){if(a.total&&!(a.loadedP2P&&a.loadedHTTP||0>=a.currentTarget._speed)){if(a.loadedP2P)b("p2p",a.loadedP2P,a.currentTarget._speed);else{if(!a.loadedHTTP)return;b("http",a.loadedHTTP,
a.currentTarget._speed)}if(d.config.FEATURE_DOWNLOAD_SPEED_ESTIMATION){var c,e,f;a.loadedP2P?(e=a.currentTarget._p2pBps,c="p2p",f=a.loadedP2P):a.loadedHTTP&&(e=a.currentTarget._httpBps,c="http",f=a.loadedHTTP);a={url:a.currentTarget._url,mode:c,predictedSpeed:Math.round(e),actualSpeed:Math.round(a.currentTarget._speed),bytesDownloaded:f};radio("speedEstimationCalculated").broadcast(a)}}});return{p2pDownloadBPS:function(){return a(c)},httpDownloadBPS:function(){return a(f)}}}()})(d.core.util);d.goog=
d.goog||{};d.goog.uri=d.goog.uri||{};d.goog.uri.utils=d.goog.uri.utils||{};d.shaka=d.shaka||{};d.shaka.media=d.shaka.media||{};d.shaka.player=d.shaka.player||{};d.shaka.util=d.shaka.util||{};d.shaka.dash=d.shaka.dash||{};d.shaka.util.Clock=d.shaka.util.Clock||{};d.shaka.util.LanguageUtils=d.shaka.util.LanguageUtils||{};d.shaka.dash.mpd=d.shaka.dash.mpd||{};d.shaka.dash.MpdUtils=d.shaka.dash.MpdUtils||{};d.shaka.util.LanguageUtils.match=function(c,b,a){d.shaka.util.LanguageUtils;return a==b?!0:c>=
d.shaka.util.LanguageUtils.MatchType.BASE_LANGUAGE_OKAY&&a==b.split("-")[0]?!0:c>=d.shaka.util.LanguageUtils.MatchType.OTHER_SUB_LANGUAGE_OKAY&&a.split("-")[0]==b.split("-")[0]?!0:!1};d.shaka.util.LanguageUtils.MatchType={EXACT:0,BASE_LANGUAGE_OKAY:1,OTHER_SUB_LANGUAGE_OKAY:2,MIN:0,MAX:2};d.shaka.util.LanguageUtils.normalize=function(c){c=c.toLowerCase().split("-");var b=d.shaka.util.LanguageUtils.isoMap_[c[0]];return b&&(c[0]=b),c.join("-")};d.shaka.util.LanguageUtils.isoMap_={aar:"aa",abk:"ab",
afr:"af",aka:"ak",alb:"sq",amh:"am",ara:"ar",arg:"an",arm:"hy",asm:"as",ava:"av",ave:"ae",aym:"ay",aze:"az",bak:"ba",bam:"bm",baq:"eu",bel:"be",ben:"bn",bih:"bh",bis:"bi",bod:"bo",bos:"bs",bre:"br",bul:"bg",bur:"my",cat:"ca",ces:"cs",cha:"ch",che:"ce",chi:"zh",chu:"cu",chv:"cv",cor:"kw",cos:"co",cre:"cr",cym:"cy",cze:"cs",dan:"da",deu:"de",div:"dv",dut:"nl",dzo:"dz",ell:"el",eng:"en",epo:"eo",est:"et",eus:"eu",ewe:"ee",fao:"fo",fas:"fa",fij:"fj",fin:"fi",fra:"fr",fre:"fr",fry:"fy",ful:"ff",geo:"ka",
ger:"de",gla:"gd",gle:"ga",glg:"gl",glv:"gv",gre:"el",grn:"gn",guj:"gu",hat:"ht",hau:"ha",heb:"he",her:"hz",hin:"hi",hmo:"ho",hrv:"hr",hun:"hu",hye:"hy",ibo:"ig",ice:"is",ido:"io",iii:"ii",iku:"iu",ile:"ie",ina:"ia",ind:"id",ipk:"ik",isl:"is",ita:"it",jav:"jv",jpn:"ja",kal:"kl",kan:"kn",kas:"ks",kat:"ka",kau:"kr",kaz:"kk",khm:"km",kik:"ki",kin:"rw",kir:"ky",kom:"kv",kon:"kg",kor:"ko",kua:"kj",kur:"ku",lao:"lo",lat:"la",lav:"lv",lim:"li",lin:"ln",lit:"lt",ltz:"lb",lub:"lu",lug:"lg",mac:"mk",mah:"mh",
mal:"ml",mao:"mi",mar:"mr",may:"ms",mkd:"mk",mlg:"mg",mlt:"mt",mon:"mn",mri:"mi",msa:"ms",mya:"my",nau:"na",nav:"nv",nbl:"nr",nde:"nd",ndo:"ng",nep:"ne",nld:"nl",nno:"nn",nob:"nb",nor:"no",nya:"ny",oci:"oc",oji:"oj",ori:"or",orm:"om",oss:"os",pan:"pa",per:"fa",pli:"pi",pol:"pl",por:"pt",pus:"ps",que:"qu",roh:"rm",ron:"ro",rum:"ro",run:"rn",rus:"ru",sag:"sg",san:"sa",sin:"si",slk:"sk",slo:"sk",slv:"sl",sme:"se",smo:"sm",sna:"sn",snd:"sd",som:"so",sot:"st",spa:"es",sqi:"sq",srd:"sc",srp:"sr",ssw:"ss",
sun:"su",swa:"sw",swe:"sv",tah:"ty",tam:"ta",tat:"tt",tel:"te",tgk:"tg",tgl:"tl",tha:"th",tib:"bo",tir:"ti",ton:"to",tsn:"tn",tso:"ts",tuk:"tk",tur:"tr",twi:"tw",uig:"ug",ukr:"uk",urd:"ur",uzb:"uz",ven:"ve",vie:"vi",vol:"vo",wel:"cy",wln:"wa",wol:"wo",xho:"xh",yid:"yi",yor:"yo",zha:"za",zho:"zh",zul:"zu"};d.goog.uri.utils.splitRe_=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#(.*))?$/;d.goog.uri.utils.ComponentIndex={SCHEME:1,USER_INFO:2,
DOMAIN:3,PORT:4,PATH:5,QUERY_DATA:6,FRAGMENT:7};d.goog.uri.utils.split=function(c){return c.match(d.goog.uri.utils.splitRe_)};d.goog.Uri=function(c){var b;c instanceof d.goog.Uri?(this.setScheme(c.getScheme()),this.setUserInfo(c.getUserInfo()),this.setDomain(c.getDomain()),this.setPort(c.getPort()),this.setPath(c.getPath()),this.setQueryData(c.getQueryData().clone()),this.setFragment(c.getFragment())):c&&(b=d.goog.uri.utils.split(String(c)))?(this.setScheme(b[d.goog.uri.utils.ComponentIndex.SCHEME]||
"",!0),this.setUserInfo(b[d.goog.uri.utils.ComponentIndex.USER_INFO]||"",!0),this.setDomain(b[d.goog.uri.utils.ComponentIndex.DOMAIN]||"",!0),this.setPort(b[d.goog.uri.utils.ComponentIndex.PORT]),this.setPath(b[d.goog.uri.utils.ComponentIndex.PATH]||"",!0),this.setQueryData(b[d.goog.uri.utils.ComponentIndex.QUERY_DATA]||"",!0),this.setFragment(b[d.goog.uri.utils.ComponentIndex.FRAGMENT]||"",!0)):this.queryData_=new d.goog.Uri.QueryData(null,null)};d.goog.Uri.prototype.scheme_="";d.goog.Uri.prototype.userInfo_=
"";d.goog.Uri.prototype.domain_="";d.goog.Uri.prototype.port_=null;d.goog.Uri.prototype.path_="";d.goog.Uri.prototype.queryData_;d.goog.Uri.prototype.fragment_="";d.goog.Uri.prototype.toString=function(){var c=[],b=this.getScheme();b&&c.push(d.goog.Uri.encodeSpecialChars_(b,d.goog.Uri.reDisallowedInSchemeOrUserInfo_,!0),":");if(b=this.getDomain()){c.push("//");var a=this.getUserInfo();a&&c.push(d.goog.Uri.encodeSpecialChars_(a,d.goog.Uri.reDisallowedInSchemeOrUserInfo_,!0),"@");c.push(d.goog.Uri.removeDoubleEncoding_(encodeURIComponent(b)));
b=this.getPort();null!=b&&c.push(":",String(b))}(b=this.getPath())&&(this.hasDomain()&&"/"!=b.charAt(0)&&c.push("/"),c.push(d.goog.Uri.encodeSpecialChars_(b,"/"==b.charAt(0)?d.goog.Uri.reDisallowedInAbsolutePath_:d.goog.Uri.reDisallowedInRelativePath_,!0)));(b=this.getEncodedQuery())&&c.push("?",b);b=this.getFragment();return b&&c.push("#",d.goog.Uri.encodeSpecialChars_(b,d.goog.Uri.reDisallowedInFragment_)),c.join("")};d.goog.Uri.prototype.resolve=function(c){var b=this.clone(),a=c.hasScheme();a?
b.setScheme(c.getScheme()):a=c.hasUserInfo();a?b.setUserInfo(c.getUserInfo()):a=c.hasDomain();a?b.setDomain(c.getDomain()):a=c.hasPort();var e=c.getPath();if(a)b.setPort(c.getPort());else if(a=c.hasPath()){if("/"!=e.charAt(0))if(this.hasDomain()&&!this.hasPath())e="/"+e;else{var f=b.getPath().lastIndexOf("/");-1!=f&&(e=b.getPath().substr(0,f+1)+e)}e=d.goog.Uri.removeDotSegments(e)}return a?b.setPath(e):a=c.hasQuery(),a?b.setQueryData(c.getQueryData().clone()):a=c.hasFragment(),a&&b.setFragment(c.getFragment()),
b};d.goog.Uri.prototype.clone=function(){return new d.goog.Uri(this)};d.goog.Uri.prototype.getScheme=function(){return this.scheme_};d.goog.Uri.prototype.setScheme=function(c,b){return this.scheme_=b?d.goog.Uri.decodeOrEmpty_(c,!0):c,this.scheme_&&(this.scheme_=this.scheme_.replace(/:$/,"")),this};d.goog.Uri.prototype.hasScheme=function(){return!!this.scheme_};d.goog.Uri.prototype.getUserInfo=function(){return this.userInfo_};d.goog.Uri.prototype.setUserInfo=function(c,b){return this.userInfo_=b?
d.goog.Uri.decodeOrEmpty_(c):c,this};d.goog.Uri.prototype.hasUserInfo=function(){return!!this.userInfo_};d.goog.Uri.prototype.getDomain=function(){return this.domain_};d.goog.Uri.prototype.setDomain=function(c,b){return this.domain_=b?d.goog.Uri.decodeOrEmpty_(c,!0):c,this};d.goog.Uri.prototype.hasDomain=function(){return!!this.domain_};d.goog.Uri.prototype.getPort=function(){return this.port_};d.goog.Uri.prototype.setPort=function(c){if(c){if(c=Number(c),isNaN(c)||0>c)throw Error("Bad port number "+
c);this.port_=c}else this.port_=null;return this};d.goog.Uri.prototype.hasPort=function(){return null!=this.port_};d.goog.Uri.prototype.getPath=function(){return this.path_};d.goog.Uri.prototype.setPath=function(c,b){return this.path_=b?d.goog.Uri.decodeOrEmpty_(c,!0):c,this};d.goog.Uri.prototype.hasPath=function(){return!!this.path_};d.goog.Uri.prototype.hasQuery=function(){return""!==this.queryData_.toString()};d.goog.Uri.prototype.setQueryData=function(c,b){return c instanceof d.goog.Uri.QueryData?
this.queryData_=c:(b||(c=d.goog.Uri.encodeSpecialChars_(c,d.goog.Uri.reDisallowedInQuery_)),this.queryData_=new d.goog.Uri.QueryData(c,null)),this};d.goog.Uri.prototype.getEncodedQuery=function(){return this.queryData_.toString()};d.goog.Uri.prototype.getDecodedQuery=function(){return this.queryData_.toDecodedString()};d.goog.Uri.prototype.getQueryData=function(){return this.queryData_};d.goog.Uri.prototype.getFragment=function(){return this.fragment_};d.goog.Uri.prototype.setFragment=function(c,
b){return this.fragment_=b?d.goog.Uri.decodeOrEmpty_(c):c,this};d.goog.Uri.prototype.hasFragment=function(){return!!this.fragment_};d.goog.Uri.removeDotSegments=function(c){if(".."==c||"."==c)return"";if(-1==c.indexOf("./")&&-1==c.indexOf("/."))return c;var b=0==c.lastIndexOf("/",0);c=c.split("/");for(var a=[],d=0;d<c.length;){var f=c[d++];"."==f?b&&d==c.length&&a.push(""):".."==f?((1<a.length||1==a.length&&""!=a[0])&&a.pop(),b&&d==c.length&&a.push("")):(a.push(f),b=!0)}return a.join("/")};d.goog.Uri.decodeOrEmpty_=
function(c,b){return c?b?decodeURI(c):decodeURIComponent(c):""};d.goog.Uri.encodeSpecialChars_=function(c,b,a){return d.goog.isString(c)?(c=encodeURI(c).replace(b,d.goog.Uri.encodeChar_),a&&(c=d.goog.Uri.removeDoubleEncoding_(c)),c):null};d.goog.Uri.encodeChar_=function(c){c=c.charCodeAt(0);return"%"+(c>>4&15).toString(16)+(15&c).toString(16)};d.goog.Uri.removeDoubleEncoding_=function(c){return c.replace(/%25([0-9a-fA-F]{2})/g,"%$1")};d.goog.Uri.reDisallowedInSchemeOrUserInfo_=/[#\/\?@]/g;d.goog.Uri.reDisallowedInRelativePath_=
/[\#\?:]/g;d.goog.Uri.reDisallowedInAbsolutePath_=/[\#\?]/g;d.goog.Uri.reDisallowedInQuery_=/[\#\?@]/g;d.goog.Uri.reDisallowedInFragment_=/#/g;d.goog.Uri.QueryData=function(c,b){this.encodedQuery_=c||null};d.goog.Uri.QueryData.prototype.ensureKeyMapInitialized_=function(){if(!this.keyMap_&&(this.keyMap_={},this.count_=0,this.encodedQuery_))for(var c=this.encodedQuery_.split("&"),b=0;b<c.length;b++){var a=c[b].indexOf("="),d=null,f=null;0<=a?(d=c[b].substring(0,a),f=c[b].substring(a+1)):d=c[b];d=decodeURIComponent(d.replace(/\+/g,
" "));f=f||"";this.add(d,decodeURIComponent(f.replace(/\+/g," ")))}};d.goog.Uri.QueryData.prototype.keyMap_=null;d.goog.Uri.QueryData.prototype.count_=null;d.goog.Uri.QueryData.prototype.getCount=function(){return this.ensureKeyMapInitialized_(),this.count_};d.goog.Uri.QueryData.prototype.add=function(c,b){this.ensureKeyMapInitialized_();this.encodedQuery_=null;var a=this.keyMap_.hasOwnProperty(c)&&this.keyMap_[c];return a||(this.keyMap_[c]=a=[]),a.push(b),this.count_++,this};d.goog.Uri.QueryData.prototype.toString=
function(){if(this.encodedQuery_)return this.encodedQuery_;if(!this.keyMap_)return"";var c=[],b;for(b in this.keyMap_)for(var a=encodeURIComponent(b),d=this.keyMap_[b],f=0;f<d.length;f++){var g=a;""!==d[f]&&(g+="="+encodeURIComponent(d[f]));c.push(g)}return this.encodedQuery_=c.join("&")};d.goog.Uri.QueryData.prototype.toDecodedString=function(){return d.goog.Uri.decodeOrEmpty_(this.toString())};d.goog.Uri.QueryData.prototype.clone=function(){var c=new d.goog.Uri.QueryData;if(c.encodedQuery_=this.encodedQuery_,
this.keyMap_){var b={},a;for(a in this.keyMap_)b[a]=this.keyMap_[a].concat();c.keyMap_=b;c.count_=this.count_}return c};d.shaka.dash.mpd.parseMpd=function(c,b){var a=(new DOMParser).parseFromString(c,"text/xml");if(!a)return null;var e={baseUrl:new d.goog.Uri(b)};return d.shaka.dash.mpd.parseChild_(e,a,d.shaka.dash.mpd.Mpd)};d.shaka.dash.mpd.DEFAULT_MIN_BUFFER_TIME_=5;d.shaka.dash.mpd.DEFAULT_SUGGESTED_PRESENTATION_DELAY_=1;d.shaka.dash.mpd.Mpd=function(){this.id=this.url=null;this.type="static";
this.mediaPresentationDuration=this.updateLocation=this.baseUrl=null;this.minBufferTime=d.shaka.dash.mpd.DEFAULT_MIN_BUFFER_TIME_;this.timeShiftBufferDepth=this.availabilityStartTime=this.minUpdatePeriod=null;this.suggestedPresentationDelay=d.shaka.dash.mpd.DEFAULT_SUGGESTED_PRESENTATION_DELAY_;this.periods=[]};d.shaka.dash.mpd.Period=function(){this.segmentTemplate=this.segmentList=this.segmentBase=this.baseUrl=this.duration=this.start=this.id=null;this.adaptationSets=[]};d.shaka.dash.mpd.AdaptationSet=
function(){this.codecs=this.mimeType=this.height=this.width=this.contentType=this.lang=this.id=null;this.main=!1;this.segmentTemplate=this.segmentList=this.segmentBase=this.baseUrl=null;this.contentProtections=[];this.representations=[]};d.shaka.dash.mpd.Role=function(){this.value=null};d.shaka.dash.mpd.ContentComponent=function(){this.contentType=this.lang=this.id=null};d.shaka.dash.mpd.Representation=function(){this.segmentTemplate=this.segmentList=this.segmentBase=this.baseUrl=this.codecs=this.mimeType=
this.height=this.width=this.bandwidth=this.lang=this.id=null;this.contentProtections=[]};d.shaka.dash.mpd.ContentProtection=function(){this.value=this.schemeIdUri=null;this.children=[];this.pssh=null};d.shaka.dash.mpd.CencPssh=function(){this.parsedPssh=this.psshBox=null};d.shaka.dash.mpd.BaseUrl=function(){this.url=null};d.shaka.dash.mpd.Location=function(){this.url=null};d.shaka.dash.mpd.SegmentBase=function(){this.baseUrl=null;this.timescale=1;this.initialization=this.representationIndex=this.indexRange=
this.presentationTimeOffset=null};d.shaka.dash.mpd.SegmentBase.prototype.clone=function(){var c=d.shaka.dash.mpd,b=new d.shaka.dash.mpd.SegmentBase;return b.baseUrl=this.baseUrl?new d.goog.Uri(this.baseUrl):null,b.timescale=this.timescale,b.presentationTimeOffset=this.presentationTimeOffset,b.indexRange=c.clone_(this.indexRange),b.representationIndex=c.clone_(this.representationIndex),b.initialization=c.clone_(this.initialization),b};d.shaka.dash.mpd.RepresentationIndex=function(){this.range=this.url=
null};d.shaka.dash.mpd.RepresentationIndex.prototype.clone=function(){var c=d.shaka.dash.mpd,b=new d.shaka.dash.mpd.RepresentationIndex;return b.url=this.url?new d.goog.Uri(this.url):null,b.range=c.clone_(this.range),b};d.shaka.dash.mpd.Initialization=function(){this.range=this.url=null};d.shaka.dash.mpd.Initialization.prototype.clone=function(){var c=d.shaka.dash.mpd,b=new d.shaka.dash.mpd.Initialization;return b.url=this.url?new d.goog.Uri(this.url):null,b.range=c.clone_(this.range),b};d.shaka.dash.mpd.SegmentList=
function(){this.baseUrl=null;this.timescale=1;this.segmentDuration=this.presentationTimeOffset=null;this.startNumber=1;this.initialization=null;this.segmentUrls=[]};d.shaka.dash.mpd.SegmentList.prototype.clone=function(){var c=d.shaka.dash.mpd,b=new d.shaka.dash.mpd.SegmentList;return b.baseUrl=this.baseUrl?new d.goog.Uri(this.baseUrl):null,b.timescale=this.timescale,b.presentationTimeOffset=this.presentationTimeOffset,b.segmentDuration=this.segmentDuration,b.startNumber=this.startNumber,b.initialization=
c.clone_(this.initialization),b.segmentUrls=this.segmentUrls.map(function(a){return a.clone()}),b};d.shaka.dash.mpd.SegmentUrl=function(){this.mediaRange=this.mediaUrl=null};d.shaka.dash.mpd.SegmentUrl.prototype.clone=function(){var c=d.shaka.dash.mpd,b=new d.shaka.dash.mpd.SegmentUrl;return b.mediaUrl=this.mediaUrl?new d.goog.Uri(this.mediaUrl):null,b.mediaRange=c.clone_(this.mediaRange),b};d.shaka.dash.mpd.SegmentTemplate=function(){this.timescale=1;this.segmentDuration=this.presentationTimeOffset=
null;this.startNumber=1;this.timeline=this.initializationUrlTemplate=this.indexUrlTemplate=this.mediaUrlTemplate=null};d.shaka.dash.mpd.SegmentTemplate.prototype.clone=function(){var c=d.shaka.dash.mpd,b=new d.shaka.dash.mpd.SegmentTemplate;return b.timescale=this.timescale,b.presentationTimeOffset=this.presentationTimeOffset,b.segmentDuration=this.segmentDuration,b.startNumber=this.startNumber,b.mediaUrlTemplate=this.mediaUrlTemplate,b.indexUrlTemplate=this.indexUrlTemplate,b.initializationUrlTemplate=
this.initializationUrlTemplate,b.timeline=c.clone_(this.timeline),b};d.shaka.dash.mpd.SegmentTimeline=function(){this.timePoints=[]};d.shaka.dash.mpd.SegmentTimeline.prototype.clone=function(){var c=new d.shaka.dash.mpd.SegmentTimeline;return c.timePoints=this.timePoints.map(function(b){return b.clone()}),c};d.shaka.dash.mpd.SegmentTimePoint=function(){this.repeat=this.duration=this.startTime=null};d.shaka.dash.mpd.SegmentTimePoint.prototype.clone=function(){var c=new d.shaka.dash.mpd.SegmentTimePoint;
return c.startTime=this.startTime,c.duration=this.duration,c.repeat=this.repeat,c};d.shaka.dash.mpd.Range=function(c,b){this.begin=c;this.end=b};d.shaka.dash.mpd.Range.prototype.clone=function(){return new d.shaka.dash.mpd.Range(this.begin,this.end)};d.shaka.dash.mpd.Mpd.TAG_NAME="MPD";d.shaka.dash.mpd.Period.TAG_NAME="Period";d.shaka.dash.mpd.AdaptationSet.TAG_NAME="AdaptationSet";d.shaka.dash.mpd.Role.TAG_NAME="Role";d.shaka.dash.mpd.ContentComponent.TAG_NAME="ContentComponent";d.shaka.dash.mpd.Representation.TAG_NAME=
"Representation";d.shaka.dash.mpd.ContentProtection.TAG_NAME="ContentProtection";d.shaka.dash.mpd.CencPssh.TAG_NAME="cenc:pssh";d.shaka.dash.mpd.BaseUrl.TAG_NAME="BaseURL";d.shaka.dash.mpd.Location.TAG_NAME="Location";d.shaka.dash.mpd.SegmentBase.TAG_NAME="SegmentBase";d.shaka.dash.mpd.RepresentationIndex.TAG_NAME="RepresentationIndex";d.shaka.dash.mpd.Initialization.TAG_NAME="Initialization";d.shaka.dash.mpd.SegmentList.TAG_NAME="SegmentList";d.shaka.dash.mpd.SegmentUrl.TAG_NAME="SegmentURL";d.shaka.dash.mpd.SegmentTemplate.TAG_NAME=
"SegmentTemplate";d.shaka.dash.mpd.SegmentTimeline.TAG_NAME="SegmentTimeline";d.shaka.dash.mpd.SegmentTimePoint.TAG_NAME="S";d.shaka.dash.mpd.Mpd.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.url=new d.goog.Uri(c.baseUrl);this.id=a.parseAttr_(b,"id",a.parseString_);this.type=a.parseAttr_(b,"type",a.parseString_)||"static";this.mediaPresentationDuration=a.parseAttr_(b,"mediaPresentationDuration",a.parseDuration_);this.minBufferTime=a.parseAttr_(b,"minBufferTime",a.parseDuration_,this.minBufferTime);
this.minUpdatePeriod=a.parseAttr_(b,"minimumUpdatePeriod",a.parseDuration_,this.minUpdatePeriod);this.availabilityStartTime=a.parseAttr_(b,"availabilityStartTime",a.parseDate_,this.availabilityStartTime);this.timeShiftBufferDepth=a.parseAttr_(b,"timeShiftBufferDepth",a.parseDuration_,this.timeShiftBufferDepth);this.suggestedPresentationDelay=a.parseAttr_(b,"suggestedPresentationDelay",a.parseDuration_,this.suggestedPresentationDelay);var e=a.parseChild_(this,b,a.BaseUrl);this.baseUrl=a.resolveUrl_(c.baseUrl,
e?e.url:null);(e=a.parseChild_(this,b,a.Location))&&(this.updateLocation=a.resolveUrl_(c.baseUrl,e.url));this.periods=a.parseChildren_(this,b,a.Period)};d.shaka.dash.mpd.Period.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.id=a.parseAttr_(b,"id",a.parseString_);this.start=a.parseAttr_(b,"start",a.parseDuration_);this.duration=a.parseAttr_(b,"duration",a.parseDuration_);var e=a.parseChild_(this,b,a.BaseUrl);this.baseUrl=a.resolveUrl_(c.baseUrl,e?e.url:null);this.segmentBase=a.parseChild_(this,
b,a.SegmentBase);this.segmentList=a.parseChild_(this,b,a.SegmentList);this.segmentTemplate=a.parseChild_(this,b,a.SegmentTemplate);this.adaptationSets=a.parseChildren_(this,b,a.AdaptationSet)};d.shaka.dash.mpd.AdaptationSet.prototype.parse=function(c,b){var a=d.shaka.dash.mpd,e=a.parseChild_(this,b,a.ContentComponent)||{},f=a.parseChild_(this,b,a.Role);this.id=a.parseAttr_(b,"id",a.parseString_);this.lang=a.parseAttr_(b,"lang",a.parseString_,e.lang);this.contentType=a.parseAttr_(b,"contentType",a.parseString_,
e.contentType);this.width=a.parseAttr_(b,"width",a.parsePositiveInt_);this.height=a.parseAttr_(b,"height",a.parsePositiveInt_);this.mimeType=a.parseAttr_(b,"mimeType",a.parseString_);this.codecs=a.parseAttr_(b,"codecs",a.parseString_);this.main=f&&"main"==f.value;this.lang&&(this.lang=d.shaka.util.LanguageUtils.normalize(this.lang));e=a.parseChild_(this,b,a.BaseUrl);this.baseUrl=a.resolveUrl_(c.baseUrl,e?e.url:null);this.contentProtections=a.parseChildren_(this,b,a.ContentProtection);!this.contentType&&
this.mimeType&&(this.contentType=this.mimeType.split("/")[0]);this.segmentBase=c.segmentBase?a.mergeChild_(this,b,c.segmentBase):a.parseChild_(this,b,a.SegmentBase);this.segmentList=c.segmentList?a.mergeChild_(this,b,c.segmentList):a.parseChild_(this,b,a.SegmentList);this.segmentTemplate=c.segmentTemplate?a.mergeChild_(this,b,c.segmentTemplate):a.parseChild_(this,b,a.SegmentTemplate);this.representations=a.parseChildren_(this,b,a.Representation);!this.mimeType&&this.representations.length&&(this.mimeType=
this.representations[0].mimeType,!this.contentType&&this.mimeType&&(this.contentType=this.mimeType.split("/")[0]))};d.shaka.dash.mpd.Role.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.value=a.parseAttr_(b,"value",a.parseString_)};d.shaka.dash.mpd.ContentComponent.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.id=a.parseAttr_(b,"id",a.parseString_);this.lang=a.parseAttr_(b,"lang",a.parseString_);this.contentType=a.parseAttr_(b,"contentType",a.parseString_);this.lang&&(this.lang=
d.shaka.util.LanguageUtils.normalize(this.lang))};d.shaka.dash.mpd.Representation.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.id=a.parseAttr_(b,"id",a.parseString_);this.bandwidth=a.parseAttr_(b,"bandwidth",a.parsePositiveInt_);this.width=a.parseAttr_(b,"width",a.parsePositiveInt_,c.width);this.height=a.parseAttr_(b,"height",a.parsePositiveInt_,c.height);this.mimeType=a.parseAttr_(b,"mimeType",a.parseString_,c.mimeType);this.codecs=a.parseAttr_(b,"codecs",a.parseString_,c.codecs);this.lang=
c.lang;var e=a.parseChild_(this,b,a.BaseUrl);this.baseUrl=a.resolveUrl_(c.baseUrl,e?e.url:null);this.contentProtections=a.parseChildren_(this,b,a.ContentProtection);this.segmentBase=c.segmentBase?a.mergeChild_(this,b,c.segmentBase):a.parseChild_(this,b,a.SegmentBase);this.segmentList=c.segmentList?a.mergeChild_(this,b,c.segmentList):a.parseChild_(this,b,a.SegmentList);this.segmentTemplate=c.segmentTemplate?a.mergeChild_(this,b,c.segmentTemplate):a.parseChild_(this,b,a.SegmentTemplate);0==this.contentProtections.length&&
(this.contentProtections=c.contentProtections)};d.shaka.dash.mpd.ContentProtection.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.schemeIdUri=a.parseAttr_(b,"schemeIdUri",a.parseString_);this.value=a.parseAttr_(b,"value",a.parseString_);this.pssh=a.parseChild_(this,b,a.CencPssh);this.children=Array.prototype.slice.call(b.childNodes)};d.shaka.dash.mpd.CencPssh.prototype.parse=function(c,b){var a=d.shaka.util.Uint8ArrayUtils,e=d.shaka.dash.mpd.getContents_(b);if(e){this.psshBox=a.fromBase64(e);
try{this.parsedPssh=new d.shaka.util.Pssh(this.psshBox)}catch(f){if(!(f instanceof RangeError))throw f;}}};d.shaka.dash.mpd.BaseUrl.prototype.parse=function(c,b){this.url=d.shaka.dash.mpd.getContents_(b)};d.shaka.dash.mpd.Location.prototype.parse=function(c,b){this.url=d.shaka.dash.mpd.getContents_(b)};d.shaka.dash.mpd.SegmentBase.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.baseUrl=c.baseUrl||this.baseUrl;this.timescale=a.parseAttr_(b,"timescale",a.parsePositiveInt_,this.timescale);
this.presentationTimeOffset=a.parseAttr_(b,"presentationTimeOffset",a.parseNonNegativeInt_,this.presentationTimeOffset);this.indexRange=a.parseAttr_(b,"indexRange",a.parseRange_,this.indexRange);this.representationIndex=a.parseChild_(this,b,a.RepresentationIndex)||this.representationIndex;this.initialization=a.parseChild_(this,b,a.Initialization)||this.initialization};d.shaka.dash.mpd.RepresentationIndex.prototype.parse=function(c,b){var a=d.shaka.dash.mpd,e=a.parseAttr_(b,"sourceURL",a.parseString_);
this.url=a.resolveUrl_(c.baseUrl,e);this.range=a.parseAttr_(b,"range",a.parseRange_,a.clone_(c.indexRange))};d.shaka.dash.mpd.Initialization.prototype.parse=function(c,b){var a=d.shaka.dash.mpd,e=a.parseAttr_(b,"sourceURL",a.parseString_);this.url=a.resolveUrl_(c.baseUrl,e);this.range=a.parseAttr_(b,"range",a.parseRange_)};d.shaka.dash.mpd.SegmentList.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.baseUrl=c.baseUrl||this.baseUrl;this.timescale=a.parseAttr_(b,"timescale",a.parsePositiveInt_,
this.timescale);this.presentationTimeOffset=a.parseAttr_(b,"presentationTimeOffset",a.parseNonNegativeInt_,this.presentationTimeOffset);this.segmentDuration=a.parseAttr_(b,"duration",a.parsePositiveInt_,this.segmentDuration);this.startNumber=a.parseAttr_(b,"startNumber",a.parseNonNegativeInt_,this.startNumber);this.initialization=a.parseChild_(this,b,a.Initialization)||this.initialization;this.segmentUrls=a.parseChildren_(this,b,a.SegmentUrl)||this.segmentUrls};d.shaka.dash.mpd.SegmentUrl.prototype.parse=
function(c,b){var a=d.shaka.dash.mpd,e=a.parseAttr_(b,"media",a.parseString_);this.mediaUrl=a.resolveUrl_(c.baseUrl,e);this.mediaRange=a.parseAttr_(b,"mediaRange",a.parseRange_)};d.shaka.dash.mpd.SegmentTemplate.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.timescale=a.parseAttr_(b,"timescale",a.parsePositiveInt_,this.timescale);this.presentationTimeOffset=a.parseAttr_(b,"presentationTimeOffset",a.parseNonNegativeInt_,this.presentationTimeOffset);this.segmentDuration=a.parseAttr_(b,"duration",
a.parsePositiveInt_,this.segmentDuration);this.startNumber=a.parseAttr_(b,"startNumber",a.parseNonNegativeInt_,this.startNumber);this.mediaUrlTemplate=a.parseAttr_(b,"media",a.parseString_,this.mediaUrlTemplate);this.indexUrlTemplate=a.parseAttr_(b,"index",a.parseString_,this.indexUrlTemplate);this.initializationUrlTemplate=a.parseAttr_(b,"initialization",a.parseString_,this.initializationUrlTemplate);this.timeline=a.parseChild_(this,b,a.SegmentTimeline)||this.timeline};d.shaka.dash.mpd.SegmentTimeline.prototype.parse=
function(c,b){var a=d.shaka.dash.mpd;this.timePoints=a.parseChildren_(this,b,a.SegmentTimePoint)};d.shaka.dash.mpd.SegmentTimePoint.prototype.parse=function(c,b){var a=d.shaka.dash.mpd;this.startTime=a.parseAttr_(b,"t",a.parseNonNegativeInt_);this.duration=a.parseAttr_(b,"d",a.parseNonNegativeInt_);this.repeat=a.parseAttr_(b,"r",a.parseNonNegativeInt_)};d.shaka.dash.mpd.resolveUrl_=function(c,b){var a=b?new d.goog.Uri(b):null;return c?a?c.resolve(a):c:a};d.shaka.dash.mpd.mergeChild_=function(c,b,
a){var e=d.shaka.dash.mpd,f=e.clone_(a);b=e.findChild_(b,a.constructor.TAG_NAME);return b&&f.parse(c,b),f};d.shaka.dash.mpd.parseChild_=function(c,b,a){var e=null;b=d.shaka.dash.mpd.findChild_(b,a.TAG_NAME);return b&&(e=new a,e.parse(c,b)),e};d.shaka.dash.mpd.findChild_=function(c,b){for(var a=null,d=0;d<c.childNodes.length;d++)if(c.childNodes[d].tagName==b){if(a)return null;a=c.childNodes[d]}return a};d.shaka.dash.mpd.parseChildren_=function(c,b,a){for(var d=[],f=0;f<b.childNodes.length;f++)if(b.childNodes[f].tagName==
a.TAG_NAME){var g=new a;g.parse.call(g,c,b.childNodes[f]);d.push(g)}return d};d.shaka.dash.mpd.getContents_=function(c){c=c.firstChild;return c.nodeType!=Node.TEXT_NODE?null:c.nodeValue};d.shaka.dash.mpd.clone_=function(c){return c?c.clone():null};d.shaka.dash.mpd.parseAttr_=function(c,b,a,d){c=a(c.getAttribute(b));return null!=c?c:void 0!==d?d:null};d.shaka.dash.mpd.parseDate_=function(c){if(!c)return null;c=Date.parse(c);return isNaN(c)?null:Math.floor(c/1E3)};d.shaka.dash.mpd.parseDuration_=function(c){if(!c)return null;
var b=/^P(?:([0-9]*)Y)?(?:([0-9]*)M)?(?:([0-9]*)D)?(?:T(?:([0-9]*)H)?(?:([0-9]*)M)?(?:([0-9.]*)S)?)?$/.exec(c);if(!b)return null;c=0;var a=d.shaka.dash.mpd.parseNonNegativeInt_(b[1]);a&&(c+=31536E3*a);(a=d.shaka.dash.mpd.parseNonNegativeInt_(b[2]))&&(c+=2592E3*a);(a=d.shaka.dash.mpd.parseNonNegativeInt_(b[3]))&&(c+=86400*a);(a=d.shaka.dash.mpd.parseNonNegativeInt_(b[4]))&&(c+=3600*a);(a=d.shaka.dash.mpd.parseNonNegativeInt_(b[5]))&&(c+=60*a);b=d.shaka.dash.mpd.parseFloat_(b[6]);return b&&(c+=b),c};
d.shaka.dash.mpd.parseRange_=function(c){var b=/([0-9]+)-([0-9]+)/.exec(c);if(!b)return null;c=d.shaka.dash.mpd.parseNonNegativeInt_(b[1]);if(null==c)return null;b=d.shaka.dash.mpd.parseNonNegativeInt_(b[2]);return null==b?null:new d.shaka.dash.mpd.Range(c,b)};d.shaka.dash.mpd.parsePositiveInt_=function(c){c=window.parseInt(c,10);return 0<c?c:null};d.shaka.dash.mpd.parseNonNegativeInt_=function(c){c=window.parseInt(c,10);return 0<=c?c:null};d.shaka.dash.mpd.parseFloat_=function(c){c=window.parseFloat(c);
return isNaN(c)?null:c};d.shaka.dash.mpd.parseString_=function(c){return c};(function(c){var b=d.core.util,a=function(){function a(b){if(b.mpdAvailabilityStartTime>b.manifestCreationTime)return-1;var c=b.mpdSuggestedPresentationDelay||0,d=b.segmentTemplate,d=d.segmentDuration/d.timescale,e=b.manifestCreationTime-(b.mpdAvailabilityStartTime+b.periodStart);if(0>e)return-1;var f=e-2*d-(b.mpdTimeShiftBufferDepth||0);0>f&&(f=0);f=Math.ceil(f/d)*d;if(0>e)return-1;c=Math.floor(e/d)*d-c;0>c&&(c=0);c=Math.floor(c/
d)*d;return(c>=f?c:f)/d+1+(b.segmentTemplate.startNumber||0)}function c(a){if(a.baseUrl&&a.baseUrl.path_){var b=a.baseUrl.path_.lastIndexOf("/");return-1!==b?a.baseUrl.path_.substring(0,b+1):a.baseUrl.path_}return""}function g(c){var d=b.UrlUtils.combine(c.urlPrefix,b.UrlUtils.combine(c.segmentBaseUrl,c.staticParsedUrlTemplate)),f=Math.ceil(1800/c.normalizedSegmentDuration),g=a(c);if(0>g)return null;for(var h=g+f,k=[];h>g;g++){var l=d.replace("$Number$",g);k.push(l)}return k={segs:k,generateNextSegments:function(a){for(var b,
e,g=0;g<Math.min(d.length,a.length);g++)if(d[g]!==a[g]){b=g;break}for(var g=d.length-1,h=a.length-1;0<=g&&0<=h;g--,h--)if(d[g]!==a[h]){e=h;break}a=a.substring(b,e+1);g=Number(a)+1;a=g+f;b=c.segmentTemplate.segmentDuration/(c.segmentTemplate.timescale||1);for(e=[];a>g;g++)h=d.replace("$Number$",g),e.push(h);return{segs:e,duration:b}}}}function h(a){var c=[],d=[];if(a.segmentTemplate&&a.segmentTemplate.timeline&&a.segmentTemplate.timeline.timePoints&&0<a.segmentTemplate.timeline.timePoints.length)for(var e=
null,f=0;f<a.segmentTemplate.timeline.timePoints.length;f++){for(var g=a.segmentTemplate.timeline.timePoints[f],h=[],k=g.startTime||e||0,e=k+g.duration*(g.repeat||1),l=0;l<(g.repeat||1);k+=g.duration,l++){d.push(g.duration/(a.segmentTemplate.timescale||1));var p=a.staticParsedUrlTemplate.replace("$Time$",k),p=b.UrlUtils.combine(a.urlPrefix,b.UrlUtils.combine(a.segmentBaseUrl,p));h.push(p)}c=c.concat(h)}return{segs:c,durations:d}}function k(a){var c;if(a.periodDuration){var d=a.segmentTemplate.startNumber||
1;c=d+Math.ceil(a.periodDuration/a.normalizedSegmentDuration);for(var e=[];c>d;d++){var f=a.staticParsedUrlTemplate.replace("$Number$",d),f=b.UrlUtils.combine(a.urlPrefix,b.UrlUtils.combine(a.segmentBaseUrl,f));e.push(f)}c={segs:e}}else c=g(a);a=a.segmentTemplate.segmentDuration/(a.segmentTemplate.timescale||1);e=[];for(d=0;d<c.segs.length;d++)e.push(a);return c.durations=e,c}function l(a){var d=c(a);if(a.segmentList&&a.segmentList.segmentUrls&&0<a.segmentList.segmentUrls.length){for(var d=a.segmentList.segmentDuration/
(a.segmentList.timescale||1),e=[],g=0;g<a.segmentList.segmentUrls.length;g++)e.push(d);return{segs:a.segmentList.segmentUrls.map(function(c){return b.UrlUtils.combine(a.urlPrefix,b.UrlUtils.combine(a.segmentBaseUrl,c.mediaUrl.path_))}),durations:e}}if(a.segmentTemplate&&a.segmentTemplate.mediaUrlTemplate){if(a.staticParsedUrlTemplate=a.segmentTemplate.mediaUrlTemplate.replace("$Bandwidth$",a.bandwidth).replace("$RepresentationID$",a.id),a.normalizedSegmentDuration=a.segmentTemplate.timescale?a.segmentTemplate.segmentDuration/
a.segmentTemplate.timescale:a.segmentTemplate.segmentDuration,a.segmentBaseUrl=d,-1!==a.staticParsedUrlTemplate.indexOf("$Time$"))return h(a);if(-1!==a.staticParsedUrlTemplate.indexOf("$Number$")&&(d=k(a)))return d}return[]}function p(a){return"dynamic"===d.shaka.dash.mpd.parseMpd(a,"http://dummy.com/").type}return{extractPlaylistsData:function(a,b){var c=d.shaka.dash.mpd.parseMpd(b,a);if(!c)return null;for(var e=(new Date).getTime()/1E3,f=[],g=c.mediaPresentationDuration,h=0;h<c.periods.length;h++){var k=
c.periods[h];if(g=k.duration||g,k.adaptationSets)for(var x=0;x<k.adaptationSets.length;x++){var B=k.adaptationSets[x];if(B.representations)for(var C=0;C<B.representations.length;C++){var y=B.representations[C];y.mpdType=c.type;y.mpdAvailabilityStartTime=c.availabilityStartTime;y.mpdSuggestedPresentationDelay=c.suggestedPresentationDelay;y.mpdTimeShiftBufferDepth=c.timeShiftBufferDepth;y.periodStart=k.start;y.periodDuration=g;y.manifestCreationTime=e;f.push(y)}}}c=a.split("/");c=c[0]+"//"+c[2]+"/";
e=p(b)?"live":"vod";g={};for(h=0;h<f.length;h++)k=f[h],k.urlPrefix=c,x=l(k),g["representation_"+h+"_"+k.id]={segments:x.segs||[],durations:x.durations||[],mode:e,generateNextSegmentsFunc:x.generateNextSegments};return g},isLiveMod:p}}();c.MPDPlaylistParser=a})(d.core.util);(function(c){var b=function(){function a(a){a=a.split("/");return a[a.length-1]="",a.join("/")}function b(c,e){e=e.toString();var f=a(c);return e.split("\n").filter(function(a){return"#"!==a[0]&&""!==a}).map(function(a){return f&&
-1===a.indexOf(f)&&-1===a.indexOf("://")&&(a=f+a),d.config.ZIXI_DIGEST&&(a=d.core.util.urlDigest.zixi(a)),a})}function c(a){a=a.toString();return a.split("\n").filter(function(a){return-1!==a.indexOf("#EXTINF")}).map(function(a){var b=a.indexOf(",");return-1===b?Number(a.substring(8)):Number(a.substring(8,b))})}function g(b,c){var e=a(b);return c.split("\n").filter(function(a){return-1===a.indexOf("#")&&!!a.match(/\.(m3u8)(.*)?/)}).map(function(a){return e&&-1===a.indexOf(e)&&-1===a.indexOf("://")&&
(a=e+a),d.config.ZIXI_DIGEST&&(a=d.core.util.urlDigest.zixi(a)),a})}function h(a){a=a.toString();return-1===a.indexOf("#EXT-X-ENDLIST",Math.max(0,a.length-15))}return{extractPlaylistsData:function(a,d){var p=g(a,d);if(p&&0<p.length){for(var n=Object.create(null),m=0;m<p.length;m++)n[p[m]]=null;return n}var p=b(a,d),n=c(d),m=h(d)?"live":"vod",q={};return q[a]={segments:p,durations:n,mode:m},q},isLiveMod:h}}();c.M3U8PlaylistParser=b})(d.core.util);(function(c){var b=function(){function a(a){return-1<
a.indexOf("m3u8")?d.core.util.M3U8PlaylistParser:-1<a.indexOf("mpd")?d.core.util.MPDPlaylistParser:null}return{isPlaylistCandidate:function(b){return b.responseType&&"text"!==b.responseType?!1:a(b._url)?!0:!1},getParser:a}}();c.PlaylistParserFactory=b})(d.core.util);(function(c){c.Playlist=function(b){function a(a,b,c){for(;c>b;b++)l[a.segments[b]]={duration:a.durations[b]}}function c(b){var d=b.segments;if(d&&0!==d.length&&(-1===k.indexOf(d[0])||-1===k.indexOf(d[d.length-1]))){if(-1!==k.indexOf(d[0])){for(var e=
0;e<d.length&&-1!==k.indexOf(d[e]);e++);a(b,e,d.length);b=d.slice(e);return void(k=k.concat(b))}if(-1!==k.indexOf(d[d.length-1])){for(e=0;e<d.length&&-1===k.indexOf(d[e]);e++);a(b,0,e);return void(k=d.slice(0,e).concat(k))}a(b,0,d.length);k=d.slice()}}function d(a){return k.indexOf(a)}function g(b,c){var e=d(b)+1,g=e+c;if(g>=k.length&&h){for(var l=h(k[k.length-1]),p=[],u=0;u<l.segs.length;u++)p[u]=l.duration;a({segments:l.segs,durations:p},0,l.segs.length);k=k.concat(l.segs)}return k.slice(e,g)}var h=
b.generateNextSegments,k=[],l=Object.create(null),p=b.mode;return c(b),{getSegments:function(){return k},addSegments:c,getIndex:d,getNextSegmentUrl:function(a){a=k.indexOf(a);return 0===k.length||a===k.length-1?null:-1===a?k[0]:k[a+1]},deleteToSegment:function(a){a=k.indexOf(a);-1!==a&&k.splice(0,a)},getSegmentsInterval:g,getSegmentsDataInterval:function(a,b){return g(a,b).map(function(a){return{segment:a,segmentData:l[a]}})},getMode:function(){return p},getSegmentData:function(a){return{segment:a,
segmentData:l[a]}}}}})(d.core.playlist);(function(c){c.PlaylistsHandler=function(){function b(a,b){if(!b)return[];void 0!==f[a]?f[a].addSegments(b):f[a]=d.core.playlist.Playlist(b);for(var c=0;c<b.segments.length;c++)g[b.segments[c]]=a;return b.segments}function a(a){var b=g[a];a=f[b].getSegmentData(a);return a.segmentData.playlistName=b,a}function c(){var b=k.segment;if(!b)return null;var d=a(b);if("live"!==f[d.segmentData.playlistName].getMode())return null;for(var e=(Date.now()-k.timeStamp)/1E3,
d=d.segmentData.duration-e,e=f[g[b]].getSegments(),h=0,b=e.indexOf(b)+1;b<e.length;b++)var q=a(e[b]),h=h+q.segmentData.duration;return h+=d,Math.round(h)}var f=Object.create(null),g=Object.create(null),h=null,k={segment:null,timeStamp:null};return radio("external.playback").subscribe(function(a){a.currentSegment&&(k.segment=a.currentSegment,k.timeStamp=Date.now())}),d.config.FEATURE_REPORT_LIVE_DELAY&&setInterval(function(){var a=c();null!==a&&radio("playbackDelay").broadcast(a)},d.config.DELAY_REPORT_INTERVAL),
{getPlaylists:function(){return f},setLastRequestedSegment:function(a){h=a},deleteToSegment:function(a){f[g[a]].deleteToSegment(a)},getNextSegmentUrl:function(a){return f[g[a]].getNextSegmentUrl(a)},getPositionRelativeToLastRequested:function(a){if(!h)return null;var b=f[g[h]];a=b.getIndex(a);if(-1===a)return null;b=b.getIndex(h);return a-b},getNextSegmentsWindow:function(a){return!h||0>=a?[]:f[g[h]].getSegmentsInterval(h,a)},getNextSegmentsDataWindow:function(a){if(!h||0>=a)return null;var b=g[h];
a=f[b].getSegmentsDataInterval(h,a);a.forEach(function(a){a.segmentData.playlistName=b});return{segmentsData:a,playlistName:b}},lastRequestedSegmentExists:function(){return h?-1<f[g[h]].getIndex(h):!1},extractSegments:function(a,c){var e=d.core.util.PlaylistParserFactory.getParser(a);if(!e)return[];e=e.extractPlaylistsData(a,c);if(!e)return[];var f=[],g;for(g in e){var h=b(g,e[g]);h&&0<h.length&&(f=f.concat(h))}return f},updatePlaylist:b,hasLivePlaylist:function(){for(var a in f)if("live"===f[a].getMode())return!0;
return!1},getSegmentData:a}}})(d.core.playlist);(function(c){c.ManifestManipulator=function(b){function a(a,b,c){var e=c-d.config.SEGMENTS_AFTER_PRUNE+1;if(0>=e)return a;c=a.indexOf(b[0])-1;b=a.indexOf(b[e])-1;c=a.slice(0,c);a=a.slice(b);a=c.concat(a);return a=a.map(function(a){-1!==a.indexOf("#EXT-X-MEDIA-SEQUENCE")&&(a="#EXT-X-MEDIA-SEQUENCE: "+(+a.match(/\d+/)[0]+e));return a})}function c(b){if(d.config.EXTERNAL_MEDIA_LIVE_START_POS&&-1!==d.config.EXTERNAL_MEDIA_LIVE_START_POS)return f;var e=d.core.util.M3U8PlaylistParser.extractPlaylistsData("",
f)[""];if(!e||"live"!==e.mode||!e||void 0===e.durations)return f;for(var k=0,l=e.durations.length;b>k&&0<l;)k+=e.durations[l-1],l--;if(l=Math.max(l,d.config.MIN_NUMBER_OF_REMAINING_SEGMENTS),e.segments.length<=l)return f;var p;b=f.split("\n").map(function(a){return","===a[a.length-1]?a.substring(0,a.length-1):a});k=b.indexOf(e.segments[l])-1;b=b.slice(0,k);return p=d.config.FEATURE_PRUNE_SEGMENTS_FROM_START?a(b,e.segments,l-1):b,p.join("\n")}var f=b;return{delayManifest:function(a){if("string"!=typeof f||
!f||0===f.length||0===a)return f;if(-1<f.indexOf("#EXTM3U"))return c(a);var b=(new DOMParser).parseFromString(f,"application/xml"),k=b.querySelector("MPD");if(k&&"dynamic"===k.getAttribute("type")){k=b;b=k.documentElement.outerHTML;if(-1!==b.indexOf("$Time$"))for(var l=k.querySelectorAll("SegmentTemplate"),p=0;p<l.length;p++)for(var n=l[p],m=a,q=n.getAttribute("timescale"),r=m*q,n=n.querySelector("SegmentTimeline"),m=n.querySelectorAll("S");0<r&&0<m.length;){for(var t=q=m[m.length-1],v=t.getAttribute("d"),
u=t.getAttribute("r")||0;0<=u&&0<r;)r-=v,u--;if(r=(t.setAttribute("r",u),r),0>q.getAttribute("r")){if(!(1<m.length)){q.setAttribute("r",0);break}n.removeChild(q)}m=n.querySelectorAll("S")}if(-1!==b.indexOf("$Number$")){l=a;if(p=k.querySelector("MPD").getAttribute("suggestedPresentationDelay"))p=d.core.util.durationToSeconds(p),0>p&&(p=0),l=Math.min(l,p);p=null;n=k.querySelectorAll("SegmentTemplate");for(m=0;m<n.length;m++)q=n[m],(t=q.getAttribute("startNumber"))&&0<t&&(p=k,r=q.getAttribute("duration"),
v=q.getAttribute("timescale"),q.setAttribute("startNumber",Math.max(0,t-Math.floor(l/(v?r/v:r)))));if(l=p)k=l;else if(l=k.documentElement.getAttribute("availabilityStartTime"))l=new Date(l),k=(l.setSeconds(l.getSeconds()+a),k.documentElement.setAttribute("availabilityStartTime",l.toISOString()),k)}if(-1!==b.indexOf("SegmentList")){b=k;k=b.querySelectorAll("SegmentList");for(l=0;l<k.length;l++)for(p=k[l],n=a,m=Number(p.getAttribute("duration")),q=p.getAttribute("timescale"),m=Math.floor(n/(m/(q?Number(q):
1))),n=p.querySelectorAll("SegmentURL"),m=n.length>m?m:n.length-1,q=n.length-1;0<m;q--,m--)p.removeChild(n[q]);k=b}return k.documentElement.outerHTML}return f}}}})(d.core.util);(function(c){c.requestToXhr=function(){function b(a,b){return a?function(){if(0<arguments.length){var c;c=arguments[0];var d=Object.create(null),h;for(h in c)d[h]=c[h];c=(d.currentTarget=b,d);a.call(b,c)}else a.call(b)}:null}return{create:function(a,c){var d=new XMLHttpRequest,g;for(g in a)void 0===d[g]&&(d[g]=a[g]);d.open("GET",
a._url);d.responseType=a.responseType;d.onloadstart=b(a.onloadstart,a);d.onprogress=b(a.onprogress,a);d.onabort=b(a.onabort,a);d.onerror=b(a.onerror,a);d.onload=b(a.onload,a);d.ontimeout=b(a.ontimeout,a);d.onloadend=b(a.onloadend,a);d.addEventListener("readystatechange",function(b){for(var g in this)"responseXML"!==g&&"responseText"!==g&&"function"!=typeof d[g]&&("response"===g&&4===b.currentTarget.readyState&&c?a[g]=c(d[g]):a[g]=d[g]),"responseXML"!==g||""!==d.responseType&&"document"!==d.responseType||
(a[g]=d[g]),"responseText"!==g||""!==d.responseType&&"text"!==d.responseType||4===b.currentTarget.readyState&&(c?a[g]=c(d[g]):a[g]=d[g]);b=this.getAllResponseHeaders();a.setResponseHeaders(b)});d.onreadystatechange=a.onreadystatechange?a.onreadystatechange.bind(d):null;for(var h in a.eventListeners)for(g=0;g<a.eventListeners[h].length;g++)d.addEventListener(h,b(a.eventListeners[h][g],a));return d}}}()})(d.core.util);(function(c){c.createPlaylistCache=function(){var b=Object.create(null);return{save:function(a,
c){b[a]=c},load:function(a){return b[a]},remove:function(a){b[a]=null},clear:function(){b=Object.create(null)}}}})(d.core.util);(function(c){c.PrefetchRequestSender=function(b,a){var c=function(){var c=new d.Request({downloadMode:b.downloadMode||"p2p"}),e=b.segment;return c._segmentData=b,c.mediaPrefetch=!0,c.responseType="blob",c.open("GET",e),c.onswarmstatechange=function(b){a.onswarmstatechange&&a.onswarmstatechange(b)},c.onerror=function(b){d.info("onerror prefetching resource: "+e);a.onerror&&
a.onerror(b)},c.onabort=function(b){a.onabort&&a.onabort(b)},c.onload=function(b){d.info(b);d.info("onload "+e);var c={type:"fileDownloaded",url:b.currentTarget._url,loaded:b.loaded,p2p:b.loadedP2P,http:b.loadedHTTP,waste:b.loadedP2P+b.loadedHTTP-b.total,fileSize:b.total,downloadTimeMS:Date.now()-b.currentTarget.timestamp};window.P2PPerformanceUpdate&&window.P2PPerformanceUpdate(c);a.onload&&a.onload(b)},d.info("requesting "+e),c}();return{send:function(){return c.send(),c}}}})(d.core.util);(function(c){c.prePlayPrefetcher=
function(b,a){function c(a,b){d.info("prefetching "+a.segment+" in p2p");a.downloadMode="p2p";var e=d.core.util.PrefetchRequestSender(a,{onswarmstatechange:function(a){q.requestSwarmStateChanged(a)},onerror:function(a){t.reportRequestDone("error");b()},onabort:function(a){t.reportRequestDone("abort");v.onRequestEvent("abort",a);b()},onload:function(a){t.reportRequestDone("load");v.onRequestEvent("load",a);200===a.currentTarget.status&&q.saveDownloadSpeed(a.currentTarget);b()}}).send();return t.useP2PSlot(),
u[e._segmentData.segment]=e,e}function f(a){var b=new XMLHttpRequest;b.open("GET",a);b.onload=function(){var b=d.core.util.PlaylistParserFactory.getParser(a),c=b.extractPlaylistsData(a,this.response),e=Object.keys(c);(c=c[e[0]])?(r.extractSegments(a,this.response),c.rawContent=this.response,c.manifestUrl=a,b.isLiveMod(this.response)?k(c):(A.save(a,this.response),c.segments&&0!==c.segments.length&&(b=p(c.segments[0]),l(b.segmentsData)))):(A.save(a,this.response),f(e[0]))};b.send()}function g(){var a=
d.core.util.ManifestManipulator(m.rawContent).delayManifest(d.config.LIVE_SECONDS_DELAY);A.save(m.manifestUrl,a);var a=d.core.util.PlaylistParserFactory.getParser(m.manifestUrl).extractPlaylistsData(m.manifestUrl,a),b=Object.keys(a);if((a=a[b[0]].segments)&&0!==a.length)for(var b=null,c=0;c<d.config.PLAYER_SEGMENTS_BUFFER&&0<a.length;c++)b=a.pop();else b=(d.warn("delayed manifest shouldnt be empty"),null);if(!b)return 0;a=0;for(b=m.segments.indexOf(b);b<m.segments.length;b++){var c=v.getAvgDownloadTime(m.manifestUrl),
e=m.durations[b];if(a>=e*c)break;a+=e}return b}function h(){if(!x){for(var a=null,b=g();b<m.segments.length&&(a=m.segments[b],u[a]);b++);if(a)for(var a=p(a),d=t.availableP2PSlots();b<m.segments.length&&0<d;b++){var f=a.segmentsData.shift();c(f,function(){h()});d--}}}function k(a){m=a;h();x||setTimeout(function(){f(a.manifestUrl)},d.config.PREFETCH_LIVE_INTERVAL_MS)}function l(a){if(!x)for(var b=t.availableP2PSlots();0<b&&0<a.length;){var d=a.shift();c(d,function(){l(a)});b--}}function p(a){var b=
r.getSegmentData(a);r.setLastRequestedSegment(a);a=r.getNextSegmentsDataWindow(d.config.SEGMENTS_TO_PREFETCH_BEFORE_PLAY);return a.segmentsData.unshift(b),a}function n(){x=!0;Object.keys(u).forEach(function(a){a=u[a];4!==a.readyState&&a.abort()})}var m,q=a,r=b.playlistsHandler,t=b.prefetchSlotsHandler,v=b.prefetchSpeedEstimator,u=Object.create(null),A=b.playlistsCache,x=!1;return{startPrefetch:function(a){f(a);setTimeout(function(){n();A.clear()},1E3*d.config.STOP_PREFETCH_AFTER_SECONDS)},stopPrefetch:n}}})(d.core.util);
(function(c){var b=2*d.config.TIME_ESTIMATION_LIST_LENGTH;c.PrefetchSpeedEstimator=function(){function a(a,g){var h=a.segmentData.playlistName,k=a.segmentData.duration;c[h]||(c[h]=[]);c[h].unshift({duration:k,downloadTime:g/1E3});c[h].length>b&&c[h].splice(d.config.TIME_ESTIMATION_LIST_LENGTH,d.config.TIME_ESTIMATION_LIST_LENGTH)}var c=Object.create(null);return{onRequestEvent:function(b,c){var d=c.currentTarget,e=Date.now()-d._startTime;if("load"===b)a(d._segmentData,e);else if("abort"===b){var l=
c.total?c.loadedP2P/c.total:0;0!==l&&a(d._segmentData,e/l)}},getAvgDownloadTime:function(a){if(!c[a]||0===c[a].length)return d.config.INITIAL_DL_SECS_ESTIMATION;a=c[a];for(var b=0,h=0,k=0;k<Math.min(d.config.TIME_ESTIMATION_LIST_LENGTH,a.length);k++)var l=a[k],b=b+l.duration,h=h+l.downloadTime;return h/b}}}})(d.core.util);(function(c){c.PrefetchSlotsHandler=function(b){function a(a){if(d.config.FEATURE_LIMIT_SLOTS_BY_PEERS&&0!==a){var b=k.availableP2PSlots+c;a>=b||(k.availableP2PSlots-=Math.min(b-
a,b-d.config.MINIMUM_P2P_SLOTS),g=h=0)}}var c=0,f=!1,g=0,h=0,k={availableP2PSlots:d.config.INITIAL_P2P_SLOTS};return function(){radio("activePeerConnectionsNumberChanged").subscribe([a,this])}(),{availableP2PSlots:function(){return k.availableP2PSlots},useP2PSlot:function(){k.availableP2PSlots--;c++},askForP2PSlot:function(){f=!0},reportRequestDone:function(a){k.availableP2PSlots++;c--;switch(a){case "error":g=0;break;case "abort":h++;h>=d.config.REDUCE_SLOT_ABORTS_THRESHOLD&&!(k.availableP2PSlots+
c<=d.config.MINIMUM_P2P_SLOTS)&&(k.availableP2PSlots--,g=h=0);g=0;break;case "load":g++,g>=d.config.ADD_SLOT_LOADED_REQUESTS_THRESHOLD&&f&&(d.config.FEATURE_LIMIT_SLOTS_BY_PEERS?(a=k.availableP2PSlots+c,b()>a&&(k.availableP2PSlots++,f=!1,g=h=0)):(k.availableP2PSlots++,f=!1,g=h=0))}}}}})(d.core.util);(function(c){c.SegmentsPrefetcher=function(b,a){function c(a){a.downloadMode="p2p";a=d.core.util.PrefetchRequestSender(a,{onswarmstatechange:function(a){k.requestSwarmStateChanged(a)},onerror:function(a){p.reportRequestDone("error");
k.onP2PPrefetchComplete()},onabort:function(a){radio("p2pAbort").broadcast(a.currentTarget.fileInfo.swarmId);p.reportRequestDone("abort");k.onP2PPrefetchComplete();n.onRequestEvent("abort",a)},onload:function(a){p.reportRequestDone("load");k.onP2PPrefetchComplete();n.onRequestEvent("load",a);200===a.currentTarget.status&&k.saveDownloadSpeed(a.currentTarget)}}).send();return p.useP2PSlot(),m[a._segmentData.segment]=a,a}function f(){if(!q||!q.segmentData)return 0;var a=q.segmentData.duration,b=(Date.now()-
q.segmentData.playerAskTime)/1E3;return a-b}function g(a,b){var c=0;b.forEach(function(a){m[a.segment]||c++});c>a&&p.askForP2PSlot()}function h(a,b){if(r[a.segment])return null;var d=a.segmentData.duration,d=n.getAvgDownloadTime(a.segmentData.playlistName)*d;if(d*=1.15,null===b||b>d)if(d=k.getSeeders(a.segment),0<(d?Object.keys(d).length:0)&&!m[a.segment])return{xhr:c(a),url:a.segment};return null}var k=a,l=b.playlistsHandler,p=b.prefetchSlotsHandler,n=b.prefetchSpeedEstimator,m=Object.create(null),
q=null,r=Object.create(null),t=!0;return{prefetchSegments:function(){var a=l.getNextSegmentsDataWindow(d.config.P2P_VOD_WINDOW);if(!a||0===a.segmentsData.length)return[];var b=a.segmentsData,c=p.availableP2PSlots();g(c,b);for(var e=f(),a=[],k=0,m=0;c>k&&m<b.length;m++){var n=b[m],q=h(n,e);q&&(a.push(q),k++);e+=n.segmentData.duration}if(0===a.length){a:if(0===p.availableP2PSlots())b=(d.warn("no available p2p slots for too long"),null);else{for(c=b.length-1;0<=c;c--)if(e=h(b[c],null)){b=e;break a}b=
null}b&&a.push(b)}return a},updatePlayerLastRequestedSegment:function(a){l.setLastRequestedSegment(a);if(t){var b=l.getNextSegmentsDataWindow(d.config.P2P_VOD_WINDOW).segmentsData;if(b)for(var c=f(),c=d.config.EXTERNAL_MEDIA_MAXBUFFER-c;0<c&&0<b.length;){var e=b.shift();r[e.segment]=!0;c-=e.segmentData.duration}t=!1}a=l.getSegmentData(a);a.segmentData.playerAskTime=Date.now();q=a;delete m[a.segment]}}}})(d.core.util);(function(c){var b=!1;c.createManifestRequest=function(a){function c(a){if(a&&-1===
a.indexOf(".m3u8")){b=!0;var e=d.config.LIVE_SECONDS_DELAY;return d.core.util.ManifestManipulator(a).delayManifest(e)}return a}function f(a){return a}return b?d.core.util.requestToXhr.create(a,f):d.core.util.requestToXhr.create(a,c)}})(d.client);(function(c){d.core.apis.MediaFetcher=Object.subClass({ctor:function(){this.segmentsInfo=Object.create(null);this.interceptRequests=Object.create(null);this.playlistsHandler=d.core.playlist.PlaylistsHandler();this.playlistsCache=d.core.util.createPlaylistCache();
this.prePlaySegmentsPrefetcher=this.segmentsPrefetcher=null;this.requests=Object.create(null);this.p2pPendingRequests=this.httpPendingRequests=this.numOfPeers=0;this.peersHave=Object.create(null);this.requestLRU=new d.core.dataStructures.LRU(null,this._scavange.bind(this),this._requestCacheTester.bind(this));this.totalRequestSize=0;this.downloadSpeed=[0,0];this.playerStarted=!1;this.MAX_REQUEST_CACHE_SIZE_LIVE;radio("requestSent").subscribe([this._interceptP5Request,this]);radio("activePeerConnectionsNumberChanged").subscribe([this._changeNumOfPeers,
this]);radio("receivedHaveMessage").subscribe([this._handleHaveMessage,this]);radio("receivedDontHaveMessage").subscribe([this._handleDontHaveMessage,this]);radio("connectionFailed").subscribe([this._handleConnectionFail,this]);radio("external.prePlayPrefetch").subscribe([this._prePlayPrefetch,this]);this._initPrefetchers()},_initPrefetchers:function(){var b={increaseP2PPendingRequests:this._increaseP2PPendingRequests.bind(this),increaseHTTPPendingRequests:this._increaseHTTPPendingRequests.bind(this),
decreaseP2PPendingRequests:this._decreaseP2PPendingRequests.bind(this),decreaseHTTPPendingRequests:this._decreaseHTTPPendingRequests.bind(this),requestSwarmStateChanged:this._requestSwarmStateChanged.bind(this),saveDownloadSpeed:this._saveDownloadSpeed.bind(this),reportProgress:this.reportProgress,onP2PPrefetchComplete:this._prefetch.bind(this),getSeeders:function(a){a=d.core.util.urlDigest.getNormalizedUrlHash(a);return this.segmentsInfo[a]}.bind(this)},a=function(){return this.numOfPeers}.bind(this),
a={playlistsHandler:this.playlistsHandler,prefetchSlotsHandler:d.core.util.PrefetchSlotsHandler(a),prefetchSpeedEstimator:d.core.util.PrefetchSpeedEstimator(),playlistsCache:this.playlistsCache};this.segmentsPrefetcher=d.core.util.SegmentsPrefetcher(a,b);this.prePlaySegmentsPrefetcher=d.core.util.prePlayPrefetcher(a,b)},_prePlayPrefetch:function(b){d.config.FEATURE_PRE_PLAY_PREFETCH&&d.Request!==XMLHttpRequest&&this.prePlaySegmentsPrefetcher.startPrefetch(b)},_interceptP5Request:function(b){b.mediaPrefetch||
(this.interceptRequests[b._url]?this._interceptSegmentRequest(b):!this.interceptRequests[b._url]&&d.core.util.PlaylistParserFactory.isPlaylistCandidate(b)?(this.prePlaySegmentsPrefetcher.stopPrefetch(),this.playerStarted=!0,this._interceptPlaylistRequest(b)):d.config.INTERCEPT_AES&&-1!==b._url.indexOf("aes")?(d.core.util.requestToXhr.create(b).send(),b._get=!1):d.warn("didnt intercept: "+b._url))},_interceptPlaylistRequest:function(b){d.info("Intercepted a playlist request");b._get=!1;var a=this.playlistsCache.load(b._url);
if(a)return void d.core.util.envokeCallback(function(){var c=this;setTimeout(function(){c.playlistsCache.remove(b._url)},1E3);b.addEventListener("load",this._measurePlaylistSpeed.bind(this));b.addEventListener("load",this._parsePlaylist.bind(this));b.forceImmediateLoad(a)},null,this);b.addEventListener("load",this._cachePlaylist.bind(this));var c=d.client.createManifestRequest(b);if(c.addEventListener("load",this._parsePlaylist.bind(this)),c.addEventListener("load",this._measurePlaylistSpeed.bind(this)),
d.config.PLAYLIST_SPEED_ESTIMATION&&0===this.downloadSpeed[0]&&c.addEventListener("progress",this._playlistRequestProgress.bind(this)),c.send(),d.config.PLAYLIST_TIMEOUT){var f=d.config.PLAYLIST_TIMEOUT_DURATION;setTimeout(function(){4>c.readyState&&(d.info("playlist request timedout "+c._url),c.abort())}.bind(this),f)}},_interceptSegmentRequest:function(b){if(d.info("intercepted an interesting request: "+b._url),d.client.FailedUrls.contains(b._url)){var a=d.core.util.requestToXhr.create(b);return a.addEventListener("load",
this._requestLoaded.bind(this)),a.send(),void(b._get=!1)}d.config.FEATURE_P2P_IMPROVEMENT_ENABLED?this.segmentsPrefetcher.updatePlayerLastRequestedSegment(b._url):this.playlistsHandler.setLastRequestedSegment(b._url);this._requestExist(b._url)?this._updateRequest(b,b._url):this._addRequest(b,b._url);this._overrideInterceptedRequest(b);b.addEventListener("load",this._requestLoaded.bind(this));b.addEventListener("swarmstatechange",this._requestSwarmStateChanged.bind(this))},_changeNumOfPeers:function(b){this.numOfPeers=
b;this.reportProgress({type:"swarmChange",peers:b})},_handleHaveMessage:function(b,a){var c=b.hashUrl;this.segmentsInfo[c]||(this.segmentsInfo[c]=Object.create(null));this.segmentsInfo[c][a]=b.seeder?!0:!1;this.peersHave[a]||(this.peersHave[a]=Object.create(null));this.peersHave[a][c]=!0;this._prefetch("p2p")},_handleDontHaveMessage:function(b,a){d.info("received"+b+" from peer"+a);var c=b.hashUrl;this.segmentsInfo[c]&&this.segmentsInfo[c][a]&&(delete this.segmentsInfo[c][a],delete this.peersHave[a][c])},
_handleConnectionFail:function(b){if(this.peersHave[b]){for(var a=Object.keys(this.peersHave[b]),c=0,d=a.length;d>c;c++)delete this.segmentsInfo[a[c]][b];delete this.peersHave[b]}},_playlistRequestProgress:function(b){b.currentTarget.startTime||(b.currentTarget.startTime=performance.now())},_measurePlaylistSpeed:function(b){if(d.config.PLAYLIST_SPEED_ESTIMATION&&0===this.downloadSpeed[0]){var a=performance.now()-b.currentTarget.startTime;b=1E3*b.total/a;radio("playlistSpeedEstimation").broadcast(b)}},
_requestLoaded:function(b){d.info("request "+b.currentTarget._url+" loaded");2===b.currentTarget.downloadMode?this._decreaseP2PPendingRequests():this._decreaseHTTPPendingRequests();this.reportProgress({type:"fileDownloaded",url:b.currentTarget._url,loaded:b.loaded,p2p:b.loadedP2P,http:b.loadedHTTP,waste:b.loadedP2P+b.loadedHTTP-b.total,fileSize:b.total,downloadTimeMS:Date.now()-b.currentTarget.timestamp});200==b.currentTarget.status&&(this.playlistsHandler.deleteToSegment(b.currentTarget._url),this._saveDownloadSpeed(b.currentTarget),
setTimeout(function(){this._prefetch("http");this._prefetch("p2p")}.bind(this),10))},_requestSwarmStateChanged:function(b){b.sent&&this.reportProgress({type:"swarmChange",sent:b.sent})},_prefetch:function(b){if(this.playerStarted&&0!==this.numOfPeers)if(this.playlistsHandler.lastRequestedSegmentExists()||d.warn("last id player requested is not found"),d.config.FEATURE_P2P_IMPROVEMENT_ENABLED){var a=this.segmentsPrefetcher.prefetchSegments();for(b=0;b<a.length;b++){var c=a[b];this._addRequest(c.xhr,
c.url)}}else if("http"===b){if(!(this.httpPendingRequests>=d.config.MAX_HTTP_REQUESTS)){a=[];c=this.playlistsHandler.getNextSegmentsWindow(d.config.HTTP_VOD_WINDOW);for(b=0;b<c.length;b++){var f=c[b];if(!this._requestExist(f)){var g=d.core.util.urlDigest.getNormalizedUrlHash(f),g=Object.keys(this.segmentsInfo[g]).length;0===g&&a.push(f)}}f=a[Math.floor(Math.random()*a.length)];if(!f)return void this._prefetch("p2p");d.info("prefetching "+f+" in http");this._requestP5(f,null,{downloadMode:"http"});
this._prefetch("http")}}else if("p2p"===b&&!(this.p2pPendingRequests>=d.config.MAX_P2P_REQUESTS)){var a=[],h=1,c=this.playlistsHandler.getNextSegmentsWindow(d.config.P2P_VOD_WINDOW);for(b=0;b<c.length;b++)if(f=c[b],!this._requestExist(f)&&(g=d.core.util.urlDigest.getNormalizedUrlHash(f),g=this.segmentsInfo[g]))g=Object.keys(g).length,g===h?a.push(f):g>h&&(a=[f],h=g);if(f=a[Math.floor(Math.random()*a.length)])d.info("prefetching "+f+" in p2p"),this._requestP5(f,null,{downloadMode:"p2p"}),this._prefetch("p2p")}},
_requestP5:function(b,a,c){var f=new d.Request({downloadMode:c.downloadMode});f.mediaPrefetch=!0;f.responseType="blob";f.open("GET",b);var g=this;f.onswarmstatechange=this._requestSwarmStateChanged.bind(this);f.onerror=function(a){c.downloadMode&&"p2p"===c.downloadMode?g._decreaseP2PPendingRequests():g._decreaseHTTPPendingRequests();d.info("onerror prefetching resource: "+b);g._scavange(b,f);g._prefetch(c.downloadMode||"http")};f.onabort=function(a){c.downloadMode&&"p2p"===c.downloadMode?(radio("p2pAbort").broadcast(a.currentTarget.fileInfo.swarmId),
g._decreaseP2PPendingRequests()):g._decreaseHTTPPendingRequests();g._prefetch(c.downloadMode||"http")};f.onload=function(a){d.info(a);d.info("onload "+b);g.reportProgress({type:"fileDownloaded",url:b,loaded:a.loaded,p2p:a.loadedP2P,http:a.loadedHTTP,waste:a.loadedP2P+a.loadedHTTP-a.total,fileSize:a.total,downloadTimeMS:Date.now()-a.currentTarget.timestamp});c.downloadMode&&"p2p"===c.downloadMode?g._decreaseP2PPendingRequests():g._decreaseHTTPPendingRequests();200===this.status&&(g._saveDownloadSpeed(this),
g._prefetch(c.downloadMode||"http"))};d.info("requesting "+b);c.downloadMode&&"p2p"===c.downloadMode?(this._increaseP2PPendingRequests(),d.info("request:p2pPendingRequests = "+this.p2pPendingRequests+" , "+b)):this._increaseHTTPPendingRequests();this._addRequest(f,b);f.send()},_requestExist:function(b){return b in this.requests},_addRequest:function(b,a){d.info("adding request "+a+" to requests");b.timestamp=Date.now();this.requests[a]=b;this.requestLRU.set(a,b);var c=!1;b.addEventListener("readystatechange",
function(a){!c&&2<=a.currentTarget.readyState&&a.lengthComputable&&(this.totalRequestSize+=a.total,c=!0)}.bind(this))},_updateRequest:function(b,a){d.info("updating request "+a+" to requests");b.timestamp=Date.now();var c=this.requests[a];4>c.readyState&&(d.info("aborting a prefetched request:"+a),c.abort(),this.reportProgress({type:"requestAborted",mode:2===c.downloadMode?"p2p":"http"}),this._saveDownloadSpeed(c));this.requests[a]=b;this.requestLRU.update(a,b)},_scavange:function(b,a){if(d.info("removing request"+
b),!a)return void d.warn("scavanging an undefined request");var c=a.getFileInfo();c?(a.abort({leaveSwarm:!0}),2<=a.readyState&&(this.totalRequestSize-=c.size)):d.warn("scavanged a request that hadnt initiated"+b);delete this.requests[b]},_requestCacheTester:function(){return this.totalRequestSize>this.MAX_REQUEST_CACHE_SIZE},_cachePlaylist:function(b){d.info("caching playlist");var a=b.currentTarget._url;this.playlistsCache.save(a,b.currentTarget.response);var c=this;setTimeout(function(){c.playlistsCache.remove(a)},
1E3)},_parsePlaylist:function(b){if(d.info("parsing playlist"),"blob"===b.currentTarget.responseType)return void d.warn("playlist was requested as a blob",b.currentTarget._url);var a=b.currentTarget._url;b=b.currentTarget.response;this.MAX_REQUEST_CACHE_SIZE=this.playlistsHandler.hasLivePlaylist()?d.config.MAX_REQUEST_CACHE_SIZE_LIVE:d.config.MAX_REQUEST_CACHE_SIZE_VOD;if((a=this.playlistsHandler.extractSegments(a,b))&&0!==a.length){for(b=0;b<a.length;b++){var c=a[b],f=d.core.util.urlDigest.getNormalizedUrlHash(c);
this.segmentsInfo[f]||(this.segmentsInfo[f]=Object.create(null));this.interceptRequests[c]=!0}d.info(this.segmentsInfo)}},_overrideInterceptedRequest:function(b){var a,c=d.core.util.urlDigest.getNormalizedUrlHash(b._url),c=Object.keys(this.segmentsInfo[c]).length;0===c?a=0:1<=c&&(a=this.downloadSpeed[1]);var f;d.config.AGGRESSIVE_P2P&&a>this.downloadSpeed[0]?(d.info("override interception to p2p"),b.downloadMode=2,f=d.config.P2P_TIMEOUT_DURATION,this._increaseP2PPendingRequests()):(d.info("override interception to http"),
b.downloadMode=3,f=d.config.HTTP_TIMEOUT_DURATION,this._increaseHTTPPendingRequests());d.config.REQUEST_TIMEOUT&&setTimeout(function(){4>b.readyState&&(d.info("intercepted request timedout "+b._url),b.abort(),2===b.downloadMode?this._decreaseP2PPendingRequests():this._decreaseHTTPPendingRequests(),this._saveDownloadSpeed(b))}.bind(this),f)},_saveDownloadSpeed:function(b){var a=b._speed;a&&(2===b.downloadMode?(b=d.core.util.urlDigest.getNormalizedUrlHash(b._url),b=(Object.keys(this.segmentsInfo[b]).length,
1)):b=0,this.downloadSpeed[b]=a,d.info("speed ="+a+" bucket="+b))},_increaseHTTPPendingRequests:function(){this.httpPendingRequests++},_increaseP2PPendingRequests:function(){this.p2pPendingRequests++},_decreaseHTTPPendingRequests:function(){this.httpPendingRequests--;0>this.httpPendingRequests&&d.error("p2pPendingRequests smaller than 0")},_decreaseP2PPendingRequests:function(){this.p2pPendingRequests--;0>this.p2pPendingRequests&&d.error("p2pPendingRequests smaller than 0")},reportProgress:function(b){window.P2PPerformanceUpdate&&
window.P2PPerformanceUpdate(b)}});c.core.apis.MediaFetcher=new d.core.apis.MediaFetcher;c.prefetch=function(b){radio("external.prePlayPrefetch").broadcast(b)}})(d);(function(c){if(c&&c.config.PIXEL_SWARM){var b=c.core.util.MD5.hash(window.location.href);c=new c.core.protocol.Join(b);radio("router.send").broadcast(c)}})(d);(function(){d.core.data.CacheManager=Object.subClass({ctor:function(){this.mb=1048576},getRandomArbitrary:function(c,b){return Math.floor(Math.random()*(b-c)+c)},testFillLibrary:function(c,
b,a){this.fillLibraryWithMultipleFiles(0,c,b,a,function(a){console.log("wrote all test files")})},fillLibraryWithMultipleFiles:function(c,b,a,e,f){var g=this,h=this.getRandomArbitrary(a,e);if(console.log(h),c==b)f(!0);else{var k=Date.now();d.core.data.FSio.createResource(k,function(l){console.log("started to write file with id "+k);d.core.data.FSio.write(k,new Uint8Array([]),h,function(d,l){d?(console.log("wrote file with id "+k),g.fillLibraryWithMultipleFiles(c+1,b,a,e,f)):"space"===l&&g.handleOutOfSpace(k,
h,function(){console.log("handleOutOfSpace")})})},!0)}},performHandleOuOfSpaceMainFunction:function(c,b,a,e,f,g,h){d.core.data.FSio.getLibraryStatistics(function(k){f=k;k=c.getFileSizeFromArray(b,f.filesStats);var l=c.sumFilesSizeExcludingCurrent(b,f.filesStats),p=0,n=[],m=0;if(a>(k+l+h)/g)c.failedToCleanUpOutOfSpace(b,f,e);else{for(c.sortArrayOfFilesObjectByLastModified(f.filesStats);(g*a-k-h>p||(l-k-h)/2+a>p)&&m<f.filesStats.length;){if(-1==f.filesStats[m].key.toString().indexOf(".fi")&&b!=f.filesStats[m].key&&
c.isSafeToDeleteFile(f.filesStats[m])){n.push(f.filesStats[m]);var q=c.findCorrespondingFileInfo(f.filesStats,f.filesStats[m].key+".fi");q&&n.push(q);p+=f.filesStats[m].size}m++}p>=g*a-k-h?d.core.data.FSio.deleteFiles(n,d.core.data.FSio,function(a){a?e&&e(!0):(d.error("deleteFiles failed for an unknown reason"),e&&e(!1))}):c.failedToCleanUpOutOfSpace(b,f,e)}})},handleOutOfSpace:function(c,b,a){var e,f=this,g=0;d.config.IS_FIREFOX?(e=2,g=0,f.performHandleOuOfSpaceMainFunction(f,c,b,a,void 0,e,g)):
(e=1,d.core.data.FSio.getUnUsedQuotaSpace(function(d){g=d;f.performHandleOuOfSpaceMainFunction(f,c,b,a,void 0,e,g)}))},test:function(){var c,b=this;d.core.data.FSio.getLibraryStatistics(function(a){c=a;b.standardCleanUp(c,function(a){console.log(a)})})},standardCleanUp:function(c,b){var a=0,e=[],f=0;for(this.sortArrayOfFilesObjectByLastModified(c.filesStats);a<c.size/2&&f<c.filesStats.length;){if(-1==c.filesStats[f].key.toString().indexOf(".fi")&&this.isSafeToDeleteFile(c.filesStats[f])){e.push(c.filesStats[f]);
var g=this.findCorrespondingFileInfo(c.filesStats,c.filesStats[f].key+".fi");g&&e.push(g);a+=c.filesStats[f].size}f++}d.core.data.FSio.deleteFiles(e,d.core.data.FSio,function(a){a?b&&b(!0):b&&b(!1)})},testCleanOldFiles:function(){this.cleanOldFiles(function(c){console.log(c)})},isSafeToDeleteFile:function(c){var b=0;return b=Date.now()-c.lastModified.getTime(),b<d.config.TIME_PERIOD_FILE_STILL_LIVE?!1:!0},cleanOldFiles:function(c){var b=this;d.core.data.FSio.getLibraryStatistics(function(a){var e=
[],f=0;b.sortArrayOfFilesObjectByLastModified(a.filesStats);for(var g in a.filesStats)if(f=Date.now()-a.filesStats[g].lastModified.getTime(),f>d.config.PERIODIC_CACHE_CLEANUP_PERIOD){e.push(a.filesStats[g]);var h=b.findCorrespondingFileInfo(a.filesStats,a.filesStats[g].key+".fi");h&&e.push(h)}d.core.data.FSio.deleteFiles(e,d.core.data.FSio,function(a){a?c&&c(!0):c&&c(!1)})})},convertMiliToDays:function(c){return Math.floor(c/864E5)},findCorrespondingFileInfo:function(c,b){var a,d;for(d in c)c[d].key==
b&&(a=c[d]);return a},spliceFileObjectFromArray:function(c,b){for(var a in c)c[a].key==b&&c.splice(a,1)},sortArrayOfFilesObjectByLastModified:function(c){return c.sort(function(b,a){var c=new Date(b.lastModified),d=new Date(a.lastModified);return d>c?-1:c>d?1:0}),c},getFileSizeFromArray:function(c,b){var a=0,d;for(d in b)if(b[d].key==c){a=b[d].size;break}return a},sumFilesSizeExcludingCurrent:function(c,b){for(var a=0,d=0;d<b.length;d++)b[d].key!=c&&this.isSafeToDeleteFile(b[d])&&(a+=b[d].size);return a},
failedToCleanUpOutOfSpace:function(c,b,a){var e=this,f=[],g=this.findCorrespondingFileInfo(b.filesStats,c),h=this.findCorrespondingFileInfo(b.filesStats,c+".fi");g&&f.push(g);h&&f.push(h);g&&(b.size-=g.size);h&&(b.size-=h.size);this.spliceFileObjectFromArray(b.filesStats,c);this.spliceFileObjectFromArray(b.filesStats,c+".fi");d.core.data.FSio.deleteFiles(f,d.core.data.FSio,function(c){d.warn("handleOutOfSpace can not clean enough space for the wanted download ");e.standardCleanUp(b,function(b){a(!1)})})}});
d.core.data.CacheManager=new d.core.data.CacheManager})();(function(){d.contentLoaded=function(c,b){var a=!1,d=!0,f=c.document,g=f.documentElement,h=f.addEventListener?"addEventListener":"attachEvent",k=f.addEventListener?"removeEventListener":"detachEvent",l=f.addEventListener?"":"on",p=function(d){"readystatechange"==d.type&&"complete"!=f.readyState||(("load"==d.type?c:f)[k](l+d.type,p,!1),a||!(a=!0)||b.call(c,d.type||d))},n=function(){try{g.doScroll("left")}catch(a){return void setTimeout(n,50)}p("poll")};
if("complete"==f.readyState)b.call(c,"lazy");else{if(f.createEventObject&&g.doScroll&&!f.addEventListener){try{d=!c.frameElement}catch(m){}d&&n()}f[h](l+"DOMContentLoaded",p,!1);f[h](l+"readystatechange",p,!1);c[h](l+"load",p,!1)}}})();(function(c){var b=Object.create(null);b.initialize="Initializing file...";b.filesystem="Please allow the file to be stored to your computer";b.complete="Download complete";b.verify="Verifying file...";b.speed="Speed by peers";b.peers="Peers";b.error_generic="An error has occurred while downloading, please retry.";
b.error_filesize="File size is too big, please allow persistent storage.";b.error_diskspace="Not enough disk space, please clear some space and retry.";b.error_write="A problem has occurred while writing to disk, please retry.";b.error_corrupt="The file you have downloaded is corrupt, please contact site owner.";b.error_connection="There is a connectivity problem, please check your connection.";c.messages=b})(d);(function(){function c(a,b){return Array.prototype.slice.call((b||document).querySelectorAll(a))}
function b(){a.resizing||(a.resizing=!0,window.requestAnimationFrame(function(){a.instances.forEach(function(a){a.checkPanesWidth();a.resize()});a.resizing=!1}))}function a(b){this.document_container=b;this.instances=[];this.$children=[];this.elementInited=this.feedback_open=!1;a.instances.push(this)}function e(a,b){var c=b.filename.split("."),e=c.pop(),c=c.join(".");this.manager=a;this.options=b;this.completed=this.paused=this.started=!1;this.drawn=Object.create(null);this.paint_buffer=[];this.buffering=
!1;this.chunks_in_block=d.config.BLOCK_SIZE/d.config.CHUNK_SIZE;this.new_disp_speed=409600+102400*Math.random();this.disp_speed=0;this.url=b.url;this.waste_color=this.fs_color=this.http_color=g;this.colors=[g];this.num_of_peers=0;this.start_time=Date.now();this._debug();this._initElement();this._initCanvas();this.setFilename(c);this.setFileExt(e);this.displayInitializing();this.manager.resize()}function f(){e.apply(this,arguments);var a,b=document.body;a=window.getComputedStyle(b).getPropertyValue("overflow");
"visible"!=a&&(this._old_body_overflow=a,b.style.setProperty("overflow","visible","important"));window.addEventListener("touchmove",this._touchMoveHandler,!1)}var g="#428bca",h=Math.PI/180,k=!1,l="jpg jpeg jpe jfif gif png bmp tif tiff".split(" "),p={"p5-dl-container-template":'<div class="p5-dl-main-wrapper">\n    <ul class="p5-dl-main"></ul>\n</div>\n<div class="p5-dl-scroller"><span class="p5-dl-grip"></span></div>\n<div class="p5-dl-feedback">\n    <form class="p5-dl-feedback-form" method="post" action="//peer5.com/feedback-form">\n        <div class="p5-dl-feedback-left">\n            <span class="p5-dl-need-help">ANY FEEDBACK?</span>\n            <ul>\n                <li>\n                    <label><input type="radio" name="rating" value="1" /></label>\n                </li>\n                <li>\n                    <label><input type="radio" name="rating" value="2" /></label>\n                </li>\n                <li>\n                    <label><input type="radio" name="rating" value="3" /></label>\n                </li>\n                <li>\n                    <label><input type="radio" name="rating" value="4" /></label>\n                </li>\n                <li>\n                    <label><input type="radio" name="rating" value="5" /></label>\n                </li>\n            </ul>\n            <span class="p5-dl-feedback-open"></span>\n\n            <a target="_blank" href="https://www.peer5.com"><div class="p5-dl-brand"></div></a>\n        </div>\n        <div class="p5-dl-feedback-right">\n            <textarea class="p5-dl-feedback-comment" name="comment" placeholder="YOUR FEEDBACK HERE"></textarea>\n            <span class="p5-dl-feedback-submit">SUBMIT</span>\n        </div>\n    </form>\n</div>\n',
"p5-dl-pane-template":'<span class="p5-dl-button p5-dl-close-pane"></span>\n<div class="p5-dl-progress">\n    <div class="p5-dl-progress-fill"></div>\n    <span class="p5-dl-progress-label"></span>\n    <span class="p5-dl-button p5-dl-pause p5-dl-hide"></span>\n    <span class="p5-dl-button p5-dl-play"></span>\n    <span class="p5-dl-button p5-dl-done p5-dl-hide"></span>\n</div>\n<div class="p5-dl-meta">\n    <h1 class="p5-dl-file">\n        <span class="p5-dl-filename p5-dl-ellipsis"></span><span\n            class="p5-dl-file-ext p5-dl-em"></span>\n    </h1>\n\n    <div class="p5-dl-stats">\n        <div class="p5-dl-peers-speed">\n            <span class="p5-dl-stats-datum p5-dl-stats-peers"><span class="p5-dl-stats-peers-content"></span></span><span\n                class="p5-dl-stats-datum p5-dl-stats-speed p5-dl-stats-speed-content"></span><span\n                class="p5-dl-extra-speed p5-dl-extra-speed-content"></span>\n        </div><span\n            class="p5-dl-stats-datum p5-dl-stats-time p5-dl-stats-time-content"></span><span\n            class="p5-dl-stats-datum p5-dl-stats-size"><span class="p5-dl-stats-size-content"></span><span\n            class="p5-dl-stats-size-total p5-dl-stats-size-total-content"></span></span>\n        <div class="p5-dl-stats-message"></div>\n    </div>\n</div>\n'},
n=function(){var a=document.createElement("div").style;return"transition"in a?"transitionend":"webkitTransition"in a?"webkitTransitionEnd":"msTransition"in a?"MSTransitionEnd":null}();window.matchMedia?window.addEventListener("load",function(){if(window.matchMedia("only screen and (min-device-width : 320px) and (max-device-width : 640px) and (max-device-height: 768px)").matches){k=!0;var a,b=document.querySelector("meta[name=viewport]"),c={width:"device-width","user-scalable":"no","initial-scale":"1"},
d=[],e=!1;b?(a=b.getAttribute("content").match(/([-\w]+=[^\s,]*)/g),a&&a.length&&a.forEach(function(a){a=a.split("=");a[0]in c||d.push(a[0]+"="+a[1])})):(b=document.createElement("meta"),b.setAttribute("name","viewport"),e=!0);Object.keys(c).forEach(function(a){d.push(a+"="+c[a])});b.setAttribute("content",d.join(", "));e&&document.head.appendChild(b)}},!1):window.addEventListener("resize",b,!1);a.instances=[];a.prototype._initElement=function(){var a=this.$container=document.createElement("div");
a.classList.add("p5-dl-container");a.classList.add("p5-dl-hide");a.innerHTML=p["p5-dl-container-template"];this.$el=c(".p5-dl-main",this.$container)[0];this.document_container.appendChild(a)};a.prototype.resize=function(){k||this.instances.forEach(function(a){a.resize()})};a.prototype.checkPanesWidth=function(){if(!k){var a,b=this.$el,c=b.clientWidth,d=this.$children,e=d.length;400*e+8*(e-1)>=c?(b.parentNode.classList.add("p5-dl-fixed-panes"),d.forEach(function(a){a.style.removeProperty("width")}),
d[0].classList.remove("p5-dl-only-child")):(b.parentNode.classList.remove("p5-dl-fixed-panes"),1<e?(a=Math.floor((c-8*(e-1))/e),d.forEach(function(b){b.style.width=a+"px"}),d[0].classList.remove("p5-dl-only-child")):e&&(d[0].classList.add("p5-dl-only-child"),d[0].style.removeProperty("width")))}};a.prototype.addPane=function(a){return this.elementInited||(this._initElement(),this._initFeedbackForm(),this.elementInited=!0),k?new f(this,a):new e(this,a)};a.prototype.open=function(a){this.instances.length||
(this.$container.classList.remove("p5-dl-hide"),document.body.classList.add("p5-dl-fixed"));this.instances.push(a);this.$children.push(a.$el);this.$el.insertBefore(a.$el,this.$el.firstChild);this.checkPanesWidth()};a.prototype.close=function(a){this.instances.splice(this.instances.indexOf(a),1);this.$children.splice(this.$children.indexOf(a.$el),1);this.instances.length||(this.$container.classList.add("p5-dl-hide"),document.body.classList.remove("p5-dl-fixed"));this.$el.removeChild(a.$el);this.checkPanesWidth();
this.resize()};a.prototype.serializeFeedbackForm=function(){var a=new FormData(this.$feedback_form),b=window.location,c=b.href.replace(b.protocol+"//"+b.hostname,""),e=b.port,f=this.collectStats();return e&&(c=c.replace(":"+e,"")),a.append("user_agent",window.navigator.userAgent),a.append("user_domain",b.hostname),a.append("path",c),a.append("log_capture",d.logString.substring(0,1048576)||"n.a"),a.append("files",JSON.stringify(f)),a};a.prototype._initFeedbackForm=function(){var a,b=!1,d=function(){this.checkPanesWidth();
this.resize();b&&window.requestAnimationFrame(d)}.bind(this),e=function(){b=!1},f=function(a){this.feedback_open=!this.feedback_open;null==n&&setTimeout(e,300);this.$container.classList.toggle("p5-dl-feedback-opened");b=!0;window.requestAnimationFrame(d)}.bind(this),g=function(a){this.$submit.removeEventListener("click",g,!1);var b=new XMLHttpRequest;a=this.serializeFeedbackForm();b.open("POST","https://api.peer5.com/downloader-feedback");b.onreadystatechange=function(){4===b.readyState&&this.$submit.addEventListener("click",
g,!1)}.bind(this);b.send(a);c(".p5-dl-feedback-comment")[0].value="";f()}.bind(this);this.$feedback_container=c(".p5-dl-feedback",this.$container)[0];this.$feedback_form=c(".p5-dl-feedback-form",this.$container)[0];this.$submit=c(".p5-dl-feedback-submit",this.$feedback_form)[0];n&&this.$feedback_container.addEventListener(n,e,!1);this.$submit.addEventListener("click",g,!1);c(".p5-dl-feedback-open",this.$container)[0].addEventListener("click",f,!1);c("input[name=rating]",this.$feedback_form).forEach(function(b){b.addEventListener("change",
function(c){this.feedback_open||f();c=b.parentNode.parentNode;a&&a.classList.remove("p5-dl-checked");b.checked&&(c.classList.add("p5-dl-checked"),c.parentNode.classList.add("p5-dl-checked"),a=c)}.bind(this),!1)},this)};a.prototype.collectStats=function(){return this.instances.map(function(a){return a.collectStats()})};e.prototype.update=function(a){if(!this.paused){var b={},c=a.Avg_Recv_P2P+a.Avg_Recv_HTTP,e=a.Total_Recv_No_Waste;this.size||(this.file_size=a.size,this.size=z(a.size),this.size_type=
this.size.substring(this.size.length-2),b.size=this.size);this.total_avg_download=a.Total_Avg_Download;this.disp_speed?this.new_disp_speed=.9*this.disp_speed+.1*c:this.new_disp_speed=c;this.disp_speed=Math.floor(this.new_disp_speed);10>this.disp_speed&&(this.disp_speed=0);c=this.disp_speed?Math.floor((a.size-e)/this.disp_speed):"Forever";null==this.eta||86400<this.eta||c+1==this.eta||10<this.eta_off||isNaN(this.eta)&&!isNaN(c)?(this.eta_off=0,this.eta=c):(this.eta_off++,this.eta--);var f=this.eta;
if(1>f||isNaN(f))c="00:00:00";else if(86400<f)c="Calculating...";else var c=Math.floor(f%31536E3%86400/3600),g=Math.floor(f%31536E3%86400%3600/60),f=Math.floor(f%31536E3%86400%3600%60),c=(9<c?""+c:"0"+c)+":"+(9<g?""+g:"0"+g)+":"+(9<f?""+f:"0"+f);b.time=c;b.speed=this.disp_speed;c=0;0<a.Total_Recv_HTTP&&0<a.Total_Recv_P2P&&(c=(a.Total_Recv_HTTP+a.Total_Recv_P2P)/a.Total_Recv_HTTP,c=Math.round(100*(c-1)),c=Math.min(c,999),0<c&&(b.extra_speed=c));c=z(e,1)+"";a=(this.completion_rate=e/a.size,b.downloaded=
c,e<a.size?b.progress=Math.round(e/a.size*100):(d.warn("FileUI trimmed the percentage to 100%"),b.progress=100),b);a.size&&this.setTotalSize(a.size);a.time&&this.setTime(a.time);a.speed&&this.setSpeed(a.speed);this.setExtraSpeed(a.extra_speed);a.downloaded&&this.setSize(a.downloaded);a.progress&&this.setProgress(a.progress)}};e.prototype.collectStats=function(){return{speed_avg:this.total_avg_download||-1,completion_rate:this.completion_rate||-1,file_size:this.file_size||-1,time_elapsed:this.start_time?
Date.now()-this.start_time:-1}};e.prototype.enablePause=function(){this.$pause.classList.remove("p5-dl-hide")};e.prototype.disablePause=function(){this.$pause.classList.add("p5-dl-hide")};e.prototype.setFilename=function(a){this.$filename.textContent=a};e.prototype.setFileExt=function(a){this.$fileext.textContent="."+a;~"iso, tar, gz, lz, lzma, lzo, rz, xz, 7z, s7z, ace, apk, arc, arj,ice,jar,rar,zip,zipx,cab,lzh,bz2,uue,z".indexOf(a)?this.$file_type.classList.add("p5-dl-zip"):~"webm, mkv, flv, ogv, ogg, avi, mov, qt, wmv, rm, rmvb, mp4, m4p,m4v,mpg,mp2,mpeg,mpe,mpv,m2v,m4v,3gp,3g2".indexOf(a)?
this.$file_type.classList.add("p5-dl-media"):~l.indexOf(a)&&this.$file_type.classList.add("p5-dl-pic")};e.prototype.setProgress=function(a){this.progress=a;this.$progress_fill.style.height=a/100*this.progress_fill_max_height+"px";this.$progress.textContent=a+"%"};e.prototype.setTime=function(a){a?this.$time.textContent=a:this.$time.textContent=""};e.prototype.setSpeed=function(a){isNaN(a)?this.$speed.textContent="":this.$speed.textContent=z(Math.floor(1.1*a),1048576<a?2:0)+"/s"};e.prototype.setSize=
function(a){a?this.$size.textContent=a+"/":this.$size.textContent=""};e.prototype.setTotalSize=function(a){this.$total_size.textContent=a};e.prototype.setPeers=function(a){isNaN(a)?this.$peers.textContent="":(this.num_of_peers=a,this.$peers.textContent=a+" "+window.peer5.messages.peers)};e.prototype.setExtraSpeed=function(a){a?(this.$extra_speed.textContent="+"+a+"% "+window.peer5.messages.speed,this.$peers_speed.classList.add("p5-dl-has-peers")):this.$peers_speed.classList.remove("p5-dl-has-peers")};
e.prototype.setNumOfChunks=function(a){this.num_of_chunks=Math.ceil(a/d.config.CHUNK_SIZE);this.num_of_blocks=this.num_of_chunks/this.chunks_in_block};e.prototype._debug=function(){0<location.hash.indexOf("visual")&&(this.colors="#3491E3 #2871B0 #1D507D #62A7E3 #8FBCE3 #4F677D".split(" "),this.http_color="#111111",this.fs_color="#555555",this.waste_color="#FFFFFF",radio("peer5_pending_http_chunk").subscribe([function(a,b){this.paintHttp(a,.5)},this]),radio("peer5_p2p_pending_chunk").subscribe([function(a,
b,c){this.paintP2p(a,.5,c)},this]))};e.prototype._initElement=function(){var a=this.$el=document.createElement("li");a.classList.add("p5-dl-pane");a.innerHTML=p["p5-dl-pane-template"];this.manager.open(this);this.progress_fill_max_height=c(".p5-dl-progress",this.$el)[0].clientHeight-8;this.$progress_fill=c(".p5-dl-progress-fill",this.$el)[0];this.$pause=c(".p5-dl-pause",this.$el)[0];this.$play=c(".p5-dl-play",this.$el)[0];this.$done=c(".p5-dl-done",this.$el)[0];this.$close=c(".p5-dl-close-pane",this.$el)[0];
this.$filename=c(".p5-dl-filename",this.$el)[0];this.$fileext=c(".p5-dl-file-ext",this.$el)[0];this.$progress=c(".p5-dl-progress-label",this.$el)[0];this.$peers=c(".p5-dl-stats-peers-content",this.$el)[0];this.$speed=c(".p5-dl-stats-speed-content",this.$el)[0];this.$extra_speed=c(".p5-dl-extra-speed-content",this.$el)[0];this.$peers_speed=c(".p5-dl-peers-speed",this.$el)[0];this.$time=c(".p5-dl-stats-time-content",this.$el)[0];this.$total_size=c(".p5-dl-stats-size-total-content",this.$el)[0];this.$file_type=
c(".p5-dl-stats-size",this.$el)[0];this.$size=c(".p5-dl-stats-size-content",this.$el)[0];this.$message=c(".p5-dl-stats-message",this.$el)[0];this.$pause.addEventListener("click",this.pause.bind(this),!1);this.$play.addEventListener("click",this.resume.bind(this),!1);this.$close.addEventListener("click",this.close.bind(this),!1)};e.prototype._initCanvas=function(){var a,b=document.createElement("canvas");return this.canvas=b,b.classList.add("boxes"),this.$el.insertBefore(b,this.$el.firstChild),a=window.getComputedStyle(this.$el),
this.canvas_width=+a.getPropertyValue("width").slice(0,-2),this.canvas_height=6,b.width=this.canvas_width,b.height=this.canvas_height,this.ctx=b.getContext("2d"),this.ctx.strokeStyle="rgba(255,101,35,1)",this.ctx.fillStyle="rgba(255,101,35,1)",this.ctx.lineWidth=4,this};e.prototype.pause=function(){this.paused=!0;this.$pause.style.display="none";this.$play.style.display="block";this.options.pause(this)};e.prototype.resume=function(){this.paused=!1;this.$play.style.display="none";this.$pause.style.display=
"block";this.options.resume(this)};e.prototype.resize=function(){this.resized=!0;this.canvas_width=+window.getComputedStyle(this.$el).getPropertyValue("width").slice(0,-2);this.canvas.width=this.canvas_width;this.ctx.strokeStyle="rgba(255,101,35,1)";this.ctx.fillStyle="rgba(255,101,35,1)";this.ctx.lineWidth=4;this.draw()};e.prototype.draw=function(a){this.resized&&(this.resized=!1,this.drawState());arguments.length&&this.drawChunk(a)};e.prototype.drawState=function(){var a,b=this.drawn;for(a in b)this.drawBlock(a)};
e.prototype.drawChunk=function(a){var b=Math.floor(a/this.chunks_in_block),c=this.drawn[b];c||(c=this.drawn[b]=[]);~c.indexOf(a)||(c.push(a),this.drawBlock(b))};e.prototype.drawBlock=function(a){var b=this.canvas_width/this.num_of_blocks;this.paint((a*b|0)%this.canvas_width,this.drawn[a].length/this.chunks_in_block*b)};e.prototype.fillBuffer=function(a,b){this.paint_buffer.push([a,b])};e.prototype.paint=function(a,b){this.fillBuffer(a,b);this.buffering||(this.buffering=!0,window.requestAnimationFrame(this._paint.bind(this)))};
e.prototype._paint=function(){for(var a,b=this.paint_buffer;a=b.pop();)this.ctx.fillRect(a[0],0,a[1]||1,6);this.buffering=!1};e.prototype.close=function(){this.manager.close(this);this.options.close(this)};e.prototype.getColor=function(a){return this.colors[a.charCodeAt(0)%this.colors.length]};e.prototype.paintFs=function(a,b,c){this.draw(a,b,this.fs_color)};e.prototype.paintHttp=function(a,b,c){this.draw(a,b,this.http_color)};e.prototype.paintP2p=function(a,b,c){this.draw(a)};e.prototype.paintWasteP2p=
function(a,b){this.draw(a,b,this.waste_color)};e.prototype.paintWasteHttp=function(a,b,c){this.draw(a,b,this.waste_color)};e.prototype.displayDownloadStart=function(){this.setMessage();this.enablePause();this.setPeers(0)};e.prototype.displayInitializing=function(){this.setMessage(window.peer5.messages.initialize)};e.prototype.displayFilesystemAuth=function(a){a?this.setMessage(window.peer5.messages.filesystem):this.setMessage(window.peer5.messages.initialize)};e.prototype.displayCompleted=function(a){this.completed=
!0;100!==this.progress&&(d.warn("FileUI trimmed the percentage to 100%"),this.setProgress(100),this.setSize(z(a)));this.disablePause();this.$el.classList.add("p5-dl-completed");this.setSpeed(this.total_avg_download);this.$done.classList.remove("p5-dl-hide");this.setMessage(window.peer5.messages.complete)};e.prototype.displayVerifying=function(){this.setMessage(window.peer5.messages.verify)};e.prototype.concealStats=function(){this.setExtraSpeed();this.setSize();this.setSpeed();this.setTime();this.setPeers()};
e.prototype.showError=function(a){this.paused=!0;this.disablePause();this.concealStats();this.setMessage(String(a))};e.prototype.setMessage=function(a){a?(this.$message.textContent=a,this.setExtraSpeed()):this.$message.textContent=""};f.prototype=Object.create(e.prototype,{constructor:{value:f},_initCanvas:{value:function(){var a=c(".p5-dl-progress",this.$el)[0],b=document.createElement("canvas"),d=window.getComputedStyle(a);return this.canvas=b,b.classList.add("arcs"),this.canvas_width=+d.getPropertyValue("width").slice(0,
-2)+20,this.canvas_height=+d.getPropertyValue("height").slice(0,-2)+20,a.parentNode.insertBefore(b,a),b.width=this.canvas_width,b.height=this.canvas_height,this.ctx=b.getContext("2d"),this.ctx.strokeStyle="rgba(255,101,35,1)",this.ctx.fillStyle="rgba(255,101,35,1)",this.ctx.lineWidth=4,this.x=this.canvas_width/2,this.r=this.canvas_width/2-8,this.y=this.canvas_height/2,this.ctx.beginPath(),this},enumerable:!0},drawBlock:{value:function(a){var b=360/this.num_of_blocks,c=a*b%360;this.paint(c,c+this.drawn[a].length/
this.chunks_in_block*b)},enumerable:!0},fillBuffer:{value:function(a,b){this.ctx.moveTo(this.x+this.r*Math.cos(a*h),this.y+this.r*Math.sin(a*h));this.ctx.arc(this.x,this.y,this.r,a*h,b*h)},enumerable:!0},_paint:{value:function(){this.ctx.stroke();this.ctx.beginPath();this.buffering=!1},enumerable:!0},close:{value:function(){e.prototype.close.call(this);this._old_body_overflow&&(document.body.style.setProperty("overflow",this._old_body_overflow),this._old_body_overflow=null);window.removeEventListener("touchmove",
this._touchMoveHandler,!1)},enumerable:!0},_touchMoveHandler:{value:function(a){a.preventDefault()},enumerable:!0}});d.client.downloader.PaneManager=a})();d.client.downloader.AdManager=Object.subClass({name:"peer5.client.downloader.AdManager",ctor:function(c){this.container=c},display:function(c,b){function a(){if(Math.random()>d.config.AD_SMPL_RTIO){var a=document.createElement("div"),b=document.createElement("div");a.className="p5-dl-ad-display";b.className="p5-dl-ad-overlay";a.innerHTML=d.config.AD_FRAME}else a=
document.createElement("div"),b=document.createElement("div"),a.className="p5-dl-ad-display",b.className="p5-dl-ad-overlay",a.innerHTML=d.config.AD_FRAME2;b.appendChild(a);b=document.createElement("span");b.className="p5-dl-button p5-dl-ad-display-close";b.onclick=function(a){this.parentNode.remove();clearInterval(thi$.intervalId)};a.appendChild(b);thi$.container.appendChild(a)}function e(){var a=document.querySelector("div.p5-dl-ad-display > iframe");a.src=a.src}isNaN(c)?this.delay=0:this.delay=
c;isNaN(b)?this.refresh=0:this.refresh=b;thi$=this;setTimeout(function(){a();0<thi$.refresh&&(thi$.intervalId=setInterval(e,thi$.refresh))},this.delay)},stop:function(){}});(function(){d.download=function(a,c){if(c||(c={}),!a)return d.error("Empty URL"),!1;var g=document.createElement("a");if(g.href=a,a=g.href,c.name?c.name=c.name.toString():c.name=decodeURI(a.substr(a.lastIndexOf("/")+1).split("?")[0].split("#")[0]),c.onFallback&&"function"!=typeof c.onFallback&&(d.warn("options.onFallback is not a function - ignoring"),
c.onFallback=null),c.onDownloadComplete&&"function"!=typeof c.onDownloadComplete&&(d.warn("options.onDownloadComplete is not a function - ignoring"),c.onDownloadComplete=null),c.md5){if("[object String]"!=Object.prototype.toString.call(c.md5))return d.error("options.sha1 contains invalid characters"),!1}else c.md5=null;if(c.sha1){if("[object String]"!=Object.prototype.toString.call(c.sha1))return d.error("options.sha1 contains invalid characters"),!1}else c.sha1=null;(g=b[a])?(d.warn(a+" was already existed in the filewrappers"),
g.download()):(g=new d.client.downloader.FileWrapper(a,c),g.download(),b[a]=g)};d.stopDownload=function(a){b[a].stop()};d.exitDownload=function(a){b[a].exit();delete b[a]};var c,b={},a=window.onbeforeunload;window.onbeforeunload=function(){var c=!1;d.core.util.envokeCallbackSync(a,[]);for(var f in b)radio("fwBeforeUnload").broadcast(b[f].url,b[f].size),radio("exitPage").broadcast(b[f].started,b[f].fallback),!b[f].started||b[f].completed||b[f].fallback||(c=!0);return c?"Download in progress. Closing this tab will stop the download.":
void 0};d.client.downloader.FileWrapper=Object.subClass({name:"peer5.client.downloader.FileWrapper",ctor:function(a,b){this.fallback=this.started=this.completed=!1;this.ui=null;this.url=a;this.size=this.swarmId=null;b.name?this.filename=b.name:this.filename="";this.options=b||{};this.ui_events_cache={peer5_received_http_block:function(a,b,c){if(b==this.url)for(a*=d.config.BLOCK_SIZE/d.config.CHUNK_SIZE,c=a+c/d.config.CHUNK_SIZE-1;c>=a;a++)this.ui.paintHttp(a,1)},peer5_pending_http_chunk:function(a,
b){b!=this.url},peer5_waste_http_chunk:function(a,b,c){a!=this.url},peer5_state_updated:function(a,b){b==this.url&&this.ui.update(a)},transferFinishedEvent:function(a){this.url!==a.url&&this.swarmId!==a.swarmId||this.ui.displayVerifying()},peer5_persistent_fd_auth:function(){this.ui.displayFilesystemAuth(!0)},peer5_persistent_fd_auth_finish:function(){this.ui.displayFilesystemAuth(!1)},peer5_received_fs_chunk:function(a,b,c){a==this.swarmId&&this.ui.paintFs(c,1)},peer5_new_p2p_chunk:function(a,b,
c){this.swarmId&&a==this.swarmId&&this.ui.paintP2p(c,1)},peer5_p2p_pending_chunk:function(a,b,c){this.swarmId&&b==this.swarmId&&this.ui.paintP2p(a,1,c)},peer5_waste_p2p_chunk:function(a,b,c){this.swarmId&&a==this.swarmId&&this.ui.paintWasteP2p(c,1)}};this.startTime},download:function(){var a=this;this.isEnabled(function(){a._download()},function(b){d.warn("Downloader isEnabled returned false");a.regularDownload()})},_download:function(){var a=this,b={};this.options.sha1?b.sha1=this.options.sha1:this.options.md5&&
(b.md5=this.options.md5);(d.config.HTTP_ONLY||d.config.IS_CHROME&&d.config.HTTP_ONLY_CHROME||d.config.IS_FIREFOX&&d.config.HTTP_ONLY_FIREFOX)&&(b.downloadMode="http");b=new d.Request(b);b.responseType="blobUrl";b.onreadystatechange=function(b){if(!a.options||!a.options.disableUI){if(!a.swarmId&&2<=this.readyState){b=this.getFileInfo();a.size=b.size;a.ui&&a.ui.setNumOfChunks(b.size);a.swarmId=b.swarmId;try{var c;var f=this.getResponseHeader("content-disposition");if(-1==f.indexOf("attachment; filename="))c=
null;else{var l=f.replace("attachment; filename=","");c=l.substring(1,l.length-1)}var p=decodeURIComponent(c);c&&p&&(a.filename=p)}catch(n){d.info("content-disposition is not found")}}3==this.readyState&&(radio("startedDownloading").broadcast(this.fileInfo.size),a.ui&&a.ui.displayDownloadStart(),a.started=!0)}};b.open("GET",this.url);(function(){a.ui||(a.ui=c.addPane({url:a.url,filename:a.filename,pause:function(){radio("pauseClicked").broadcast();d.stopDownload(a.url)},resume:function(){radio("playClicked").broadcast();
d.download(a.url)},close:function(){d.exitDownload(a.url)}}),d.config.AD_FRAME&&1E3<document.body.clientWidth&&(a.adsManager=new d.client.downloader.AdManager(document.getElementsByClassName("p5-dl-container")[0]),a.adsManager.display(d.config.AD_FRAME_DELAY,d.config.AD_FRAME_REFRESH)),a.registerEvents())})();this.q4=this.q3=this.q2=this.q1=this.p10=this.p5=this.p1=this.b1=!1;b.onprogress=function(b){a.updateProgressEvents(b)};b.onload=function(b){a.completed=!0;a.ui&&(a.ui.displayCompleted(b.total),
a.deregisterEvents());radio("downloadFinished").broadcast(a.url,b.total,b.loadedP2P,b.loadedHTTP,b.loadedFS);setTimeout(function(){radio("seeding").broadcast(5E3);setTimeout(function(){radio("seeding").broadcast(3E4);setTimeout(function(){radio("seeding").broadcast(3E5)},27E4)},25E3)},5E3);!window.URL&&window.webkitURL&&(window.URL=window.webkitURL);b=document.createElement("a");if(b.setAttribute("download",a.filename),b.setAttribute("href",this.response),document.body.appendChild(b),b.click(),d.config.IS_FIREFOX&&
d.core.data.BlockCache.get(a.url).fs)b=new XMLHttpRequest,b.open("GET","//peer5.com/downloader/peer5_logo_white.png",!1),b.onload=function(a){},b.send(null);a.options.onDownloadComplete&&a.options.onDownloadComplete()};b.onerror=function(b){d.error("filewrapper::request:onerror");a.ui&&a.parseError(b);a.options.onFallback?a.options.onFallback():(d.warn("FileWrapper Fallbacking to normal download"),a.regularDownload());a.fallback=!0;radio("fallback").broadcast(this.status,b.total)};b.onswarmstatechange=
function(b){b.numOfPeers&&a.ui.setPeers(b.numOfPeers)};this.startTime=Date.now();b.send();this.request=b},updateProgressEvents:function(a){var b=a.loaded/a.total;!this.b1&&0<b&&(this.b1=!0,radio("peer5_b1_finished").broadcast(1E3*a.loaded/(Date.now()-this.startTime)));!this.p1&&.01<=b&&(this.p1=!0,radio("peer5_p1_finished").broadcast(1E3*a.loaded/(Date.now()-this.startTime)));!this.p5&&.05<=b&&(this.p5=!0,radio("peer5_p5_finished").broadcast(1E3*a.loaded/(Date.now()-this.startTime)));!this.p10&&.1<=
b&&(this.p10=!0,radio("peer5_p10_finished").broadcast(1E3*a.loaded/(Date.now()-this.startTime)));!this.q1&&.25<=b&&(this.q1=!0,radio("peer5_q1_finished").broadcast(1E3*a.loaded/(Date.now()-this.startTime)));!this.q2&&.5<=b&&(this.q2=!0,radio("peer5_q2_finished").broadcast(1E3*a.loaded/(Date.now()-this.startTime)));!this.q3&&.75<=b&&(this.q3=!0,radio("peer5_q3_finished").broadcast(1E3*a.loaded/(Date.now()-this.startTime)));!this.q4&&1<=b&&(this.q4=!0,radio("peer5_q4_finished").broadcast(1E3*a.loaded/
(Date.now()-this.startTime)))},stop:function(){d.warn("download stopped "+this.url);this.request.abort()},isEnabled:function(a,b){d.getCompatibilityStatus(function(c,h,k){if(0<c.length&&702!=c[0])return void b();switch(h){case "chrome":if(d.config.DISABLE_CHROME)return void b();break;case "opera":if(d.config.DISABLE_OPERA)return void b();break;case "firefox":if(d.config.DISABLE_FIREFOX)return void b()}a()})},parseError:function(a){var b="";switch(a.currentTarget.status){case d.Request.INVALID_RESPONSETYPE:b=
window.peer5.messages.error_generic;break;case d.Request.SWARMID_NOT_FOUND_ERR:b=window.peer5.messages.error_generic;break;case d.Request.FILE_SIZE_ERR:b=window.peer5.messages.error_filesize;break;case d.Request.FIREFOX_ONLY_SWARM_ERR:b=window.peer5.messages.error_generic;break;case d.Request.CHROME_ONLY_SWARM_ERR:b=window.peer5.messages.error_generic;break;case d.Request.BROWSER_SWARM_COMPAT_ERR:b=window.peer5.messages.error_generic;break;case d.Request.OUT_OF_SPACE_ERR:b=window.peer5.messages.error_diskspace;
break;case d.Request.WRITE_ERR:b=window.peer5.messages.error_write;break;case d.Request.VERIFICATION_ERR:b=window.peer5.messages.error_corrupt;break;default:b=600>a.currentTarget.status?window.peer5.messages.error_connection:window.peer5.messages.error_generic}this.ui.showError(b)},exit:function(){d.warn("download exited "+this.url);this.request.abort({leaveSwarm:!0});this.dtor();radio("exitDownload").broadcast(this.completed)},regularDownload:function(){!window.URL&&window.webkitURL&&(window.URL=
window.webkitURL);var a=document.createElement("a");(a.setAttribute("download",this.options.name),a.setAttribute("href",this.url),document.body.appendChild(a),a.click)?a.click():(a=document.getElementById("hiddenDownloader"),null===a&&(a=document.createElement("iframe"),a.id="hiddenDownloader",a.style.display="none",document.body.appendChild(a)),a.src=this.url)},deregisterEvents:function(){var a=this.ui_events_cache;Object.keys(a).forEach(function(b){radio(b).unsubscribe([a[b],this])},this)},registerEvents:function(){var a=
this.ui_events_cache;Object.keys(a).forEach(function(b){radio(b).subscribe([a[b],this])},this)},dtor:function(){this.deregisterEvents();this.request=this.options=this.url=this.ui=null}});d.contentLoaded(window,function(){function a(){h+=Math.round(2*Math.random()-1);document.querySelector(".peer5_users_counter").innerHTML=h}var b=document.head,g=document.createElement("style");if(g.innerHTML="@import url(//fonts.googleapis.com/css?family=Exo+2:200);.p5-dl-file,.p5-dl-stats-datum{white-space:nowrap;overflow:hidden}.p5-dl-container,.p5-dl-feedback-comment{font-family:'Exo 2',sans-serif!important}body.p5-dl-fixed{padding-bottom:144px!important}.p5-dl-container{position:fixed;bottom:0;left:0;right:0;z-index:2147483647;height:144px;padding:0;margin:0;background-color:#000;font-size:16px!important;text-transform:uppercase}.p5-dl-container *{margin:0;padding:0;color:#EEE;font-weight:400}.p5-dl-button,.p5-dl-feedback-form p{font-weight:700}.p5-dl-main-wrapper{position:absolute;top:0;bottom:0;left:0;right:234px;z-index:-1;overflow:hidden;-webkit-transition:right .3s ease-in-out 0s;transition:right .3s ease-in-out 0s}.p5-dl-feedback-opened .p5-dl-main-wrapper{right:500px}.p5-dl-main-wrapper.p5-dl-fixed-panes{overflow-x:auto;overflow-y:hidden}.p5-dl-scroller{display:none;position:absolute;bottom:0;left:0;right:233px;height:10px;background-color:#58585B}.p5-dl-grip{display:block;position:absolute;bottom:2px;left:4px;width:20%;height:6px;border-radius:3px;background-color:#AAA}.p5-dl-main{list-style:none;position:absolute;top:0;bottom:0;left:0;z-index:-1;width:100%;white-space:nowrap}.p5-dl-fixed-panes .p5-dl-main{width:auto;min-width:100%}.p5-dl-pane{display:inline-block;position:relative;z-index:-1;height:100%;width:100%;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;background-color:#58585B}.p5-dl-button,.p5-dl-extra-speed{-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.p5-dl-pane+.p5-dl-pane{margin-left:6px}.p5-dl-fixed-panes .p5-dl-pane{width:400px}.p5-dl-pane canvas.boxes{position:absolute;left:0;right:0;top:0}.p5-dl-pane canvas.arcs{position:absolute;top:25px;left:10px}.p5-dl-fixed-panes .p5-dl-pane canvas.arcs{top:10px}.p5-dl-progress{display:inline-block;position:absolute;left:20px;top:35px;overflow:hidden;width:83px;height:83px;border:none;border-radius:83px;-webkit-box-shadow:inset 0 0 0 4px #FFF;-moz-box-shadow:inset 0 0 0 4px #FFF;box-shadow:inset 0 0 0 4px #FFF}.p5-dl-button,.p5-dl-progress-label{display:block;position:absolute;text-align:center}.p5-dl-fixed-panes .p5-dl-progress{top:20px}.p5-dl-progress-fill{position:absolute;bottom:4px;left:0;right:0;z-index:-1;background-color:#FF6523}.p5-dl-progress-label{z-index:1;width:100%;height:50%;padding-top:15px;font-size:19px;color:#DFE0E1}.p5-dl-button{z-index:2;width:100%;height:100%;padding-top:45px;font-size:24px;color:#FFF;box-sizing:border-box;cursor:pointer}.p5-dl-ad-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000;filter:alpha(opacity=50);-moz-opacity:.5;-khtml-opacity:.5;opacity:.5;z-index:0}.p5-dl-ad-display{position:fixed;bottom:141px;z-index:10001;left:50%;transform:translate(-50%)}.p5-dl-ad-display-smpl1,.p5-dl-ad-display-smpl2{height:90px;width:728px;position:fixed;bottom:144px;z-index:10001;left:50.7%;transform:translate(-50%);background-size:100% auto}.p5-dl-ad-display-smpl1{background-image:url(https://api.peer5.com/downloader/icons/ads/VLCbanner.png)}.p5-dl-ad-display-smpl2{background-image:url(https://api.peer5.com/downloader/icons/ads/Megaglest1.png)}.p5-dl-ad-display-close{right:2px;top:2px;width:20px;height:20px;padding:0;background:url(https://api.peer5.com/downloader/icons/x_button.svg) left top no-repeat;background-size:cover}.p5-dl-close-pane{right:12px;top:12px;width:20px;height:20px;padding:0;background:url(https://api.peer5.com/downloader/icons/x_button.svg) left top no-repeat;background-size:cover}.p5-dl-pause{background:url(https://api.peer5.com/downloader/icons/pause-white.svg) center 70% no-repeat;background-size:40% auto}.p5-dl-play{display:none;background:url(https://api.peer5.com/downloader/icons/play-white.svg) center 70% no-repeat;background-size:40% auto}.p5-dl-done{background:url(https://api.peer5.com/downloader/icons/v-white.svg) center 70% no-repeat;background-size:40% auto;cursor:default}.p5-dl-meta{display:inline-block;position:absolute;top:20px;bottom:20px;right:13px;left:123px}.p5-dl-fixed-panes .p5-dl-meta{top:10px;bottom:10px}.p5-dl-extra-speed{display:none;position:absolute;bottom:-8px;left:5%;min-width:90%;padding:2px 4px;font-size:10px;text-align:center;background-color:#FF6523;color:#111;box-sizing:border-box}.p5-dl-has-peers .p5-dl-extra-speed{display:block}.p5-dl-pane.p5-dl-only-child .p5-dl-extra-speed{font-size:13px;bottom:-46px}.p5-dl-file{position:absolute;top:0;left:2px;right:0;height:40px;line-height:40px;font-size:20px;text-overflow:ellipsis;text-align:center}.p5-dl-filename{color:#FFF}.p5-dl-pane.p5-dl-only-child .p5-dl-file{right:51%;height:104px;line-height:111px;font-size:23px}.p5-dl-pane.p5-dl-only-child .p5-dl-file:after,.p5-dl-pane.p5-dl-only-child .p5-dl-file:before{content:\"\";position:absolute;top:15px;bottom:15px;right:0;border-right:1px solid #979797}.p5-dl-pane.p5-dl-only-child .p5-dl-file:before{right:auto;left:0}.p5-dl-em{color:#FF6523}.p5-dl-stats{position:absolute;top:40px;bottom:0;left:0;right:0}.p5-dl-pane.p5-dl-only-child .p5-dl-stats{top:0;left:50%;height:104px}.p5-dl-stats-datum{display:inline-block;width:25%;height:60px;padding:34px 4px 0;font-size:11px;text-overflow:ellipsis;text-align:center;vertical-align:top;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;background-repeat:no-repeat;background-size:30px auto;background-position:center 6px}.p5-dl-pane.p5-dl-only-child .p5-dl-stats-peers,.p5-dl-pane.p5-dl-only-child .p5-dl-stats-size,.p5-dl-pane.p5-dl-only-child .p5-dl-stats-speed,.p5-dl-pane.p5-dl-only-child .p5-dl-stats-time{background-position:center 26px}.p5-dl-pane.p5-dl-only-child .p5-dl-stats-datum{height:104px;padding:60px 6px 20px;line-height:100%;font-size:16px;background-size:40px auto}.p5-dl-stats-time{background-image:url(https://api.peer5.com/downloader/icons/timer.svg)}.p5-dl-stats-speed{width:50%;background-image:url(https://api.peer5.com/downloader/icons/speedometer.svg)}.p5-dl-stats-size{background-image:url(https://api.peer5.com/downloader/icons/doc.svg)}.p5-dl-stats-size.p5-dl-zip{background-image:url(https://api.peer5.com/downloader/icons/zip.svg)}.p5-dl-stats-size.p5-dl-media{background-image:url(https://api.peer5.com/downloader/icons/media.svg)}.p5-dl-stats-size.p5-dl-pic{background-image:url(https://api.peer5.com/downloader/icons/pic.svg)}.p5-dl-peers-speed{display:inline-block;position:relative;width:50%;height:60px}.p5-dl-feedback,.p5-dl-stats-message{position:absolute;text-align:center;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.p5-dl-stats-peers{width:50%;background-image:url(https://api.peer5.com/downloader/icons/peer-deactivated.svg)}.p5-dl-has-peers .p5-dl-stats-peers{background-image:url(https://api.peer5.com/downloader/icons/peer-activated.svg)}.p5-dl-has-peers .p5-dl-stats-speed{background-image:url(https://api.peer5.com/downloader/icons/speedometer-extra.svg)}.p5-dl-stats-message{width:90%;margin:0 auto;bottom:-8px;right:6px;left:6px;line-height:150%;font-size:13px;background-color:#999;color:#FFF;box-sizing:border-box}.p5-dl-pane.p5-dl-only-child .p5-dl-stats-message{bottom:0}.p5-dl-completed .p5-dl-stats-message{background-color:#FF6523;color:#111}.p5-dl-feedback{top:0;bottom:0;right:0;width:234px;padding:20px 0;border:6px solid #000;background-color:#000;box-sizing:border-box;-webkit-box-shadow:-5px 0 4px 0 rgba(0,0,0,.5);-moz-box-shadow:-5px 0 4px 0 rgba(0,0,0,.5);box-shadow:-5px 0 4px 0 rgba(0,0,0,.5);-webkit-transition:width .3s ease-in-out 0s;transition:width .3s ease-in-out 0s}.p5-dl-feedback-opened .p5-dl-feedback{width:500px}.p5-dl-brand{display:inline-block;width:116px;height:30px;line-height:30px;text-align:left;background:url(https://api.peer5.com/downloader/icons/logo.svg) left top no-repeat}.p5-dl-need-help{font-size:23px}.p5-dl-brand:before{content:\"BY\";font-size:23px}.p5-dl-feedback-form{height:30px;text-align:center}.p5-dl-feedback-left{position:relative;top:0;left:0;width:234px}.p5-dl-feedback-right{position:absolute;top:20px;right:0;left:234px;padding:0 20px}.p5-dl-feedback-open{display:inline-block;width:26px;height:26px;background:url(https://api.peer5.com/downloader/icons/speech_bubble.svg) center center no-repeat;cursor:pointer}.p5-dl-feedback-form ul{display:inline-block;vertical-align:top;list-style:none}.p5-dl-feedback-form li{display:inline-block;width:26px;text-align:center}.p5-dl-feedback-form li label{display:block;position:relative;width:26px;height:26px;cursor:pointer}.p5-dl-feedback-form li label:after{position:absolute;content:'';display:block;top:0;width:30px;height:25px;background:url(https://api.peer5.com/downloader/icons/empty_feedback_star.svg) center center no-repeat}.p5-dl-feedback-form ul.p5-dl-checked label:after{background:url(https://api.peer5.com/downloader/icons/orange_feedback_star.svg) center center no-repeat}.p5-dl-feedback-form li.p5-dl-checked~li label:after{background:url(https://api.peer5.com/downloader/icons/empty_feedback_star.svg) center center no-repeat}.p5-dl-feedback-form ul.p5-dl-checked:hover label:after,.p5-dl-feedback-form ul:hover label:after{background:url(https://api.peer5.com/downloader/icons/orange_feedback_star.svg) center center no-repeat}.p5-dl-feedback-form .p5-dl-checked li:hover~li label:after,.p5-dl-feedback-form li:hover~li label:after{background:url(https://api.peer5.com/downloader/icons/empty_feedback_star.svg) center center no-repeat}.p5-dl-completed canvas,.p5-dl-feedback-submit{background-color:#FF6523}.p5-dl-feedback-form li input{visibility:hidden}.p5-dl-feedback-comment{display:block;padding:6px;width:100%;height:56px;margin-bottom:8px;border:none;resize:none;border-radius:6px;color:#000;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;font-weight:600}.p5-dl-feedback-submit{display:block;padding:2px 0;border-radius:6px;color:#fff;cursor:pointer}@media only screen and (min-device-width :320px) and (max-device-width :640px) and (max-device-height :768px){.p5-dl-completed canvas,.p5-dl-pane{background-color:transparent}::-webkit-input-placeholder{color:#474747}:-moz-placeholder{color:#474747;opacity:1}::-moz-placeholder{color:#474747;opacity:1}:-ms-input-placeholder{color:#474747}.p5-dl-container{height:auto;top:0}.p5-dl-feedback-open{display:none}.p5-dl-main-wrapper{right:0;bottom:200px;border:none}.p5-dl-feedback-opened .p5-dl-main-wrapper{right:0}.p5-dl-main{bottom:0}.p5-dl-pane canvas.arcs{position:absolute;top:50%;left:50%;margin:-65px 0 0 -85px}.p5-dl-progress{top:50%;left:50%;width:150px;height:150px;margin:-55px 0 0 -75px;border-radius:100px;-webkit-box-shadow:inset 0 0 0 6px #FFF;-moz-box-shadow:inset 0 0 0 6px #FFF;box-shadow:inset 0 0 0 6px #FFF}.p5-dl-progress-label{padding-top:30px}.p5-dl-progress-fill{background-color:#FF6523}.p5-dl-pause{padding-top:110px}.p5-dl-file{margin-top:10px;font-size:26px}.p5-dl-stats{top:50px}.p5-dl-pane.p5-dl-only-child .p5-dl-file:after{border:none}.p5-dl-em,.p5-dl-stats-size-total{color:#FF6523}.p5-dl-meta{top:0;bottom:0;left:0;right:0}.p5-dl-pane.p5-dl-only-child .p5-dl-stats{top:auto;left:0;height:80px;line-height:80px}.p5-dl-stats-datum{width:50%;padding:42px 4px 0;background-size:40px auto;font-size:16px}.p5-dl-peers-speed{position:absolute;bottom:12px;width:100%;padding-bottom:20px}.p5-dl-extra-speed{width:100%;left:0;bottom:-12px;font-size:18px}.p5-dl-stats-size,.p5-dl-stats-time{display:inline-block;width:50%;height:auto;padding:0;font-size:19px}.p5-dl-stats-size{text-align:center;background:0 0!important}.p5-dl-stats-time{background:0 0}.p5-dl-stats-message{left:0;right:0;bottom:0;width:100%}.p5-dl-feedback{top:auto;width:100%;height:200px;padding:10px 0;border:none;background-color:#666}.p5-dl-feedback-opened .p5-dl-feedback{width:100%}.p5-dl-feedback-right{position:static;margin-top:9px}.p5-dl-feedback-left{position:static;width:auto}.p5-dl-need-help{display:none}.p5-dl-feedback-form{top:0;left:50px;right:50px;height:auto;text-align:center}.p5-dl-feedback-form li:hover label:before{position:initial;content:initial;display:initial;top:initial;width:initial;height:initial;background:initial}.p5-dl-feedback-comment{display:block;width:100%;height:64px;padding:8px;background-color:#999;border:3px solid #777;border-radius:8px;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;font-family:'Exo 2',sans-serif!important}.p5-dl-feedback-submit{display:block;margin-top:12px;padding:3px 0;border-radius:8px;background-color:#FF6523;color:#fff;cursor:pointer;-webkit-box-shadow:0 1px 0 0 #000;-moz-box-shadow:0 1px 0 0 #000;box-shadow:0 1px 0 0 #000}.p5-dl-brand{position:absolute;bottom:10px;left:50%;margin-left:-58px;background:url(https://api.peer5.com/downloader/icons/logo.svg) left top no-repeat}}@media only screen and (min-device-width :320px) and (max-device-width :640px) and (max-device-height :768px) and (min-width :321px) and (orientation :landscape){.p5-dl-main-wrapper{bottom:12px}.p5-dl-stats-size,.p5-dl-stats-time{display:inline-block;width:50%}.p5-dl-brand,.p5-dl-feedback-opened .p5-dl-file{display:none}.p5-dl-feedback-opened .p5-dl-main-wrapper{right:0;bottom:200px}.p5-dl-feedback-opened .p5-dl-progress,.p5-dl-feedback-opened canvas.arcs{top:90%}.p5-dl-feedback-opened .p5-dl-stats{top:12px}.p5-dl-feedback-opened .p5-dl-peers-speed{padding-bottom:0}.p5-dl-feedback-opened .p5-dl-peers-speed .p5-dl-stats-datum{background-image:none}.p5-dl-feedback-opened .p5-dl-brand{display:block}.p5-dl-feedback{height:39px}.p5-dl-feedback-opened .p5-dl-feedback{height:200px;width:100%}.p5-dl-feedback-open{display:inline-block}}.p5-dl-hide{display:none!important}",
b.appendChild(g),c=new d.client.downloader.PaneManager(document.body),document.body.addEventListener("click",function(a){for(var b=a.target;b&&"a"!==b.nodeName.toLowerCase();)b=b.parentElement;b&&null!==b.getAttribute("peer5-download")&&(a.preventDefault(),a=b.getAttribute("href"),d.download(a))}),document.querySelector(".peer5_users_counter")){var h=Math.floor(Date.now()/3E4%9E5);window.setInterval(a,500);a()}})})();var w={};w.setLogLevel=d.setLogLevel;w.download=d.download;w.prefetch=d.prefetch;
w.initJWPlayer=d.initJWPlayer;w.stopDownload=d.stopDownload;w.exitDownload=d.exitDownload;w.Request=d.Request;w.getMedia=d.getMedia;w.getCompatibilityStatus=d.getCompatibilityStatus;w.isEnabled=d.isEnabled;w.getStats=d.getStats;w.trigger=d.trigger;w.DATACHANNELS_ERROR=d.DATACHANNELS_ERROR;w.WEBSOCKETS_ERROR=d.WEBSOCKETS_ERROR;w.FILESYSTEM_ERROR=d.FILESYSTEM_ERROR;w.getConfig=d.getConfig;w.browserName=d.browserName;w.messages=d.messages;window.peer5=w;"object"==typeof module&&"object"==typeof module.exports&&
(module.exports=w)}();
